"use strict";(self.webpackChunkarcgis_node=self.webpackChunkarcgis_node||[]).push([[6006],{60832:(e,t,i)=>{i.d(t,{A:()=>g});var n=i(82392),r=i(60828),s=i(73783),o=i(14755),a=i(84977),l=i(57725),u=i(81482),d=(i(6273),i(80861),i(67498),i(26325)),c=i(18031),h=i(1912),p=i(44223);let v=class extends((0,a.Te)((0,o.O)(s.A))){constructor(e){super(e),this.position=null,this.elevationInfo=null,this.feature=null}equals(e){return(0,l.CM)(this.position,e.position)&&(0,l.CM)(this.elevationInfo,e.elevationInfo)&&(0,r.xH)(this.feature,e.feature)}};(0,n._)([(0,u.MZ)({type:h.A,json:{write:{isRequired:!0}}})],v.prototype,"position",void 0),(0,n._)([(0,u.MZ)({type:p.A}),(0,c.P)()],v.prototype,"elevationInfo",void 0),(0,n._)([(0,u.MZ)(r.N1)],v.prototype,"feature",void 0),v=(0,n._)([(0,d.$)("esri.analysis.LineOfSightAnalysisObserver")],v);const g=v},17091:(e,t,i)=>{i.d(t,{A:()=>v});var n=i(82392),r=i(60828),s=i(14755),o=i(84977),a=i(57725),l=i(81482),u=(i(6273),i(80861),i(67498),i(26325)),d=i(18031),c=i(1912),h=i(44223);let p=class extends((0,o.Te)(s.P)){constructor(e){super(e),this.position=null,this.elevationInfo=null,this.feature=null}equals(e){return(0,a.CM)(this.position,e.position)&&(0,a.CM)(this.elevationInfo,e.elevationInfo)&&(0,r.xH)(this.feature,e.feature)}};(0,n._)([(0,l.MZ)({type:c.A}),(0,d.P)()],p.prototype,"position",void 0),(0,n._)([(0,l.MZ)({type:h.A}),(0,d.P)()],p.prototype,"elevationInfo",void 0),(0,n._)([(0,l.MZ)(r.N1)],p.prototype,"feature",void 0),p=(0,n._)([(0,u.$)("esri.analysis.LineOfSightAnalysisTarget")],p);const v=p},60828:(e,t,i)=>{function n(e,t){return r(e)===r(t)}function r(e){if(null==e)return null;const t=null!=e.layer?e.layer.id:"";let i=null;return i=null!=e.objectId?e.objectId:null!=e.layer&&"objectIdField"in e.layer&&null!=e.layer.objectIdField&&null!=e.attributes?e.attributes[e.layer.objectIdField]:e.uid,null==i?null:`o-${t}-${i}`}i.d(t,{N1:()=>s,wY:()=>r,xH:()=>n});const s={json:{write:{writer:function(e,t){null!=e?.layer?.objectIdField&&null!=e.attributes&&(t.feature={layerId:e.layer.id,objectId:e.attributes[e.layer.objectIdField]})},target:{"feature.layerId":{type:[Number,String]},"feature.objectId":{type:[Number,String]}}},origins:{"web-scene":{read:function(e){if(null!=e.layerId&&null!=e.objectId)return{uid:null,layer:{id:e.layerId,objectIdField:"ObjectId"},attributes:{ObjectId:e.objectId}}}}}}}},14793:(e,t,i)=>{i.d(t,{P:()=>l});var n=i(82392),r=i(70214),s=i(71004),o=i(81482),a=(i(6273),i(80861),i(67498),i(26325));const l=e=>{let t=class extends((0,s.g)(e)){constructor(){super(...arguments),this.parent=null,this._userInteractive=!1,this._interactiveViewModelCount=0}get interactive(){return this._interactiveViewModelCount>0||this._userInteractive}set interactive(e){this._userInteractive=e}get updating(){return!1}get visible(){return null==this.parent||this.parent.visible&&!this.parent.suspended}set visible(e){this._overrideIfSome("visible",e)}forceInteractiveForViewModel(){return this._interactiveViewModelCount++,(0,r.hA)((()=>this._interactiveViewModelCount--))}};return(0,n._)([(0,o.MZ)({constructOnly:!0})],t.prototype,"parent",void 0),(0,n._)([(0,o.MZ)({constructOnly:!0})],t.prototype,"view",void 0),(0,n._)([(0,o.MZ)({type:Boolean})],t.prototype,"interactive",null),(0,n._)([(0,o.MZ)()],t.prototype,"_userInteractive",void 0),(0,n._)([(0,o.MZ)({readOnly:!0})],t.prototype,"updating",null),(0,n._)([(0,o.MZ)()],t.prototype,"visible",null),(0,n._)([(0,o.MZ)()],t.prototype,"_interactiveViewModelCount",void 0),t=(0,n._)([(0,a.$)("esri.views.3d.analysis.AnalysisView3D")],t),t}},16006:(e,t,i)=>{i.r(t),i.d(t,{default:()=>Be});var n=i(82392),r=i(73783),s=i(40377),o=i(57888),a=(i(6273),i(57725)),l=i(81482),u=i(80861),d=(i(67498),i(26325)),c=i(19913),h=i(14793),p=(i(3313),i(60828)),v=i(3132),g=i(56802),_=i(70214),m=i(37623),y=i(61985),f=i(80347),b=i(68660),C=i(34561),w=i(41185),O=i(2532),I=i(63918),M=i(19541);let T=class extends r.A{constructor(e){super(e),this.target=null,this.intersectedGraphic=null,this.intersectedLocation=null,this.elevationAlignedTargetLocation=null,this.visible=void 0}};(0,n._)([(0,l.MZ)()],T.prototype,"target",void 0),(0,n._)([(0,l.MZ)()],T.prototype,"intersectedGraphic",void 0),(0,n._)([(0,l.MZ)()],T.prototype,"intersectedLocation",void 0),(0,n._)([(0,l.MZ)()],T.prototype,"elevationAlignedTargetLocation",void 0),(0,n._)([(0,l.MZ)({type:Boolean})],T.prototype,"visible",void 0),T=(0,n._)([(0,d.$)("esri.views.3d.analysis.LineOfSightAnalysisResult")],T);let P=class extends r.A{constructor(e){super(e),this.elevationAlignedTargetLocation=null,this.inputPoints={isValid:!1,observer:(0,c.vt)(),observerSurfaceNormal:null,observerFeatureId:null,target:(0,c.vt)(),targetSurfaceNormal:null,targetFeatureId:null,observerAdjusted:(0,c.vt)(),targetAdjusted:(0,c.vt)()},this.computationResult={start:(0,c.vt)(),end:(0,c.vt)(),intersection:(0,c.vt)(),isValid:!1,isTargetVisible:!1},this.result=null}notifyResultChanged(){this.notifyChange("computationResult")}notifyInputPointsChanged(){this.notifyChange("inputPoints")}};(0,n._)([(0,l.MZ)()],P.prototype,"target",void 0),(0,n._)([(0,l.MZ)()],P.prototype,"elevationAlignedTargetLocation",void 0),(0,n._)([(0,l.MZ)()],P.prototype,"inputPoints",void 0),(0,n._)([(0,l.MZ)()],P.prototype,"computationResult",void 0),(0,n._)([(0,l.MZ)()],P.prototype,"result",void 0),P=(0,n._)([(0,d.$)("esri.views.3d.analysis.LineOfSight.LineOfSightComputation")],P);var A,S=i(23572),R=i(11631),V=i(891),L=i(3223),E=i(15565);let H=A=class extends r.A{constructor(e){super(e)}clone(){return new A({type:this.type,id:(0,E.o8)(this.id),mapPoint:(0,E.o8)(this.mapPoint),renderPoint:(0,c.o8)(this.renderPoint),normal:(0,E.o8)(this.normal),ray:(0,E.o8)(this.ray),graphic:this.graphic})}equals(e){return this.type===e.type&&this.id===e.id&&(0,a.CM)(this.mapPoint,e.mapPoint)&&(0,f.G)(this.renderPoint,e.renderPoint)&&(0,L.aI)(this.normal,e.normal)&&(0,I.aI)(this.ray,e.ray)&&this.graphic===e.graphic}};(0,n._)([(0,l.MZ)()],H.prototype,"type",void 0),(0,n._)([(0,l.MZ)({constructOnly:!0})],H.prototype,"id",void 0),(0,n._)([(0,l.MZ)({constructOnly:!0})],H.prototype,"mapPoint",void 0),(0,n._)([(0,l.MZ)({constructOnly:!0})],H.prototype,"renderPoint",void 0),(0,n._)([(0,l.MZ)({constructOnly:!0})],H.prototype,"normal",void 0),(0,n._)([(0,l.MZ)({constructOnly:!0})],H.prototype,"graphic",void 0),(0,n._)([(0,l.MZ)({constructOnly:!0})],H.prototype,"ray",void 0),H=A=(0,n._)([(0,d.$)("esri.views.3d.analysis.LineOfSight.LineOfSightIntersectionResult")],H);var x=i(36195),Z=i(86300),D=i(38952),z=i(57809),F=i(30165),k=i(12343),G=i(1912);let j=class extends r.A{constructor(e){super(e),this._terrainIntersectionOptionsLayerUids=new Set(["terrain"])}initialize(){this.intersector=(0,z.hz)(this.view.state.viewingMode),this.intersector.options.hud=!1,this.intersector.options.store=F.oH.MIN}getScreenPointIntersection(e){const t=(0,S.WA)(e,R.oG.get()),i=(0,Z.Z4)(this.view.state.camera,t,$);return this._getRayIntersection(i)}_getRayIntersection(e,t){if(null==e||null==this.view.sceneIntersectionHelper)return null;const{intersector:i}=this;i.options.store=F.oH.MIN,this.view.sceneIntersectionHelper.intersectToolIntersectorRay(e,i,t);const n=i.results.min,r=(0,c.vt)();if(!n.getIntersectionPoint(r))return null;if(null!=t?.maxDistance&&(0,f.a)(r,e.origin)>t.maxDistance**2)return null;const s=this.view.renderCoordsHelper.fromRenderCoords(r,new G.A({spatialReference:this.view.spatialReference})),o=(0,c.o8)(n.normal);if((0,x.db)(n))return new H({type:F.dz.OBJECT,id:`${n.target.layerUid}/${n.target.nodeIndex}/${n.target.componentIndex}`,mapPoint:s,renderPoint:r,normal:o,ray:(0,I.C)(e),graphic:null});if((0,x.W3)(n))return new H({type:F.dz.OBJECT,id:`${n.target.layerUid}/${n.target.graphicUid}`,mapPoint:s,renderPoint:r,normal:o,ray:(0,I.C)(e),graphic:null});if((0,D.DC)(n))return new H({type:F.dz.TERRAIN,id:n.target.lij.slice(),mapPoint:s,renderPoint:r,normal:o,ray:(0,I.C)(e),graphic:null});const a=(0,k.Gy)(n,this.view);if(null!=a){const t=a.layer,i=a.sourceLayer;let n;return n=i&&"scene"===i.type?(0,V.RW)(a,i.objectIdField):a.uid,new H({type:F.dz.OBJECT,id:`${t?.uid}/${n}`,mapPoint:s,renderPoint:r,normal:o,ray:(0,I.C)(e),graphic:a})}return null}updateFromGroundIntersection(e,t,i){const n=N,r=B,s=U,o=W;(0,f.c)(r,e),this.view.renderCoordsHelper.worldUpAtPosition(r,s),(0,f.n)(s,s);const a=this.view.basemapTerrain.visibleElevationBounds,l=(t>=0?1:-1)*((a?Math.abs(a.max-a.min):100)+Math.abs(t));(0,f.j)(o,s,l),(0,f.g)(n,r,o),(0,I.Cr)(n,r,$);const u=this._getRayIntersection($,{include:this._terrainIntersectionOptionsLayerUids,maxDistance:l});if(null!=u){const e=W;return(0,f.j)(e,s,t),(0,f.g)(i,u.renderPoint,e),(0,c.o8)(u.normal)}return(0,f.c)(i,e),null}};(0,n._)([(0,l.MZ)()],j.prototype,"view",void 0),(0,n._)([(0,l.MZ)()],j.prototype,"intersector",void 0),j=(0,n._)([(0,d.$)("esri.views.3d.analysis.LineOfSight.LineOfSightRayIntersector")],j);const N=(0,c.vt)(),B=(0,c.vt)(),U=(0,c.vt)(),W=(0,c.vt)(),$=(0,I.vt)();var q=i(5751),J=i(49437);let Y=class extends(o.A.EventedMixin(r.A)){constructor(e){super(e),this.updateOnCameraChange=!0,this._observerGroundOffsetRenderSpace=0,this._effectiveObserverElevationMode="absolute-height",this._observerFeatureId=null,this._updatingHandles=new b.U,this._frameTask=J.nu,this._computationHandles=new g.A,this._externalObserverUpdate=!0}initialize(){const e=this.view.resourceController?.scheduler;this._frameTask=e?e.registerTask(J.W6.LINE_OF_SIGHT_TOOL):J.nu,this._intersector=new j({view:this.view}),this.addHandles([this._connectObserver(),this._connectComputations(),this._connectTargets()])}destroy(){this._computationHandles.destroy(),this._computations.removeAll(),this._updatingHandles.destroy()}get updating(){return this._frameTask.updating||this._updatingHandles.updating}get priority(){return this._frameTask.priority}set priority(e){this._frameTask.priority=e}get _computations(){return this.analysisViewData.computations}get _elevationAlignedObserverPositionRenderSpace(){return this.analysisViewData.observerEngineLocation}set _elevationAlignedObserverPositionRenderSpace(e){this.analysisViewData.observerEngineLocation=e}get _screenPixelSize(){return this.view.state.camera.computeScreenPixelSizeAt(this._elevationAlignedObserverPositionRenderSpace)}_computeResult(e){const t=e.computation,{inputPoints:i,computationResult:n}=t,{observerAdjusted:r,targetAdjusted:s}=i,{start:o,end:a}=n;(0,f.c)(o,r),(0,f.c)(a,s),this._canCompute(t)?this._computeIntersection(e):function({computation:e,interpolationInfo:t}){const{computationResult:i,inputPoints:n}=e,{start:r,end:s,intersection:o}=i,{originalIntersection:a,originalObserver:l,originalTarget:u}=t;if((0,f.c)(o,a),n.isValid){const e=ee,t=(0,f.F)(l,a)/(0,f.F)(l,u);(0,f.z)(e,r,l),(0,f.j)(e,e,1-t),(0,f.g)(o,o,e),(0,f.z)(e,s,u),(0,f.j)(e,e,t),(0,f.g)(o,o,e),i.isValid=!0}else e.result=null,i.isValid=!1,i.isTargetVisible=!1}(e),t.notifyResultChanged(),this.emit("result-changed",{target:e.computation.target,result:t.result})}_updateAdjustedPointsFromFeatures(e){const t=this.view,{sceneIntersectionHelper:i}=t,{inputPoints:n}=e,{observerAdjusted:r,observerFeatureId:s,targetFeatureId:o,targetAdjusted:a}=n;if(null==s&&null==o)return;const l=(0,f.p)(r,a),u=this._intersector.intersector,d=(0,I.Cr)(n.observer,n.target,te);u.options.store=F.oH.ALL,i.intersectToolIntersectorRay(d,u);let h=null,v=null,g=null,_=null;for(const e of u.results.all){const i=(0,k.Gy)(e,this.view);if(null==i||null==e.distanceInRenderSpace)continue;const n=(0,p.wY)(i);null!=n&&(null!=s&&n===s&&(null==h&&(h=Q(e,t,l)),e.distanceInRenderSpace<h&&(g=e)),null!=o&&n===o&&(null==v&&(v=Q(e,t,l)),null==_&&e.distanceInRenderSpace<l&&l-e.distanceInRenderSpace<v&&(_=e)))}null!=g&&g.getIntersectionPoint(r)&&(n.observerSurfaceNormal=g.getTransformedNormal((0,c.vt)())),null!=_&&_.getIntersectionPoint(a)&&(n.targetSurfaceNormal=_.getTransformedNormal((0,c.vt)()))}_adjustStartEndPositions(e){const t=this._screenPixelSize,i=this.view,{inputPoints:n}=e,{observer:r,observerSurfaceNormal:s,target:o,targetSurfaceNormal:a,observerAdjusted:l,targetAdjusted:u}=n,d=ee;(0,f.c)(l,r),(0,f.c)(u,o),this._updateAdjustedPointsFromFeatures(e),null!=s?(0,f.c)(d,s):(0,f.f)(d,u,l);const c=t;(0,f.n)(d,d),(0,f.j)(d,d,Math.min(c,1)),(0,f.g)(l,l,d),null!=a?(0,f.c)(d,a):(0,f.f)(d,l,u);const h=i.state.camera.computeScreenPixelSizeAt(u);(0,f.n)(d,d),(0,f.j)(d,d,Math.min(h,1)),(0,f.g)(u,u,d)}_computeIntersection({computation:e,interpolationInfo:t}){const{view:i}=this,{sceneIntersectionHelper:n,renderCoordsHelper:r}=i;if(null==n)return;const s=this._intersector.intersector,{computationResult:o,inputPoints:a}=e,{observer:l,target:u}=a,{start:d,end:c}=o,h=(0,I.Cr)(d,c,te);s.options.store=F.oH.MIN,n.intersectToolIntersectorRay(h,s);const p=s.results.min,v=o.intersection,g=ee;let _=!0;if(null!=p&&p.getIntersectionPoint(v)){(0,f.c)(t.originalIntersection,v),(0,f.c)(t.originalObserver,d),(0,f.c)(t.originalTarget,c),r.fromRenderCoords(v,g,i.spatialReference);const e=1-(0,f.F)(c,u)/(0,f.F)(d,u);_=(0,f.F)(l,v)>=e*(0,f.F)(l,u)}const m=new G.A(g,i.spatialReference);{const{result:t,target:n}=e;null!=t?(t.target=n,t.intersectedGraphic=_?null:(0,k.Gy)(p,i),t.intersectedLocation=_?null:m,t.visible=_):e.result=new T({target:n,elevationAlignedTargetLocation:e.elevationAlignedTargetLocation,intersectedGraphic:_?null:(0,k.Gy)(p,i),intersectedLocation:_?null:m,visible:_})}o.isValid=a.isValid=!0,o.isTargetVisible=_}_canCompute(e){const t=this.analysisViewData.elevationAlignedObserver,i=this.view.frustum;if(null==t||null==e.elevationAlignedTargetLocation||null==i)return!1;const{observerAdjusted:n,targetAdjusted:r}=e.inputPoints,s=i.intersectsPoint(n),o=i.intersectsPoint(r);return s&&o}_onObserverPositionChange(e,t,i,n,r){if(this._externalObserverUpdate=r,null==e)return this.analysisViewData.elevationAlignedObserver=null,void(this._observerFeatureId=null);if(null==t)return(0,q.V)(this.analysis,e.spatialReference,u.A.getLogger(this)),void(this.analysisViewData.elevationAlignedObserver=null);const s=X(t,i),{absoluteZ:o,elevation:a}=(0,M.Q5)(t.x,t.y,t.z,this.view.spatialReference,this.view,s),l=t.clone();l.z=o,this._effectiveObserverElevationMode=s.mode,this.analysisViewData.elevationAlignedObserver=l;const d=(0,c.vt)();this.view.renderCoordsHelper.toRenderCoords(l,d),this._elevationAlignedObserverPositionRenderSpace=d,this._observerGroundOffsetRenderSpace=o-a,this._observerFeatureId=(0,p.wY)(n),this.priority=J.W6.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onObserverRenderSpacePositionChangeForComputation(e,t,i,n,r){const{inputPoints:s}=e;switch((0,f.c)(s.observer,t),s.observerFeatureId=r,s.observerSurfaceNormal=null,n){case"on-the-ground":case"relative-to-ground":{const e=this._intersector.updateFromGroundIntersection(s.observer,i,s.observer);null==s.observerFeatureId&&(s.observerSurfaceNormal=e)}}this._adjustStartEndPositions(e),e.notifyInputPointsChanged(),this.priority=J.W6.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onTargetPositionChange(e,t,i,n,r,s=!0){const o=e.inputPoints;if(s&&(o.isValid=!1),null==i)return null!=t&&(0,q.V)(this.analysis,t.spatialReference,u.A.getLogger(this)),e.elevationAlignedTargetLocation=null,void e.notifyInputPointsChanged();const a=X(i,n),{absoluteZ:l,elevation:d}=(0,M.Q5)(i.x,i.y,i.z,this.view.spatialReference,this.view,a),c=i.clone();switch(c.z=l,e.elevationAlignedTargetLocation=c,this.view.renderCoordsHelper.toRenderCoords(e.elevationAlignedTargetLocation,o.target),o.targetFeatureId=(0,p.wY)(r),o.targetSurfaceNormal=null,a.mode){case"on-the-ground":case"relative-to-ground":{const e=this._intersector.updateFromGroundIntersection(o.target,l-d,o.target);null==o.targetFeatureId&&(o.targetSurfaceNormal=e)}}this._adjustStartEndPositions(e),e.notifyInputPointsChanged(),this.priority=J.W6.LINE_OF_SIGHT_TOOL_INTERACTIVE}_connectComputationToTarget(e){return(0,_.vE)([this._updatingHandles.add((()=>({computation:e,targetPosition:e.target.position,targetElevationInfo:e.target.elevationInfo,targetFeatureInfo:e.target.feature,projectedTargetPosition:(0,C.projectOrLoad)(e.target.position,this.view.spatialReference)})),(({computation:e,targetPosition:t,targetElevationInfo:i,targetFeatureInfo:n,projectedTargetPosition:r})=>{null==r.pending?this._onTargetPositionChange(e,t,r.geometry,i,n):this._updatingHandles.addPromise(r.pending)}),y.Vh)])}_connectComputationToObserver(e){return this._updatingHandles.add((()=>({computation:e,observer:this.analysisViewData.elevationAlignedObserver})),(({computation:e})=>{this._externalObserverUpdate&&(e.inputPoints.isValid=!1,e.notifyInputPointsChanged())}),y.Vh)}_connectComputationToRenderSpaceObserver(e){return this._updatingHandles.add((()=>({computation:e,observer:this._elevationAlignedObserverPositionRenderSpace,observerGroundOffset:this._observerGroundOffsetRenderSpace,observerElevationMode:this._effectiveObserverElevationMode,observerFeatureId:this._observerFeatureId})),(({computation:e,observer:t,observerGroundOffset:i,observerElevationMode:n,observerFeatureId:r})=>{this._onObserverRenderSpacePositionChangeForComputation(e,t,i,n,r)}),y.Vh)}_connectComputationToCamera(e){return this._updatingHandles.add((()=>({camera:this.view.state.camera,isDirty:this._isCameraDirty})),(({isDirty:t})=>{!this.updateOnCameraChange||e.inputPoints.isValid&&!t||e.notifyInputPointsChanged()}))}_connectComputationToSlicePlane(e){return this._updatingHandles.add((()=>this.view.slicePlane),(()=>{e.inputPoints.isValid=!1,e.notifyInputPointsChanged()}))}_connectComputationToElevation(e){const t=(i,n)=>{const r=this.analysis.observer,s=e.target;let o=null,a=null,l=null,u=null,d=null,c=null;if(null!=r?.position){const e=(0,C.projectOrLoad)(r.position,this.view.spatialReference);if(null!=e.pending)return this._updatingHandles.addPromise(e.pending),void e.pending.finally((()=>t(i,n)));o=e.geometry,a=r.elevationInfo,l=r.feature}if(null!=s.position){const e=(0,C.projectOrLoad)(s.position,this.view.spatialReference);if(null!=e.pending)return this._updatingHandles.addPromise(e.pending),void e.pending.finally((()=>t(i,n)));u=e.geometry,d=s.elevationInfo,c=s.feature}null==o&&null==u||((0,w.S)(i,n,ie,this.view.spatialReference),null!=o&&(0,O.vR)(ie,o)&&this._onObserverPositionChange(null!=r?r.position:null,o,a,l,!1),null!=u&&(0,O.vR)(ie,u)&&this._onTargetPositionChange(e,s.position,u,d,c,!1),null!=o&&null!=u&&(0,O.Mx)(ie,o,u)&&e.notifyInputPointsChanged())};return this.view.elevationProvider.on("elevation-change",(({extent:e,spatialReference:i})=>t(e,i)))}_connectComputationToTask(e){let t=null;const i={computation:e,interpolationInfo:{originalIntersection:(0,c.vt)(),originalObserver:(0,c.vt)(),originalTarget:(0,c.vt)()}};return(0,_.vE)([this._updatingHandles.add((()=>e.inputPoints),(()=>{t=(0,a.DC)(t),t=(0,v.UT)((async e=>{await(0,m.QZ)(this._frameTask.schedule((()=>this._computeResult(i)),e))}))}),{initial:!0,equals:()=>!1}),(0,_.hA)((()=>t=(0,a.DC)(t)))])}_connectComputation(e){const t=this._computationHandles;t.has(e)||t.add([this._connectComputationToTarget(e),this._connectComputationToObserver(e),this._connectComputationToRenderSpaceObserver(e),this._connectComputationToCamera(e),this._connectComputationToSlicePlane(e),this._connectComputationToElevation(e),this._connectComputationToTask(e)],e)}_disconnectComputation(e){this._computationHandles.remove(e)}_onComputationCollectionChange({added:e,removed:t}){for(const e of t)this._disconnectComputation(e);for(const t of e)this._connectComputation(t)}_onTargetCollectionChange({added:e,removed:t}){for(const e of t)this._removeTarget(e);for(const t of e)this._addTarget(t)}_onCursorTargetChange(e,t){null!=t&&this._removeTarget(t),null!=e&&this._addTarget(e)}_addTarget(e){this._computations.some((t=>t.target===e))||this._computations.add(new P({target:e}))}_removeTarget(e){const t=this._computations.findIndex((t=>t.target===e));this._computations.removeAt(t)}_connectObserver(){return(0,_.vE)([this._updatingHandles.add((()=>({observerPosition:null!=this.analysis.observer?this.analysis.observer.position:null,projectedObserverPosition:(0,C.projectOrLoad)(null!=this.analysis.observer?this.analysis.observer.position:null,this.view.spatialReference),observerElevationInfo:null!=this.analysis.observer?this.analysis.observer.elevationInfo:null,observerFeatureInfo:null!=this.analysis.observer?this.analysis.observer.feature:null})),(({observerPosition:e,projectedObserverPosition:t,observerElevationInfo:i,observerFeatureInfo:n})=>{null==t.pending?this._onObserverPositionChange(e,t.geometry,i,n,!0):this._updatingHandles.addPromise(t.pending)}),y.Vh)])}_connectComputations(){return this._updatingHandles.addOnCollectionChange((()=>this._computations),(e=>this._onComputationCollectionChange(e)),{initial:!0,final:!0})}_connectTargets(){return(0,_.vE)([this._updatingHandles.addOnCollectionChange((()=>this.analysis.targets),(e=>this._onTargetCollectionChange(e)),{initial:!0,final:!0}),this._updatingHandles.add((()=>this.analysisViewData.cursorTarget),((e,t)=>{this._onCursorTargetChange(e,t)}))])}get _isCameraDirty(){const e=this.analysisViewData.elevationAlignedObserver,{view:t}=this,{renderCoordsHelper:i}=t;if(null==e||null==i)return!1;const n=ee;i.toRenderCoords(e,n);const r=t.state.camera.computeScreenPixelSizeAt(n);return Math.abs((r-this._screenPixelSize)/this._screenPixelSize)>K}};function Q(e,t,i){if((0,k.QS)(e)){const n=(0,k.SM)(e,t);if(null!=n)return Math.min(n*ne,i)}return 1e-5*i}function X(e,t){return e.hasZ?t??{mode:"absolute-height",offset:0}:{mode:"on-the-ground",offset:0}}(0,n._)([(0,l.MZ)({constructOnly:!0})],Y.prototype,"analysis",void 0),(0,n._)([(0,l.MZ)({constructOnly:!0})],Y.prototype,"analysisViewData",void 0),(0,n._)([(0,l.MZ)({constructOnly:!0})],Y.prototype,"view",void 0),(0,n._)([(0,l.MZ)()],Y.prototype,"updating",null),(0,n._)([(0,l.MZ)()],Y.prototype,"priority",null),(0,n._)([(0,l.MZ)()],Y.prototype,"updateOnCameraChange",void 0),(0,n._)([(0,l.MZ)()],Y.prototype,"_computations",null),(0,n._)([(0,l.MZ)()],Y.prototype,"_elevationAlignedObserverPositionRenderSpace",null),(0,n._)([(0,l.MZ)()],Y.prototype,"_observerGroundOffsetRenderSpace",void 0),(0,n._)([(0,l.MZ)()],Y.prototype,"_effectiveObserverElevationMode",void 0),(0,n._)([(0,l.MZ)()],Y.prototype,"_observerFeatureId",void 0),(0,n._)([(0,l.MZ)()],Y.prototype,"_screenPixelSize",null),(0,n._)([(0,l.MZ)({readOnly:!0})],Y.prototype,"_updatingHandles",void 0),(0,n._)([(0,l.MZ)()],Y.prototype,"_frameTask",void 0),(0,n._)([(0,l.MZ)()],Y.prototype,"_isCameraDirty",null),Y=(0,n._)([(0,d.$)("esri.views.3d.analysis.LineOfSight.LineOfSightController")],Y);const K=.1,ee=(0,c.vt)(),te=(0,I.vt)(),ie=(0,O.Ie)(),ne=.05;var re=i(93814),se=i(60832),oe=i(17091),ae=i(94669),le=i(44223),ue=i(60861);const de=new class{constructor(){this.glowWidth=8,this.innerWidth=.75}};const ce=new class{constructor(){this.size=.5}};function he(e){return(0,ue.f6)(e.accentColor,.75)}const pe=new class{constructor(){this.size=.5,this.visibleColor=new re.A([3,252,111,.75]),this.occludedColor=new re.A([252,3,69,.75]),this.undefinedColor=new re.A([127,127,127,.75])}};const ve=new class{constructor(){this.innerWidth=2,this.outerWidth=8,this.visibleInnerColor=new re.A([3,252,111,1]),this.visibleOuterColor=new re.A([3,252,111,.15]),this.occludedInnerColor=new re.A([252,3,69,1]),this.occludedOuterColor=new re.A([252,3,69,.1]),this.undefinedInnerColor=new re.A([255,255,255,1]),this.undefinedOuterColor=new re.A([127,127,127,.2])}};var ge=i(12014),_e=i(59484),me=i(49190),ye=i(15512),fe=i(74316),be=i(10715);class Ce extends ge.q{constructor(e,t){const i=(0,_e.UM)(he(e.effectiveTheme)),n=(0,fe.CM)(i,ce.size,32,32),r=new me.M(n);super({view:e,renderObjects:[r],metadata:t,elevationInfo:{mode:"absolute-height",offset:0}}),(0,ye.s)(this),this.themeHandle=(0,y.wB)((()=>({color:he(e.effectiveTheme)})),(e=>{i.setParameters(e)}))}destroy(){this.themeHandle.remove(),super.destroy()}}class we extends ge.q{constructor(e,t){const{size:i,visibleColor:n,occludedColor:r,undefinedColor:s}=pe;super({view:e,renderObjects:[Oe(i,n,be.SJ.Custom1),Oe(i,r,be.SJ.Custom2),Oe(i,s,be.SJ.Custom3)],metadata:t,elevationInfo:{mode:"absolute-height",offset:0}}),(0,ye.s)(this)}}function Oe(e,t,i){return new me.M((0,fe.CM)((0,_e.UM)(re.A.toUnitRGBA(t)),e,32,32),i)}var Ie,Me=i(95351),Te=(i(68075),i(68574)),Pe=i(66019),Ae=i(20405),Se=i(98596);!function(e){e.Ready="ready",e.Creating="creating",e.Created="created"}(Ie||(Ie={}));let Re=class extends Te.k{constructor(e){super(e),this.removeIncompleteOnCancel=!1,this.analysisViewData=null,this._latestPointerMovePointerType=null,this._laserlineVisualElement=null,this._grabbedManipulator=null,this._analysisHandles=new g.A,this._updatingHandles=new b.U,this._manipulatorHandles=new g.A,this._targetTrackerManipulator=null}initialize(){this._intersector=new j({view:this.view}),this.addHandles((0,y.wB)((()=>this.state),(e=>{e===Ie.Created&&this.finishToolCreation()}),y.pc)),this._observerManipulator=this._createObserverManipulator(),this._createLaserLine(),this.addHandles([this._updatingHandles.add((()=>this.analysisViewData?.elevationAlignedObserver),(e=>this._onObserverLocationChange(e)),y.Vh),this._updatingHandles.add((()=>function(e){const t=e.accentColor;return{glowColor:t,innerColor:(0,ue.bJ)(t),globalAlpha:.75*t.a}}(this.view.effectiveTheme)),(({glowColor:e,innerColor:t,globalAlpha:i})=>this._updateLaserLineStyle(e,t,i)),y.Vh),this._updatingHandles.add((()=>this._laserLineRendererDependencies()),(e=>this._updateLaserLineRenderer(e))),this._connectComputations(),this._updatingHandles.addWhen((()=>!this._shouldRenderTracker),(()=>this._clearCursorTracker()),y.Vh)])}destroy(){this._updatingHandles=(0,a.pR)(this._updatingHandles),this._manipulatorHandles=(0,a.pR)(this._manipulatorHandles),this._analysisHandles=(0,a.pR)(this._analysisHandles),this._observerManipulator=null,this._clearCursorTracker(),this._removeLaserLine(),this._intersector=null,this._set("analysis",null)}get state(){return this.active?this.hasGrabbedManipulators?Ie.Created:Ie.Creating:null!=this.analysis.observer?.position?Ie.Created:Ie.Ready}get cursor(){return this.active&&this._showTracker?"crosshair":null}get updating(){return null!=this.analysisViewData&&this.analysisViewData.updating||this._updatingHandles.updating}get _showTracker(){return this.active&&"mouse"===this._latestPointerMovePointerType}get _shouldRenderTracker(){return this._showTracker&&null!=this.analysis.observer?.position&&!this.hasGrabbedManipulators}continue(){this.view.activeTool=this}stop(){this.view.activeTool=null}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}onInputEvent(e){switch(e.type){case"immediate-double-click":this._doubleClickHandler(e);break;case"key-down":this._keyDownHandler(e);break;case"pointer-move":this._pointerMoveHandler(e)}}onInputEventAfter(e){"immediate-click"===e.type&&this._clickHandler(e)}onShow(){}onHide(){}onDeactivate(){this._clearCursorTracker()}_connectComputations(){return this._updatingHandles.addOnCollectionChange((()=>this.analysisViewData.computations),(e=>this._onComputationsCollectionChange(e)),{initial:!0,final:!0})}_onComputationsCollectionChange({added:e,removed:t}){for(const e of t)this._disconnectComputation(e);for(const t of e)this._connectComputation(t)}_connectComputation(e){if(this.destroyed)return void u.A.getLogger(this).warn("Attempting to connect an analysis to a destroyed LineOfSight tool. Ignoring.");const t=this._analysisHandles;if(t.has(e))return;const i=this._createTargetManipulator(e.target);null==this._targetTrackerManipulator&&i.metadata.target===this.analysisViewData.cursorTarget&&(this._targetTrackerManipulator=i,this._targetTrackerManipulator.available=!1,this._targetTrackerManipulator.interactive=!1,this._updateLaserLineRenderer()),t.add([this._updatingHandles.add((()=>function(e){const{isValid:t,isTargetVisible:i}=e.computationResult;return{isValid:t,isTargetVisible:i}}(e)),(()=>function(e,t){const{isValid:i,isTargetVisible:n}=t.computationResult;e.state=i?n?be.SJ.Custom1:be.SJ.Custom2:be.SJ.Custom3}(i,e)),y.Vh),this._updatingHandles.add((()=>e.elevationAlignedTargetLocation),(e=>this._onTargetLocationChange(e,i)),y.Vh)],e)}_disconnectComputation(e){if(this.destroyed)return void u.A.getLogger(this).warn("Attempting to disconnect an analysis from a destroyed LineOfSight tool. Ignoring.");this._analysisHandles.remove(e);const t=this._getTargetManipulator(e.target);null!=t&&(this.manipulators.remove(t),this._manipulatorHandles.remove(t),null!=this._targetTrackerManipulator&&this._targetTrackerManipulator===t&&(this._targetTrackerManipulator=null))}_clearCursorTracker(){this.analysisViewData.cursorTarget=(0,a.pR)(this.analysisViewData.cursorTarget)}_createTargetManipulator(e){const t={target:e,type:"target"},i=new we(this.view,t);return this._manipulatorHandles.add([this._createTargetManipulatorDragPipeline(i),i.events.on("grab-changed",(e=>this._manipulatorGrabChanged(i,e))),i.events.on("immediate-click",(e=>this._manipulatorClick(i,e)))],i),this.manipulators.add(i),null!=e.position?i.elevationAlignedLocation=e.position:i.available=!1,i}_getTargetManipulator(e){let t=null;return this.manipulators.forEach((i=>{const n=i.manipulator;null==t&&"target"===n.metadata.type&&n.metadata.target===e&&(t=n)})),t}_createObserverManipulator(){const e=new Ce(this.view,{type:"observer",intersection:null});return this._manipulatorHandles.add([this._createObserverManipulatorDragPipeline(e),e.events.on("grab-changed",(t=>this._manipulatorGrabChanged(e,t))),e.events.on("immediate-click",(t=>this._manipulatorClick(e,t)))],e),this.manipulators.add(e),e}_screenToIntersection(){return e=>{const t=this._intersector.getScreenPointIntersection(e.screenEnd);return null==t?null:{...e,intersection:t}}}_createTargetManipulatorDragPipeline(e){return(0,Pe.Xt)(e,((t,i,n)=>{i.next(this._screenToIntersection()).next(this._updateTargetDragStep(e)).next((()=>this._updateLaserLineRenderer())),n.next(function(e){const t=e.position?.clone();return i=>(e.position=t,i)}(e.metadata.target)).next((()=>this._updateLaserLineRenderer()))}))}_createObserverManipulatorDragPipeline(e){return(0,Pe.Xt)(e,((e,t,i)=>{t.next(this._screenToIntersection()).next(this._updateObserverDragStep()).next((()=>this._updateLaserLineRenderer())),i.next(this._cancelObserverDragStep()).next((()=>this._updateLaserLineRenderer()))}))}_updateObserverDragStep(){return e=>(null!=e.intersection.mapPoint?(null==this.analysis.observer&&(this.analysis.observer=new se.A),this._updateFromIntersection(this.analysis.observer,e.intersection)):this.analysis.observer=null,e)}_cancelObserverDragStep(){const e=null!=this.analysis.observer?.position?this.analysis.observer.clone():null;return t=>(this.analysis.observer=e,t)}_updateTargetDragStep(e){return t=>{this._updateFromIntersection(e.metadata.target,t.intersection);const i=t.intersection.mapPoint;return null!=i&&(e.elevationAlignedLocation=i),t}}_manipulatorGrabChanged(e,t){switch(t.action){case"start":this._grabbedManipulator=e;break;case"end":this._grabbedManipulator===e&&(this._grabbedManipulator=null)}}_laserLineRendererDependencies(){return{laserlineVisualElement:this._laserlineVisualElement,grabbedManipulator:this._grabbedManipulator,shouldRenderTracker:this._shouldRenderTracker,observerPosition:null!=this.analysis.observer?this.analysis.observer.position:null,visible:this.visible}}_updateLaserLineRenderer(e=this._laserLineRendererDependencies()){const{laserlineVisualElement:t,grabbedManipulator:i,shouldRenderTracker:n,observerPosition:r,visible:s}=e;if(null==t)return;const o=null!=i?i:n&&null!=r?this._targetTrackerManipulator:null;null!=o&&s?(t.visible=!0,t.heightManifoldTarget=o.renderLocation,o!==this._observerManipulator?t.lineVerticalPlaneSegment=(0,ae.Cr)(this._observerManipulator.renderLocation,o.renderLocation,Ve):t.lineVerticalPlaneSegment=null):(t.visible=!1,t.heightManifoldTarget=null,t.lineVerticalPlaneSegment=null)}_createLaserLine(){this._removeLaserLine();const{glowWidth:e,innerWidth:t}=de;this._laserlineVisualElement=new Me.o({view:this.view,attached:!0,visible:this.visible,style:{glowWidth:e,innerWidth:t},isDecoration:!0})}_removeLaserLine(){null!=this._laserlineVisualElement&&(this._laserlineVisualElement.destroy(),this._laserlineVisualElement=null)}_updateLaserLineStyle(e,t,i){const n=this._laserlineVisualElement;if(null==n)return;const r=n.style;n.style={...r,glowColor:re.A.toUnitRGB(e),innerColor:re.A.toUnitRGB(t),globalAlpha:i}}_onObserverLocationChange(e){null!=e?(this._observerManipulator.metadata.intersection=null,this._observerManipulator.available=!0,this._observerManipulator.elevationAlignedLocation=e):this._observerManipulator.available=!1}_onTargetLocationChange(e,t){null!=e?(t.elevationAlignedLocation=e,t!==this._targetTrackerManipulator&&(t.available=!0)):t.available=!1}_addPointFromClickEvent(e){const t=this._intersector.getScreenPointIntersection(e);if(null!=t?.mapPoint)if(null!=this.analysis.observer?.position){this._clearCursorTracker();const e=new oe.A;this._updateFromIntersection(e,t),this.analysis.targets.add(e)}else{const e=new se.A;this._updateFromIntersection(e,t),this.analysis.observer=e}}_clickHandler(e){this.active&&e.button!==Se.w.Right&&(this._addPointFromClickEvent((0,Ae.ZV)(e)),e.stopPropagation())}_doubleClickHandler(e){this.active&&e.button!==Se.w.Right&&(this.stop(),e.stopPropagation())}_keyDownHandler(e){this.active&&"Escape"===e.key&&(this.stop(),e.stopPropagation())}_pointerMoveHandler(e){if(this.hasGrabbedManipulators)return;if(this._latestPointerMovePointerType=e.pointerType,this._updateLaserLineRenderer(),!this._showTracker||null==this.analysis.observer?.position)return;const t=(0,Ae.ZV)(e),i=this._intersector.getScreenPointIntersection(t);null!=i?.mapPoint&&(null==this.analysisViewData.cursorTarget&&(this.analysisViewData.cursorTarget=new oe.A),this._updateFromIntersection(this.analysisViewData.cursorTarget,i),this._updateLaserLineRenderer())}_updateFromIntersection(e,t){if(null==t.mapPoint)return e.position=null,e.elevationInfo=null,void(e.feature=null);switch(t.type){case F.dz.OBJECT:if(null!=t.graphic){const i=t.graphic,n=(0,M.bh)(i);"on-the-ground"===n.mode&&(n.mode="relative-to-ground",n.offset=0),e.elevationInfo=new le.A(n),e.feature=i}else e.elevationInfo=null,e.feature=null;break;case F.dz.TERRAIN:e.elevationInfo=new le.A({mode:"on-the-ground"}),e.feature=null;break;default:e.elevationInfo=null,e.feature=null}const i=t.mapPoint.clone();i.z=(0,M.wS)(this.view,i,{mode:"absolute-height",offset:0},e.elevationInfo),e.position=i}_manipulatorClick(e,t){if("observer"===e.metadata.type||e.grabbing||e.dragging||t.button!==Se.w.Right||this.analysis.targets.length<=1)return;const{target:i}=e.metadata;this.analysis.targets.remove(i),t.stopPropagation()}get testInfo(){}};(0,n._)([(0,l.MZ)({constructOnly:!0})],Re.prototype,"view",void 0),(0,n._)([(0,l.MZ)({constructOnly:!0})],Re.prototype,"analysis",void 0),(0,n._)([(0,l.MZ)({readOnly:!0})],Re.prototype,"state",null),(0,n._)([(0,l.MZ)({readOnly:!0})],Re.prototype,"cursor",null),(0,n._)([(0,l.MZ)()],Re.prototype,"removeIncompleteOnCancel",void 0),(0,n._)([(0,l.MZ)({readOnly:!0})],Re.prototype,"updating",null),(0,n._)([(0,l.MZ)({constructOnly:!0})],Re.prototype,"analysisViewData",void 0),(0,n._)([(0,l.MZ)({readOnly:!0})],Re.prototype,"_showTracker",null),(0,n._)([(0,l.MZ)()],Re.prototype,"_latestPointerMovePointerType",void 0),(0,n._)([(0,l.MZ)()],Re.prototype,"_shouldRenderTracker",null),(0,n._)([(0,l.MZ)()],Re.prototype,"_laserlineVisualElement",void 0),(0,n._)([(0,l.MZ)()],Re.prototype,"_grabbedManipulator",void 0),Re=(0,n._)([(0,d.$)("esri.views.3d.analysis.LineOfSight.LineOfSightTool")],Re);const Ve=(0,ae.vt)();var Le=i(26110);class Ee{constructor(e,t,i,n){this.visibleLineVisualElement=e,this.occludedLineVisualElement=t,this.undefinedLineVisualElement=i,this.targetVisualElement=n}destroy(){this.visibleLineVisualElement.destroy(),this.occludedLineVisualElement.destroy(),this.undefinedLineVisualElement.destroy(),this.targetVisualElement.destroy()}}var He=i(9921),xe=i(83157);i(31272);let Ze=class extends r.A{constructor(e){super(e),this._lineOfSightVisualElements=new Array,this._computationHandles=new g.A,this._updatingHandles=new b.U}initialize(){this.addHandles(this._connectComputations()),this._createObserverVisualization()}destroy(){this._updatingHandles=(0,a.pR)(this._updatingHandles),this._computationHandles=(0,a.pR)(this._computationHandles),this._observerVisualElement=(0,a.pR)(this._observerVisualElement)}get visible(){return this.analysisViewData.visible}get updating(){return this._updatingHandles.updating}get interactiveAndEditable(){return this.analysisViewData.interactive&&this.analysisViewData.editable}get test(){}_createLineOfSightVisualization(){const e=ve,t=this.view,i=this.isDecoration,n={view:t,attached:!0,width:e.outerWidth,innerWidth:e.innerWidth,isDecoration:i},r=re.A.toUnitRGBA(e.visibleOuterColor),s=re.A.toUnitRGBA(e.visibleInnerColor),o=re.A.toUnitRGBA(e.occludedOuterColor),a=re.A.toUnitRGBA(e.occludedInnerColor),l=re.A.toUnitRGBA(e.undefinedOuterColor),u=re.A.toUnitRGBA(e.undefinedInnerColor),d=new He.t({...n,color:r,innerColor:s}),c=new He.t({...n,color:o,innerColor:a}),h=new He.t({...n,color:l,innerColor:u}),p=new xe.l({view:t,attached:!0,...De,size:8,isDecoration:i}),v=new Ee(d,c,h,p);return this._lineOfSightVisualElements.push(v),v}_destroyLineOfSightVisualization(e){e.destroy(),this._lineOfSightVisualElements.splice(this._lineOfSightVisualElements.indexOf(e),1)}_updateLineOfSightVisualization(e,t,i){const n=ve,{computationResult:r,inputPoints:s}=e,{start:o,end:a,intersection:l,isValid:u,isTargetVisible:d}=r,{observer:h}=s,p=Ge;p[12]=h[0],p[13]=h[1],p[14]=h[2];const v=(0,f.f)(ze,o,h),g=(0,f.f)(Fe,a,h),_=(0,f.f)(ke,l,h),{visibleLineVisualElement:m,occludedLineVisualElement:y,undefinedLineVisualElement:b,targetVisualElement:C}=t,w=null==this.analysisViewData.elevationAlignedObserver||null==e.elevationAlignedTargetLocation,O=this.visible&&!w;m.visible=O,y.visible=O,b.visible=O,C.visible=O,C.attached=!i.interactiveAndEditable,O&&(m.geometry=null,y.geometry=null,b.geometry=null,C.geometry=e.elevationAlignedTargetLocation,u?d?(m.geometry=[[(0,c.ci)(v),(0,c.ci)(g)]],m.transform=p,m.color=re.A.toUnitRGBA(n.visibleOuterColor),C.color=re.A.toUnitRGBA(n.visibleInnerColor)):(m.geometry=[[(0,c.ci)(v),(0,c.ci)(_)]],m.transform=p,m.color=re.A.toUnitRGBA(n.occludedOuterColor),y.geometry=[[(0,c.ci)(_),(0,c.ci)(g)]],y.transform=p,C.color=re.A.toUnitRGBA(n.occludedInnerColor)):(b.geometry=[[(0,c.ci)(v),(0,c.ci)(g)]],b.transform=p,C.color=re.A.toUnitRGBA(n.undefinedInnerColor)))}_getLineOfSightVisualizationDependencies(e){const{computationResult:t}=e,{occludedOuterColor:i,visibleOuterColor:n}=ve;return{computationResult:t,occludedOuterColor:i,visibleOuterColor:n,visible:this.visible,interactiveAndEditable:this.interactiveAndEditable}}_connectComputation(e){const t=this._computationHandles;if(t.has(e))return;const i=this._createLineOfSightVisualization();t.add([this._updatingHandles.add((()=>this._getLineOfSightVisualizationDependencies(e)),(t=>this._updateLineOfSightVisualization(e,i,t)),{initial:!0,equals:()=>!1}),(0,_.hA)((()=>this._destroyLineOfSightVisualization(i)))],e)}_disconnectComputation(e){this._computationHandles.remove(e)}_connectComputations(){return this._updatingHandles.addOnCollectionChange((()=>this.analysisViewData.computations),(e=>this._onComputationsCollectionChange(e)),{initial:!0,final:!0})}_onComputationsCollectionChange({added:e,removed:t}){for(const e of t)this._disconnectComputation(e);for(const t of e)this._connectComputation(t)}_createObserverVisualization(){const e=re.A.toUnitRGBA(ve.visibleInnerColor),t=new xe.l({view:this.view,color:e,...De,isDecoration:this.isDecoration});this._observerVisualElement=t,this.addHandles(this._updatingHandles.add((()=>({observer:this.analysisViewData.elevationAlignedObserver,interactiveAndEditable:this.interactiveAndEditable,visible:this.visible})),(({observer:e,interactiveAndEditable:i,visible:n})=>{null!=e&&!i&&n?(t.geometry=e,this._observerVisualElement.attached=!0):t.attached=!1}),y.Vh))}};(0,n._)([(0,l.MZ)({constructOnly:!0})],Ze.prototype,"analysis",void 0),(0,n._)([(0,l.MZ)({constructOnly:!0})],Ze.prototype,"analysisViewData",void 0),(0,n._)([(0,l.MZ)({constructOnly:!0})],Ze.prototype,"view",void 0),(0,n._)([(0,l.MZ)({readOnly:!0})],Ze.prototype,"visible",null),(0,n._)([(0,l.MZ)({constructOnly:!0})],Ze.prototype,"isDecoration",void 0),(0,n._)([(0,l.MZ)()],Ze.prototype,"updating",null),(0,n._)([(0,l.MZ)()],Ze.prototype,"interactiveAndEditable",null),(0,n._)([(0,l.MZ)()],Ze.prototype,"test",null),Ze=(0,n._)([(0,d.$)("esri.views.3d.analysis.LineOfSight.LineOfSightVisualization")],Ze);const De={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0},ze=(0,c.vt)(),Fe=(0,c.vt)(),ke=(0,c.vt)(),Ge=(0,Le.vt)();var je=i(5495);let Ne=class extends((0,h.P)(o.A.EventedMixin(r.A))){constructor(e){super(e),this.type="line-of-sight-view-3d",this.analysis=null,this.tool=null,this.computations=new s.A,this.elevationAlignedObserver=null,this.observerEngineLocation=(0,c.vt)(),this.cursorTarget=null,this.editable=!0}initialize(){const e=this.view,t=this.analysis;this._analysisController=new Y({analysis:t,analysisViewData:this,view:e}),this._analysisVisualization=new Ze({analysis:t,analysisViewData:this,view:e,isDecoration:!this.parent}),this.addHandles([this._analysisController.on("result-changed",(e=>{e.target!==this.cursorTarget&&this.emit("result-changed",e)})),(0,je.Hd)(this,Re)])}destroy(){(0,je.aS)(this),this._analysisController=(0,a.pR)(this._analysisController),this._analysisVisualization=(0,a.pR)(this._analysisVisualization)}get results(){return this.computations.map((e=>e.result))}get priority(){return this._analysisController.priority}set priority(e){this._analysisController.priority=e}get updating(){return null!=this._analysisController&&this._analysisController.updating||null!=this._analysisVisualization&&this._analysisVisualization.updating}getResultForTarget(e){return this.computations.find((t=>t.target===e))?.result}get testInfo(){}};(0,n._)([(0,l.MZ)({readOnly:!0})],Ne.prototype,"type",void 0),(0,n._)([(0,l.MZ)({constructOnly:!0,nonNullable:!0})],Ne.prototype,"analysis",void 0),(0,n._)([(0,l.MZ)()],Ne.prototype,"tool",void 0),(0,n._)([(0,l.MZ)({readOnly:!0})],Ne.prototype,"results",null),(0,n._)([(0,l.MZ)()],Ne.prototype,"priority",null),(0,n._)([(0,l.MZ)()],Ne.prototype,"computations",void 0),(0,n._)([(0,l.MZ)()],Ne.prototype,"elevationAlignedObserver",void 0),(0,n._)([(0,l.MZ)()],Ne.prototype,"observerEngineLocation",void 0),(0,n._)([(0,l.MZ)()],Ne.prototype,"cursorTarget",void 0),(0,n._)([(0,l.MZ)()],Ne.prototype,"updating",null),(0,n._)([(0,l.MZ)()],Ne.prototype,"editable",void 0),(0,n._)([(0,l.MZ)()],Ne.prototype,"_analysisController",void 0),(0,n._)([(0,l.MZ)()],Ne.prototype,"_analysisVisualization",void 0),Ne=(0,n._)([(0,d.$)("esri.views.3d.analysis.LineOfSightAnalysisView3D")],Ne);const Be=Ne},5751:(e,t,i)=>{i.d(t,{B:()=>s,V:()=>o});var n=i(34561),r=i(2568);function s(e,t,i,s=!1){const o=(0,n.tryProjectWithZConversion)(e,t);return null==o?null:(o.hasZ&&!s||null==i||(o.z=(0,r.R1)(i,o)??0),o)}function o(e,t,i){i.warnOnce(`Failed to project analysis geometry (id: '${e.id}'), projection from spatial reference (wkid: '${t.wkid}') to view spatial reference is not supported. Projection may be possible after calling projection.load().`)}},15512:(e,t,i)=>{i.d(t,{Q:()=>s,s:()=>o});var n=i(70214),r=i(19541);function s(e,t){return function(e,t){return!!e&&"on-the-ground"!==t.mode&&!(0,r.v9)(t)}(e?.data.coordinateHelper.hasZ(),t)}function o(e,t){let i=null;const r=e.events.on("grab-changed",(n=>{null!=i&&(i.remove(),i=null),"start"===n.action?(i=e.disableDisplay(),t&&t(n)):t&&t(n)}));return(0,n.hA)((()=>{i?.remove(),r.remove()}))}},9921:(e,t,i)=>{i.d(t,{t:()=>h});var n=i(25336),r=i(26110),s=i(80347),o=i(19913),a=i(76982),l=i(87795),u=i(41410),d=i(31272),c=i(16596);class h extends l.X{constructor(e,t){super(e),this._hasExternalMaterial=!1,this._hasExternalMaterial=null!=t,this._material=null!=t?t:new c.W({width:1,color:(0,a.fA)(1,0,1,1),stippleOffColor:null,stipplePattern:null,stipplePreferContinuous:!0,isClosed:!1,falloff:0,innerColor:null,innerWidth:1,hasPolygonOffset:!1,renderOccluded:d.m$.OccludeAndTransparent,isDecoration:!!e.isDecoration,writeDepth:!0}),this.applyProperties(e)}setGeometryFromRenderSpacePoint(e,t=1e3){this.geometry=[[[e[0]-t,e[1],e[2]],[e[0]+t,e[1],e[2]]],[[e[0],e[1]-t,e[2]],[e[0],e[1]+t,e[2]]],[[e[0],e[1],e[2]-t],[e[0],e[1],e[2]+t]]]}setGeometryFromExtent(e){const t=this.view.spatialReference,i=(0,o.vt)(),n=(0,o.vt)(),r=100,a=[];(0,s.s)(i,e[0],e[1],r),this.view.renderCoordsHelper.toRenderCoords(i,t,n),a.push([n[0],n[1],n[2]]),(0,s.s)(i,e[2],e[1],r),this.view.renderCoordsHelper.toRenderCoords(i,t,n),a.push([n[0],n[1],n[2]]),(0,s.s)(i,e[2],e[3],r),this.view.renderCoordsHelper.toRenderCoords(i,t,n),a.push([n[0],n[1],n[2]]),(0,s.s)(i,e[0],e[3],r),this.view.renderCoordsHelper.toRenderCoords(i,t,n),a.push([n[0],n[1],n[2]]),(0,s.s)(i,e[0],e[1],r),this.view.renderCoordsHelper.toRenderCoords(i,t,n),a.push([n[0],n[1],n[2]]),(0,s.s)(i,e[0],e[1],r),this.view.renderCoordsHelper.toRenderCoords(i,t,n),a.push([n[0],n[1],n[2]]),this.geometry=[a]}setGeometryFromFrustum(e){const t=[];e.lines.forEach((e=>{t.push([e.origin[0],e.origin[1],e.origin[2]]),t.push([e.endpoint[0],e.endpoint[1],e.endpoint[2]])})),this.geometry=[t]}setGeometryFromBoundedPlane(e){const t=[],i=e.origin,n=e.basis1,r=e.basis2,s=.5,a=(0,o.vt)(),l=(0,o.vt)(),u=(0,o.vt)(),d=(0,o.vt)();a[0]=i[0]-n[0]*s-r[0]*s,a[1]=i[1]-n[1]*s-r[1]*s,a[2]=i[2]-n[2]*s-r[2]*s,l[0]=i[0]-n[0]*s+r[0]*s,l[1]=i[1]-n[1]*s+r[1]*s,l[2]=i[2]-n[2]*s+r[2]*s,u[0]=i[0]+n[0]*s+r[0]*s,u[1]=i[1]+n[1]*s+r[1]*s,u[2]=i[2]+n[2]*s+r[2]*s,d[0]=i[0]+n[0]*s-r[0]*s,d[1]=i[1]+n[1]*s-r[1]*s,d[2]=i[2]+n[2]*s-r[2]*s,t.push([a[0],a[1],a[2]]),t.push([l[0],l[1],l[2]]),t.push([u[0],u[1],u[2]]),t.push([d[0],d[1],d[2]]),t.push([a[0],a[1],a[2]]),this.geometry=[t]}setGeometryFromSegment(e){const t=e.endRenderSpace;this.transform=(0,n.kN)(p,t);const{points:i}=e.createRenderGeometry(t,this.view.renderCoordsHelper);this.geometry=[i]}setGeometryFromSegments(e,t=o.uY){this.transform=(0,n.kN)(p,t),this.geometry=e.map((e=>e.createRenderGeometry(t,this.view.renderCoordsHelper).points))}getTransformedGeometry(){return null==this._geometry?null:this._geometry.map((e=>e.map((e=>(0,s.h)((0,o.vt)(),e,this.transform)))))}get renderOccluded(){return this._material.parameters.renderOccluded}set renderOccluded(e){this._material.setParameters({renderOccluded:e})}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get width(){return this._material.parameters.width}set width(e){this._material.setParameters({width:e})}get color(){return this._material.parameters.color}set color(e){const t=1===e[3];this._material.setParameters({color:(0,a.o8)(e),writeDepth:t})}get innerWidth(){return this._material.parameters.innerWidth}set innerWidth(e){this._material.setParameters({innerWidth:e})}get innerColor(){return this._material.parameters.innerColor}set innerColor(e){this._material.setParameters({innerColor:null!=e?(0,a.o8)(e):null})}get stipplePattern(){return this._material.parameters.stipplePattern}set stipplePattern(e){null!=this._material&&this._material.setParameters({stipplePattern:e})}get stippleOffColor(){return this._material.parameters.stippleOffColor}set stippleOffColor(e){this._material.setParameters({stippleOffColor:null!=e?(0,a.o8)(e):null})}get stipplePreferContinuous(){return this._material.parameters.stipplePreferContinuous}set stipplePreferContinuous(e){this._material.setParameters({stipplePreferContinuous:e})}get falloff(){return this._material.parameters.falloff}set falloff(e){this._material.setParameters({falloff:e})}get polygonOffset(){return this._material.parameters.hasPolygonOffset}set polygonOffset(e){this._material.setParameters({hasPolygonOffset:e})}createExternalResources(){}destroyExternalResources(){}createGeometries(e){for(const t of(0,u.z)(this.geometry)){const i=(0,u.t)(this._material,t);e.addGeometry(i)}}forEachExternalMaterial(e){this._hasExternalMaterial||e(this._material)}}const p=(0,r.vt)()},83157:(e,t,i)=>{i.d(t,{l:()=>y});var n=i(4506),r=i(80347),s=i(19913),o=i(74772),a=i(76982),l=i(42722),u=i(46373),d=i(11631),c=i(87795),h=i(5822),p=i(93129),v=i(11519),g=i(74316),_=i(33763),m=i(21561);class y extends c.X{constructor(e){super(e),this._material=null,this._texture=null,this._geometry=null,this._size=3,this._color=(0,a.fA)(1,0,1,1),this._pixelSnappingEnabled=!0,this._primitive="square",this._outlineSize=1,this._outlineColor=(0,a.fA)(1,1,1,1),this._elevationInfo=null,this.applyProperties(e)}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get size(){return this._size}set size(e){if(e!==this._size){const t=this._preferredTextureSize;this._size=e,t<this._preferredTextureSize?this.recreate():this._updateSizeAttribute()}}get color(){return this._color}set color(e){(0,o.a)(e,this._color)||((0,o.c)(this._color,e),this._updateMaterial())}get pixelSnappingEnabled(){return this._pixelSnappingEnabled}set pixelSnappingEnabled(e){this._pixelSnappingEnabled!==e&&(this._pixelSnappingEnabled=e,this._updateMaterial())}get primitive(){return this._primitive}set primitive(e){this._primitive!==e&&(this._primitive=e,this.recreate())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){(0,o.a)(e,this._outlineColor)||((0,o.c)(this._outlineColor,e),this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}_updateMaterial(){this._material&&this._material.setParameters(this._materialParameters)}_updateSizeAttribute(){const e=this.object;if(null==e)return;const t=e.geometries[0];if(null==t)return;const i=t.getMutableAttribute(_.r.SIZE).data,n=this._geometrySize;i[0]=n,i[1]=n,e.geometryVertexAttributeUpdated(e.geometries[0],_.r.SIZE)}get _materialParameters(){return{color:this._color,textureIsSignedDistanceField:!0,sampleSignedDistanceFieldTexelCenter:(0,v.ny)(this._primitive),distanceFieldBoundingBox:b,occlusionTest:!1,outlineColor:this._outlineColor,outlineSize:this._outlineSize,textureId:this._texture?.id,polygonOffset:!1,shaderPolygonOffset:0,drawInSecondSlot:!0,depthEnabled:!1,pixelSnappingEnabled:this.pixelSnappingEnabled,isDecoration:this.isDecoration}}get _geometrySize(){return this._size/f}createExternalResources(){this._texture=(0,v.sZ)(this._primitive,this._preferredTextureSize),this._material=new m.R(this._materialParameters);const e=this.view._stage;this._texture.load(e.renderView.renderingContext),e.add(this._texture)}destroyExternalResources(){this._texture&&(this.view._stage.remove(this._texture),this._texture.dispose(),this._texture=null),this._material=null}createGeometries(e){const t=this._createRenderGeometry();null!=t&&e.addGeometry(t)}forEachExternalMaterial(e){this._material&&e(this._material)}get _preferredTextureSize(){return(0,n.qE)(2*this._geometrySize,16,128)}calculateMapBounds(e){const t=this.object?.geometries[0];if(!t)return!1;const i=t.attributes.get(_.r.POSITION).data;return(0,l.F)(i,this.view.renderCoordsHelper.spatialReference,C,this.view.spatialReference),(0,u.Hq)(e,C),!0}_createRenderGeometry(){const{geometry:e,_material:t}=this;if(null==e||null==t)return null;const{renderCoordsHelper:i,elevationProvider:n}=this.view,s=(0,h.nG)(e,n,p.F.fromElevationInfo(this.elevationInfo),i),o=(0,r.s)(d.rq.get(),e.x,e.y,s),a=d.rq.get();(0,l.F)(o,e.spatialReference,a,i.spatialReference);const u=this._geometrySize;return(0,g.DJ)(t,null,a,null,[u,u],[0,0,0,1])}}const f=v.CN,b=[f/2,f/2,1-f/2,1-f/2],C=(0,s.vt)()},5495:(e,t,i)=>{i.d(t,{Hd:()=>l,JY:()=>a,aS:()=>u});var n=i(3132),r=i(57725),s=i(37623),o=i(61985);function a(e,t){e.interactive=!0;const{tool:i,view:a}=e;a.activeTool=i;let l=(0,s.u7)(t,(()=>{a.activeTool===i&&(a.activeTool=null)}));return(0,n.UT)((async e=>{await(0,o.C_)((()=>null==i||!i.active),e),l=(0,r.xt)(l)}),t)}function l(e,t){return(0,o.wB)((()=>e.interactive),(()=>function(e,t){e.interactive?function(e,t){u(e);const{view:i,analysis:n}=e,r=new t({view:i,analysis:n,analysisViewData:e});e.tool=r,i.tools.add(r)}(e,t):u(e)}(e,t)),o.pc)}function u(e){const{view:t,tool:i}=e;null!=i&&(t.tools.remove(i),e.tool=null)}},68574:(e,t,i)=>{i.d(t,{k:()=>a});var n=i(82392),r=i(61985),s=(i(80861),i(6273),i(67498),i(62991),i(26325)),o=i(6364);let a=class extends o.g{constructor(e){super(e)}initialize(){this.addHandles((0,r.wB)((()=>this.analysisViewData.visible),(e=>this.visible=e),r.pc))}deactivate(){this.onDeactivate(),this.created||this.analysis.clear()}resetCreated(){this._set("created",!1)}};a=(0,n._)([(0,s.$)("esri.views.interactive.AnalysisToolBase")],a)}}]);