"use strict";(self.webpackChunkarcgis_node=self.webpackChunkarcgis_node||[]).push([[9655],{16269:(t,e,s)=>{s.d(e,{A:()=>c});var i,r,h=s(6273),n=s(39744);(r=i||(i={}))[r.varint=0]="varint",r[r.fixed64=1]="fixed64",r[r.delimited=2]="delimited",r[r.fixed32=5]="fixed32",r[r.unknown=99]="unknown";const a=4294967296,o=new TextDecoder("utf-8"),l=(0,h.A)("safari")||(0,h.A)("ios")?6:(0,h.A)("ff")?12:32;class c{constructor(t,e,s=0,r=(t?t.byteLength:0)){this._tag=0,this._dataType=i.unknown,this._init(t,e,s,r)}_init(t,e,s,i){this._data=t,this._dataView=e,this._pos=s,this._end=i}asUnsafe(){return this}clone(){return new c(this._data,this._dataView,this._pos,this._end)}pos(){return this._pos}move(t){this._pos=t}nextTag(t){for(;;){if(this._pos===this._end)return!1;const e=this._decodeVarint();if(this._tag=e>>3,this._dataType=7&e,!t||t===this._tag)break;this.skip()}return!0}next(){if(this._pos===this._end)return!1;const t=this._decodeVarint();return this._tag=t>>3,this._dataType=7&t,!0}empty(){return this._pos>=this._end}tag(){return this._tag}getInt32(){return this._decodeVarint()}getInt64(){return this._decodeVarint()}getUInt32(){let t=4294967295;if(t=(127&this._data[this._pos])>>>0,this._data[this._pos++]<128)return t;if(t=(t|(127&this._data[this._pos])<<7)>>>0,this._data[this._pos++]<128)return t;if(t=(t|(127&this._data[this._pos])<<14)>>>0,this._data[this._pos++]<128)return t;if(t=(t|(127&this._data[this._pos])<<21)>>>0,this._data[this._pos++]<128)return t;if(t=(t|(15&this._data[this._pos])<<28)>>>0,this._data[this._pos++]<128)return t;throw new Error("Varint overflow")}getUInt64(){return this._decodeVarint()}getSInt32(){const t=this.getUInt32();return t>>>1^-(1&t)}getSInt64(){return this._decodeSVarint()}getBool(){const t=0!==this._data[this._pos];return this._skip(1),t}getEnum(){return this._decodeVarint()}getFixed64(){const t=this._dataView,e=this._pos,s=t.getUint32(e,!0)+t.getUint32(e+4,!0)*a;return this._skip(8),s}getSFixed64(){const t=this._dataView,e=this._pos,s=t.getUint32(e,!0)+t.getInt32(e+4,!0)*a;return this._skip(8),s}getDouble(){const t=this._dataView.getFloat64(this._pos,!0);return this._skip(8),t}getFixed32(){const t=this._dataView.getUint32(this._pos,!0);return this._skip(4),t}getSFixed32(){const t=this._dataView.getInt32(this._pos,!0);return this._skip(4),t}getFloat(){const t=this._dataView.getFloat32(this._pos,!0);return this._skip(4),t}getString(){const t=this._getLength(),e=this._pos,s=this._toString(this._data,e,e+t);return this._skip(t),s}getBytes(){const t=this._getLength(),e=this._pos,s=this._toBytes(this._data,e,e+t);return this._skip(t),s}getLength(){return this._getLengthUnsafe()}processMessageWithArgs(t,e,s,i){const r=this.getMessage(),h=t(r,e,s,i);return r.release(),h}processMessage(t){const e=this.getMessage(),s=t(e);return e.release(),s}getMessage(){const t=this._getLength(),e=c.pool.acquire();return e._init(this._data,this._dataView,this._pos,this._pos+t),this._skip(t),e}release(){c.pool.release(this)}dataType(){return this._dataType}skip(){switch(this._dataType){case i.varint:this._decodeVarint();break;case i.fixed64:this._skip(8);break;case i.delimited:this._skip(this._getLength());break;case i.fixed32:this._skip(4);break;default:throw new Error("Invalid data type!")}}skipLen(t){this._skip(t)}_skip(t){if(this._pos+t>this._end)throw new Error("Attempt to skip past the end of buffer!");this._pos+=t}_decodeVarint(){const t=this._data;let e=this._pos,s=0,i=0;if(this._end-e>=10)do{if(i=t[e++],s|=127&i,!(128&i))break;if(i=t[e++],s|=(127&i)<<7,!(128&i))break;if(i=t[e++],s|=(127&i)<<14,!(128&i))break;if(i=t[e++],s|=(127&i)<<21,!(128&i))break;if(i=t[e++],s+=268435456*(127&i),!(128&i))break;if(i=t[e++],s+=34359738368*(127&i),!(128&i))break;if(i=t[e++],s+=4398046511104*(127&i),!(128&i))break;if(i=t[e++],s+=562949953421312*(127&i),!(128&i))break;if(i=t[e++],s+=72057594037927940*(127&i),!(128&i))break;if(i=t[e++],s+=0x8000000000000000*(127&i),!(128&i))break;throw new Error("Varint too long!")}while(0);else{let r=1;for(;e!==this._end&&(i=t[e],128&i);)++e,s+=(127&i)*r,r*=128;if(e===this._end)throw new Error("Varint overrun!");++e,s+=i*r}return this._pos=e,s}_decodeSVarint(){const t=this._data;let e,s=0,i=0;const r=1&t[this._pos];if(i=t[this._pos++],s|=127&i,!(128&i))return r?-(s+1)/2:s/2;if(i=t[this._pos++],s|=(127&i)<<7,!(128&i))return r?-(s+1)/2:s/2;if(i=t[this._pos++],s|=(127&i)<<14,!(128&i))return r?-(s+1)/2:s/2;if(i=t[this._pos++],s|=(127&i)<<21,!(128&i))return r?-(s+1)/2:s/2;if(i=t[this._pos++],s+=268435456*(127&i),!(128&i))return r?-(s+1)/2:s/2;if(i=t[this._pos++],s+=34359738368*(127&i),!(128&i))return r?-(s+1)/2:s/2;if(i=t[this._pos++],s+=4398046511104*(127&i),!(128&i))return r?-(s+1)/2:s/2;if(e=BigInt(s),i=t[this._pos++],e+=0x2000000000000n*BigInt(127&i),!(128&i))return Number(r?-(e+1n)/2n:e/2n);if(i=t[this._pos++],e+=0x100000000000000n*BigInt(127&i),!(128&i))return Number(r?-(e+1n)/2n:e/2n);if(i=t[this._pos++],e+=0x8000000000000000n*BigInt(127&i),!(128&i))return Number(r?-(e+1n)/2n:e/2n);throw new Error("Varint too long!")}_getLength(){if(this._dataType!==i.delimited)throw new Error("Not a delimited data type!");return this._decodeVarint()}_getLengthUnsafe(){return this.getUInt32()}_toString(t,e,s){if((s=Math.min(this._end,s))-e>l){const i=t.subarray(e,s);return o.decode(i)}let i="",r="";for(let h=e;h<s;++h){const e=t[h];128&e?r+="%"+e.toString(16):(i+=decodeURIComponent(r)+String.fromCharCode(e),r="")}return r.length&&(i+=decodeURIComponent(r)),i}_toBytes(t,e,s){return s=Math.min(this._end,s),new Uint8Array(t.buffer,e,s-e)}}c.pool=new n.A(c,void 0,(t=>{t._data=null,t._dataView=null}))},61866:(t,e,s)=>{s.d(e,{$:()=>i,s:()=>r});const i=15.5,r=1024},73356:(t,e,s)=>{s.d(e,{c:()=>a,k:()=>o});var i=s(39637),r=s(4506),h=s(61866);const n=t=>"vertical"===t||"horizontal"===t||"cross"===t||"esriSFSCross"===t||"esriSFSVertical"===t||"esriSFSHorizontal"===t;function a(t,e,s){const i=e.style,h=(0,r.yR)(Math.ceil(s)),a=n(i)?8*h:16*h,o=2*h;t.width=a,t.height=a;const l=t.getContext("2d");l.strokeStyle="#FFFFFF",l.lineWidth=h,l.beginPath(),"vertical"!==i&&"cross"!==i&&"esriSFSCross"!==i&&"esriSFSVertical"!==i||(l.moveTo(a/2,-o),l.lineTo(a/2,a+o)),"horizontal"!==i&&"cross"!==i&&"esriSFSCross"!==i&&"esriSFSHorizontal"!==i||(l.moveTo(-o,a/2),l.lineTo(a+o,a/2)),"backward-diagonal"!==i&&"diagonal-cross"!==i&&"esriSFSDiagonalCross"!==i&&"esriSFSBackwardDiagonal"!==i||(l.moveTo(-o,-o),l.lineTo(a+o,a+o),l.moveTo(a-o,-o),l.lineTo(a+o,o),l.moveTo(-o,a-o),l.lineTo(o,a+o)),"forward-diagonal"!==i&&"diagonal-cross"!==i&&"esriSFSForwardDiagonal"!==i&&"esriSFSDiagonalCross"!==i||(l.moveTo(a+o,-o),l.lineTo(-o,a+o),l.moveTo(o,-o),l.lineTo(-o,o),l.moveTo(a+o,a-o),l.lineTo(a-o,a+o)),l.stroke();const c=l.getImageData(0,0,t.width,t.height),_=new Uint8Array(c.data);let u;for(let t=0;t<_.length;t+=4)u=_[t+3]/255,_[t]=_[t]*u,_[t+1]=_[t+1]*u,_[t+2]=_[t+2]*u;return[_,t.width,t.height,h]}function o(t,e){null==t&&(t=[]);const s="Butt"===e,r="Square"===e,n=!s&&!r;t.length%2==1&&(t=[...t,...t]);const a=h.$,o=2*a;let l=0;for(const e of t)l+=e;const c=Math.round(l*a),_=new Float32Array(c*o),u=.5*a;let g=0,d=0,p=.5,f=!0;for(const e of t){for(g=d,d+=e*a;p<=d;){let t=.5;for(;t<o;){const e=(t-.5)*c+p-.5,i=n?(t-a)*(t-a):Math.abs(t-a);_[e]=f?s?Math.max(Math.max(g+u-p,i),Math.max(p-d+u,i)):i:n?Math.min((p-g)*(p-g)+i,(p-d)*(p-d)+i):r?Math.min(Math.max(p-g,i),Math.max(d-p,i)):Math.min(Math.max(p-g+u,i),Math.max(d+u-p,i)),t++}p++}f=!f}const y=_.length,w=new Uint8Array(4*y);for(let t=0;t<y;++t){const e=(n?Math.sqrt(_[t]):_[t])/a;(0,i.U)(e,w,4*t)}return[w,c,o]}},88317:(t,e,s)=>{s.d(e,{d:()=>x});var i=s(57725),r=s(37623),h=s(19759),n=s(73462),a=s(65020);class o{constructor(t,e){this._width=0,this._height=0,this._free=[],this._width=t,this._height=e,this._free.push(new a.A(0,0,t,e))}get width(){return this._width}get height(){return this._height}allocate(t,e){if(t>this._width||e>this._height)return new a.A;let s=null,i=-1;for(let r=0;r<this._free.length;++r){const h=this._free[r];t<=h.width&&e<=h.height&&(null===s||h.y<=s.y&&h.x<=s.x)&&(s=h,i=r)}return null===s?new a.A:(this._free.splice(i,1),s.width<s.height?(s.width>t&&this._free.push(new a.A(s.x+t,s.y,s.width-t,e)),s.height>e&&this._free.push(new a.A(s.x,s.y+e,s.width,s.height-e))):(s.width>t&&this._free.push(new a.A(s.x+t,s.y,s.width-t,s.height)),s.height>e&&this._free.push(new a.A(s.x,s.y+e,t,s.height-e))),new a.A(s.x,s.y,t,e))}release(t){for(let e=0;e<this._free.length;++e){const s=this._free[e];if(s.y===t.y&&s.height===t.height&&s.x+s.width===t.x)s.width+=t.width;else if(s.x===t.x&&s.width===t.width&&s.y+s.height===t.y)s.height+=t.height;else if(t.y===s.y&&t.height===s.height&&t.x+t.width===s.x)s.x=t.x,s.width+=t.width;else{if(t.x!==s.x||t.width!==s.width||t.y+t.height!==s.y)continue;s.y=t.y,s.height+=t.height}this._free.splice(e,1),this.release(t)}this._free.push(t)}}var l=s(68716),c=s(89958),_=s(88416);class u{constructor(t,e,s){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphIndex={},this._textures=[],this._rangePromises=new Map,this.width=t,this.height=e,this._glyphSource=s,this._binPack=new o(t-4,e-4),this._glyphData.push(new Uint8Array(t*e)),this._dirties.push(!0),this._textures.push(void 0)}getGlyphItems(t,e){const s=[],i=this._glyphSource,r=new Set,h=1/256;for(const t of e){const e=Math.floor(t*h);r.add(e)}const n=[];return r.forEach((e=>{const s=t+e;if(this._rangePromises.has(s))n.push(this._rangePromises.get(s));else{const r=i.getRange(t,e).then((()=>{this._rangePromises.delete(s)}),(()=>{this._rangePromises.delete(s)}));this._rangePromises.set(s,r),n.push(r)}})),Promise.all(n).then((()=>{let r=this._glyphIndex[t];r||(r={},this._glyphIndex[t]=r);for(const h of e){const e=r[h];if(e){s[h]={sdf:!0,rect:e.rect,metrics:e.metrics,page:e.page,code:h};continue}const n=i.getGlyph(t,h);if(!n?.metrics)continue;const l=n.metrics;let c;if(0===l.width)c=new a.A(0,0,0,0);else{const t=3,e=l.width+2*t,s=l.height+2*t;let i=e%4?4-e%4:4,r=s%4?4-s%4:4;1===i&&(i=5),1===r&&(r=5),c=this._binPack.allocate(e+i,s+r),c.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(void 0),this._binPack=new o(this.width-4,this.height-4),c=this._binPack.allocate(e+i,s+r));const h=this._glyphData[this._currentPage],a=n.bitmap;let _,u;if(a)for(let t=0;t<s;t++){_=e*t,u=this.width*(c.y+t+1)+c.x;for(let t=0;t<e;t++)h[u+t+1]=a.at(_+t)}}r[h]={rect:c,metrics:l,tileIDs:null,page:this._currentPage},s[h]={sdf:!0,rect:c,metrics:l,page:this._currentPage,code:h},this._dirties[this._currentPage]=!0}return s}))}removeGlyphs(t){for(const e in this._glyphIndex){const s=this._glyphIndex[e];if(!s)continue;let i;for(const e in s)if(i=s[e],i.tileIDs.delete(t),0===i.tileIDs.size){const t=this._glyphData[i.page],r=i.rect;let h,n;for(let e=0;e<r.height;e++)for(h=this.width*(r.y+e)+r.x,n=0;n<r.width;n++)t[h+n]=0;delete s[e],this._dirties[i.page]=!0}}}bind(t,e,s,i=0){if(!this._textures[s]){const e=new _.R;e.pixelFormat=l.Ab.ALPHA,e.wrapMode=l.pF.CLAMP_TO_EDGE,e.width=this.width,e.height=this.height,this._textures[s]=new c.g(t,e,new Uint8Array(this.width*this.height))}const r=this._textures[s];r.setSamplingMode(e),this._dirties[s]&&r.setData(this._glyphData[s]),t.bindTexture(r,i),this._dirties[s]=!1}destroy(){this.dispose()}dispose(){this._glyphData.length=0,this._binPack=null;for(const t of this._textures)t&&t.dispose();this._textures.length=0}}var g=s(38116),d=s(16269);class p{constructor(t){if(this._metrics=[],!t)return void(this._allBitmaps=null);const e=new Map;let s=0;for(;t.next();)switch(t.tag()){case 1:{const i=t.getMessage();for(;i.next();)switch(i.tag()){case 3:{const t=i.getMessage();let r,h,n,a,o,l,c;for(;t.next();)switch(t.tag()){case 1:r=t.getUInt32();break;case 2:h=t.getBytes();break;case 3:n=t.getUInt32();break;case 4:a=t.getUInt32();break;case 5:o=t.getSInt32();break;case 6:l=t.getSInt32();break;case 7:c=t.getUInt32();break;default:t.skip()}if(t.release(),r){const t=h?.length??0;this._metrics[r]={width:n,height:a,left:o,top:l,advance:c,startOffset:s,length:t},e.set(r,h),s+=t}break}default:i.skip()}i.release();break}default:t.skip()}const i=new Uint8Array(s),r=this._metrics;for(const[t,s]of e){const{startOffset:e,length:h}=r[t];if(s)for(let t=0;t<h;++t)i[e+t]=s[t]}this._allBitmaps=i}getMetrics(t){return this._metrics[t]}getBitmap(t){if(!this._allBitmaps)return;const e=this._metrics[t];if(void 0===e)return;const{startOffset:s,length:i}=e;return 0!==i?new w(this._allBitmaps,s,i):void 0}}class f{constructor(){this._ranges=[]}get ranges(){return this._ranges}getRange(t){return this._ranges[t]}addRange(t,e){this._ranges[t]=e}}class y{constructor(t){this._glyphInfo={},this._baseURL=t}getRange(t,e){const s=this._getFontStack(t);if(s.getRange(e))return Promise.resolve();const i=256*e,r=i+255;if(this._baseURL){const h=this._baseURL.replace("{fontstack}",t).replace("{range}",i+"-"+r);return(0,g.A)(h,{responseType:"array-buffer"}).then((t=>{s.addRange(e,new p(new d.A(new Uint8Array(t.data),new DataView(t.data))))})).catch((()=>{s.addRange(e,new p)}))}return s.addRange(e,new p),Promise.resolve()}getGlyph(t,e){const s=this._getFontStack(t);if(!s)return;const i=Math.floor(e/256),r=s.getRange(i);return r?{metrics:r.getMetrics(e),bitmap:r.getBitmap(e)}:void 0}_getFontStack(t){let e=this._glyphInfo[t];return e||(e=this._glyphInfo[t]=new f),e}}class w{constructor(t,e,s){this._array=t,this._start=e,this.length=s}at(t){return 0<=t&&t<this.length?this._array[this._start+t]:void 0}}s(6273);var m=s(73356);class S{constructor(t,e,s=0){this._size=[],this._mosaicsData=[],this._textures=[],this._dirties=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects={},this.pixelRatio=1,e<=0&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=t,this._pageHeight=e,s>0&&(this._maxItemSize=s),this._binPack=new o(t-4,e-4)}destroy(){this.dispose()}dispose(){this._binPack=null,this._mosaicsData.length=0,this._mosaicRects={};for(const t of this._textures)t&&t.dispose();this._textures.length=0}getWidth(t){return t>=this._size.length?-1:this._size[t][0]}getHeight(t){return t>=this._size.length?-1:this._size[t][1]}getPageSize(t){return t>=this._size.length?null:this._size[t]}setSpriteSource(t){if(this.dispose(),this.pixelRatio=t.devicePixelRatio,0===this._mosaicsData.length){this._binPack=new o(this._pageWidth-4,this._pageHeight-4);const t=Math.floor(this._pageWidth),e=Math.floor(this._pageHeight),s=new Uint32Array(t*e);this._mosaicsData[0]=s,this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0)}this._sprites=t}getSpriteItem(t,e=!1){let s,i,r=this._mosaicRects[t];if(r)return r;if(!this._sprites||"loaded"!==this._sprites.loadStatus)return null;if(t&&t.startsWith("dasharray-")?([s,i]=this._rasterizeDash(t),e=!0):s=this._sprites.getSpriteInfo(t),!s?.width||!s.height||s.width<0||s.height<0)return null;const h=s.width,n=s.height,[a,o,l]=this._allocateImage(h,n);return a.width<=0?null:(this._copy(a,s,o,l,e,i),r={type:"sprite",rect:a,width:h,height:n,sdf:s.sdf,simplePattern:!1,rasterizationScale:s.pixelRatio,page:o},this._mosaicRects[t]=r,r)}getSpriteItems(t){const e={};for(const s of t)e[s.name]=this.getSpriteItem(s.name,s.repeat);return e}getMosaicItemPosition(t,e){const s=this.getSpriteItem(t,e),i=s?.rect;if(!i)return null;i.width=s.width,i.height=s.height;const r=s.width,h=s.height;return{tl:[i.x+2,i.y+2],br:[i.x+2+r,i.y+2+h],page:s.page}}bind(t,e,s=0,i=0){if(s>=this._size.length||s>=this._mosaicsData.length)return;if(!this._textures[s]){const e=new _.R;e.wrapMode=l.pF.CLAMP_TO_EDGE,e.width=this._size[s][0],e.height=this._size[s][1],this._textures[s]=new c.g(t,e,new Uint8Array(this._mosaicsData[s].buffer))}const r=this._textures[s];r.setSamplingMode(e),this._dirties[s]&&r.setData(new Uint8Array(this._mosaicsData[s].buffer)),t.bindTexture(r,i),this._dirties[s]=!1}static _copyBits(t,e,s,i,r,h,n,a,o,l,c){let _=i*e+s,u=a*h+n;if(c){u-=h;for(let n=-1;n<=l;n++,_=((n+l)%l+i)*e+s,u+=h)for(let e=-1;e<=o;e++)r[u+e]=t[_+(e+o)%o]}else for(let s=0;s<l;s++){for(let e=0;e<o;e++)r[u+e]=t[_+e];_+=e,u+=h}}_copy(t,e,s,i,r,h){if(!this._sprites||"loaded"!==this._sprites.loadStatus||s>=this._mosaicsData.length)return;const n=new Uint32Array(h?h.buffer:this._sprites.image.buffer),a=this._mosaicsData[s],o=h?e.width:this._sprites.width;S._copyBits(n,o,e.x,e.y,a,i[0],t.x+2,t.y+2,e.width,e.height,r),this._dirties[s]=!0}_allocateImage(t,e){t+=2,e+=2;const s=Math.max(t,e);if(this._maxItemSize&&this._maxItemSize<s){const s=new a.A(0,0,t,e);return this._mosaicsData.push(new Uint32Array(t*e)),this._dirties.push(!0),this._size.push([t,e]),this._textures.push(void 0),[s,this._mosaicsData.length-1,[t,e]]}let i=t%4?4-t%4:4,r=e%4?4-e%4:4;1===i&&(i=5),1===r&&(r=5);const h=this._binPack.allocate(t+i,e+r);return h.width<=0?(this._dirties[this._currentPage]||(this._mosaicsData[this._currentPage]=null),this._currentPage=this._mosaicsData.length,this._mosaicsData.push(new Uint32Array(this._pageWidth*this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0),this._binPack=new o(this._pageWidth-4,this._pageHeight-4),this._allocateImage(t,e)):[h,this._currentPage,[this._pageWidth,this._pageHeight]]}_rasterizeDash(t){const e=t.match(/\[(.*?)\]/);if(!e)return null;const s=e[1].split(",").map(Number),i=t.slice(t.lastIndexOf("-")+1),[r,h,n]=(0,m.k)(s,i);return[{x:0,y:0,width:h,height:n,sdf:!0,pixelRatio:1},new Uint8Array(r.buffer)]}}var b=s(39156);class x{constructor(t,e,s,i){this._layer=t,this._styleRepository=e,this.devicePixelRatio=s,this._sourceDataMaxLOD=i,this._spriteMosaic=null,this._glyphMosaic=null,this._connection=null,this._spriteSourceAbortController=null,this._startOptionsInputSignal=null,this._inputSignalEventListener=null}destroy(){this._connection?.close(),this._connection=null,this._styleRepository=null,this._layer=null,this._spriteMosaic?.destroy(),this._spriteMosaic=null,this._glyphMosaic=null,this._spriteSourceAbortController=(0,i.DC)(this._spriteSourceAbortController),this._spriteSourcePromise=null,this._inputSignalEventListener&&this._startOptionsInputSignal?.removeEventListener("abort",this._inputSignalEventListener),this._startOptionsInputSignal=null,this._inputSignalEventListener=null}get spriteMosaic(){return this._spriteSourcePromise.then((()=>this._spriteMosaic))}get glyphMosaic(){return this._glyphMosaic}async start(t){this._requestSprite(t);const e=this._layer.currentStyleInfo.glyphsUrl,s=new y(e?(0,h.a6)(e,{...this._layer.customParameters,token:this._layer.apiKey}):null);this._glyphMosaic=new u(1024,1024,s),this._broadcastPromise=(0,n.ho)("WorkerTileHandler",{client:this,schedule:t.schedule,signal:t.signal}).then((e=>{if(this._layer&&(this._connection?.close(),this._connection=e,this._layer&&!this._connection.closed)){const s=e.broadcast("setStyle",{style:this._layer.currentStyleInfo.style,sourceDataMaxLOD:this._sourceDataMaxLOD},t);Promise.all(s).catch((t=>(0,r.jH)(t)))}}))}_requestSprite(t){this._spriteSourceAbortController?.abort();const e=new AbortController;this._spriteSourceAbortController=e;const s=t?.signal;this._inputSignalEventListener&&this._startOptionsInputSignal?.removeEventListener("abort",this._inputSignalEventListener),this._startOptionsInputSignal=null,s&&(this._inputSignalEventListener=function(t){return()=>t.abort()}(e),s.addEventListener("abort",this._inputSignalEventListener,{once:!0}));const{signal:i}=e,h={...t,signal:i};this._spriteSourcePromise=this._layer.loadSpriteSource(this.devicePixelRatio,h),this._spriteSourcePromise.then((t=>{(0,r.QP)(i),this._spriteMosaic=new S(1024,1024,250),this._spriteMosaic.setSpriteSource(t)}))}async updateStyle(t){return await this._broadcastPromise,this._broadcastPromise=Promise.all(this._connection.broadcast("updateStyle",t)),this._broadcastPromise}setSpriteSource(t){const e=new S(1024,1024,250);return e.setSpriteSource(t),this._spriteMosaic=e,this._spriteSourcePromise=Promise.resolve(t),this._spriteSourceAbortController=null,e}async setStyle(t,e,s){await this._broadcastPromise,this._styleRepository=t,this._sourceDataMaxLOD=s,this._requestSprite();const i=new y(this._layer.currentStyleInfo.glyphsUrl?(0,h.a6)(this._layer.currentStyleInfo.glyphsUrl,{...this._layer.customParameters,token:this._layer.apiKey}):null);return this._glyphMosaic=new u(1024,1024,i),this._broadcastPromise=Promise.all(this._connection.broadcast("setStyle",{style:e,sourceDataMaxLOD:this._sourceDataMaxLOD})),this._broadcastPromise}async fetchTileData(t,e){const s=await this._getRefKeys(t,e);return this._getSourcesData(Object.keys(this._layer.sourceNameToSource),s,e)}async fetchTilePBFs(t){const e=Object.keys(this._layer.sourceNameToSource),s={},i=await this._getRefKeys(t,s),r=[],h=[];for(let t=0;t<i.length;t++)if(null==i[t].value||null==e[t])h.push(null);else{const n=i[t].value,a=this._getTilePayload(n,e[t],s);a.then((t=>{r.push({...t,key:n})})),h.push(a)}return Promise.all(h).then((()=>r))}async parseTileData(t,e){const s=t&&t.data;if(!s)return null;const{sourceName2DataAndRefKey:i,transferList:r}=s;return 0===Object.keys(i).length?null:this._broadcastPromise.then((()=>this._connection.invoke("createTileAndParse",{key:t.key.id,sourceName2DataAndRefKey:i,styleLayerUIDs:t.styleLayerUIDs},{...e,transferList:r})))}async getSprites(t){return await this._spriteSourcePromise,this._spriteMosaic.getSpriteItems(t)}getGlyphs(t){return this._glyphMosaic.getGlyphItems(t.font,t.codePoints)}async _getTilePayload(t,e,s){const i=b.A.pool.acquire(t.id),h=this._layer.sourceNameToSource[e],{level:n,row:a,col:o}=i;b.A.pool.release(i);try{return{protobuff:await h.requestTile(n,a,o,s),sourceName:e}}catch(t){if((0,r.zf)(t))throw t;return{protobuff:null,sourceName:e}}}async _getRefKeys(t,e){const s=this._layer.sourceNameToSource,i=new Array;for(const r in s){const h=s[r].getRefKey(t,e);i.push(h)}return(0,r.Lx)(i)}_getSourcesData(t,e,s){const i=[];for(let r=0;r<e.length;r++)if(null==e[r].value||null==t[r])i.push(null);else{const h=e[r].value,n=this._getTilePayload(h,t[r],s);i.push(n)}return(0,r.Lx)(i).then((t=>{const s={},i=[];for(let r=0;r<t.length;r++){const h=t[r].value;if(h&&h.protobuff&&h.protobuff.byteLength>0){const t=e[r].value.id;s[h.sourceName]={refKey:t,protobuff:h.protobuff},i.push(h.protobuff)}}return{sourceName2DataAndRefKey:s,transferList:i}}))}}},65523:(t,e,s)=>{s.d(e,{A:()=>n});var i=s(26574),r=s(62516),h=s(39156);class n extends r.A{constructor(){super(...arguments),this._fullCacheLodInfos=null,this._levelByScale={}}getTileParentId(t){const e=h.A.pool.acquire(t),s=0===e.level?null:h.A.getId(e.level-1,e.row>>1,e.col>>1,e.world);return h.A.pool.release(e),s}getTileCoverage(t,e,s=!0,i){const r=super.getTileCoverage(t,e,s,i);if(!r)return r;const h=1<<r.lodInfo.level;return r.spans=r.spans.filter((t=>t.row>=0&&t.row<h)),r}scaleToLevel(t){if(this._fullCacheLodInfos||this._initializeFullCacheLODs(this._lodInfos),this._levelByScale[t])return this._levelByScale[t];{const e=this._fullCacheLodInfos;if(t>e[0].scale)return e[0].level;let s,i;for(let r=0;r<e.length-1;r++)if(i=e[r+1],t>i.scale)return s=e[r],s.level+(s.scale-t)/(s.scale-i.scale);return e[e.length-1].level}}_initializeFullCacheLODs(t){let e;if(0===t[0].level)e=t.map((t=>({level:t.level,resolution:t.resolution,scale:t.scale})));else{const t=this.tileInfo.size[0],s=this.tileInfo.spatialReference;e=i.A.create({size:t,spatialReference:s}).lods.map((t=>({level:t.level,resolution:t.resolution,scale:t.scale})))}for(let t=0;t<e.length;t++)this._levelByScale[e[t].scale]=e[t].level;this._fullCacheLodInfos=e}}}}]);