"use strict";(self.webpackChunkarcgis_node=self.webpackChunkarcgis_node||[]).push([[3888,5390],{2296:(e,t,i)=>{i.d(t,{I:()=>v,b:()=>y});var n=i(77788),s=i(29592),r=i(31790),o=i(65630),a=i(78546),l=i(83660),d=i(21586),h=i(19635),c=i(41014),p=i(92624),u=i(19778),_=i(7782),m=i(33763);function y(e){const t=new p.N5,{vertex:i,fragment:y}=t;return(0,d.NB)(i,e),t.include(r.d,e),t.attributes.add(m.r.POSITION,"vec3"),t.attributes.add(m.r.UV0,"vec2"),e.perspectiveInterpolation&&t.attributes.add(m.r.PERSPECTIVEDIVIDE,"float"),t.varyings.add("vpos","vec3"),e.multipassEnabled&&t.varyings.add("depth","float"),i.code.add(c.H`
    void main(void) {
      vpos = position;
      ${e.multipassEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
      vTexCoord = uv0;
      gl_Position = transformPosition(proj, view, vpos);

      ${e.perspectiveInterpolation?"gl_Position *= perspectiveDivide;":""}
    }
  `),t.include(s.HQ,e),t.include(o.Q,e),y.uniforms.add(new u.N("tex",(e=>e.texture)),new h.m("opacity",(e=>e.opacity))),t.varyings.add("vTexCoord","vec2"),e.transparencyPassType===_.y.ColorAlpha&&(t.outputs.add("fragColor","vec4",0),t.outputs.add("fragAlpha","float",1)),y.include(l.a),y.code.add(c.H`
    void main() {
      discardBySlice(vpos);
      ${e.multipassEnabled?"terrainDepthTest(depth);":""}
      fragColor = texture(tex, vTexCoord) * opacity;

      if (fragColor.a < ${c.H.float(a.H)}) {
        discard;
      }

      fragColor = highlightSlice(fragColor, vpos);
      ${e.transparencyPassType===_.y.ColorAlpha?c.H`
              fragColor = premultiplyAlpha(fragColor);
              fragAlpha = fragColor.a;`:""}
      ${e.output===n.V.ObjectAndLayerIdColor?c.H`
              fragColor = vec4(0,0,0,1);`:""}
    }
    `),t}const v=Object.freeze(Object.defineProperty({__proto__:null,build:y},Symbol.toStringTag,{value:"Module"}))},45970:(e,t,i)=>{i.d(t,{O:()=>p,W:()=>c});var n=i(82541),s=i(79441),r=i(53334),o=i(80347);const a=(0,i(19913).vt)(),l=(0,s.vt)(),d=(0,s.vt)(),h=(0,s.vt)();function c(e,t,i){return(0,o.s)(a,t[0],t[1],1),(0,o.t)(a,a,(0,n.mg)(l,i)),0===a[2]?(0,r.hZ)(e,a[0],a[1]):(0,r.hZ)(e,a[0]/a[2],a[1]/a[2])}function p(e,t,i){return u(d,t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7]),u(h,i[0],i[1],i[2],i[3],i[4],i[5],i[6],i[7]),(0,n.lw)(e,(0,n.KC)(d,d),h),0!==e[8]&&(e[0]/=e[8],e[1]/=e[8],e[2]/=e[8],e[3]/=e[8],e[4]/=e[8],e[5]/=e[8],e[6]/=e[8],e[7]/=e[8],e[8]/=e[8]),e}function u(e,t,i,s,r,d,h,c,p){(0,n.hZ)(e,t,s,d,i,r,h,1,1,1),(0,o.s)(a,c,p,1),(0,n.KC)(l,e);const[u,_,m]=(0,o.t)(a,a,(0,n.mg)(l,l));return(0,n.hZ)(l,u,0,0,0,_,0,0,0,m),(0,n.lw)(e,l,e)}},13795:(e,t,i)=>{i.d(t,{b3:()=>c,jZ:()=>h});var n=i(84977),s=i(2532),r=i(70040),o=i(11021),a=i(56053),l=i(75981),d=i(67488);function h(e){return p(e,!0)}function c(e){return p(e,!1)}function p(e,t){if(null==e)return null;const i=e.spatialReference,s=(0,d.Vp)(i),o=(0,n.Wj)(e)?e.toJSON():e;if(!s)return o;const h=(0,d.K8)(i)?102100:4326,c=l.j7[h].maxX,p=l.j7[h].minX;if((0,a.fT)(o))return _(o,c,p);if((0,a.U9)(o))return o.points=o.points.map((e=>_(e,c,p))),o;if((0,a.ZC)(o))return u(o,s);if((0,a.Bi)(o)||(0,a.Rg)(o)){const e=(0,r.Rg)(x,o),i={xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3]},n=(0,l.kd)(i.xmin,p)*(2*c),s=0===n?o:(0,l.kS)(o,n);return i.xmin+=n,i.xmax+=n,i.xmax>c?g(s,c,t):i.xmin<p?g(s,p,t):s}return o}function u(e,t){if(!t)return e;const i=function(e,t){const i=[],{ymin:n,ymax:s,xmin:r,xmax:o}=e,a=e.xmax-e.xmin,[l,d]=t.valid,{x:h,frameId:c}=m(e.xmin,t),{x:p,frameId:u}=m(e.xmax,t),_=h===p&&a>0;if(a>2*d){const e={xmin:r<o?h:p,ymin:n,xmax:d,ymax:s},t={xmin:l,ymin:n,xmax:r<o?p:h,ymax:s},a={xmin:0,ymin:n,xmax:d,ymax:s},_={xmin:l,ymin:n,xmax:0,ymax:s},m=[],v=[];y(e,a)&&m.push(c),y(e,_)&&v.push(c),y(t,a)&&m.push(u),y(t,_)&&v.push(u);for(let e=c+1;e<u;e++)m.push(e),v.push(e);i.push(new f(e,[c]),new f(t,[u]),new f(a,m),new f(_,v))}else h>p||_?i.push(new f({xmin:h,ymin:n,xmax:d,ymax:s},[c]),new f({xmin:l,ymin:n,xmax:p,ymax:s},[u])):i.push(new f({xmin:h,ymin:n,xmax:p,ymax:s},[c]));return i}(e,t).map((e=>e.extent));return i.length<2?i[0]||e:i.length>2?(e.xmin=t.valid[0],e.xmax=t.valid[1],e):{rings:i.map((e=>[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]))}}function _(e,t,i){if(Array.isArray(e)){const n=e[0];if(n>t){const i=(0,l.kd)(n,t);e[0]=n+i*(-2*t)}else if(n<i){const t=(0,l.kd)(n,i);e[0]=n+t*(-2*i)}}else{const n=e.x;if(n>t){const i=(0,l.kd)(n,t);e.x+=i*(-2*t)}else if(n<i){const t=(0,l.kd)(n,i);e.x+=t*(-2*i)}}return e}function m(e,t){const[i,n]=t.valid,s=2*n;let r,o=0;return e>n?(r=Math.ceil(Math.abs(e-n)/s),e-=r*s,o=r):e<i&&(r=Math.ceil(Math.abs(e-i)/s),e+=r*s,o=-r),{x:e,frameId:o}}function y(e,t){const{xmin:i,ymin:n,xmax:s,ymax:r}=t;return v(e,i,n)&&v(e,i,r)&&v(e,s,r)&&v(e,s,n)}function v(e,t,i){return t>=e.xmin&&t<=e.xmax&&i>=e.ymin&&i<=e.ymax}function g(e,t,i=!0){const n=!(0,a.Rg)(e);if(n&&(0,o.m3)(e),i)return(new T).cut(e,t);const s=n?e.rings:e.paths,r=n?4:2,l=s.length,d=-2*t;for(let e=0;e<l;e++){const t=s[e];if(t&&t.length>=r){const e=[];for(const i of t)e.push([i[0]+d,i[1]]);s.push(e)}}return n?e.rings=s:e.paths=s,e}class f{constructor(e,t){this.extent=e,this.frameIds=t}}const x=(0,s.vt)();class T{constructor(){this._linesIn=[],this._linesOut=[]}cut(e,t){let i;if(this._xCut=t,e.rings)this._closed=!0,i=e.rings,this._minPts=4;else{if(!e.paths)return null;this._closed=!1,i=e.paths,this._minPts=2}for(const e of i){if(!e||e.length<this._minPts)continue;let t=!0;for(const i of e)t?(this.moveTo(i),t=!1):this.lineTo(i);this._closed&&this.close()}this._pushLineIn(),this._pushLineOut(),i=[];for(const e of this._linesIn)e&&e.length>=this._minPts&&i.push(e);const n=-2*this._xCut;for(const e of this._linesOut)if(e&&e.length>=this._minPts){for(const t of e)t[0]+=n;i.push(e)}return this._closed?e.rings=i:e.paths=i,e}moveTo(e){this._pushLineIn(),this._pushLineOut(),this._prevSide=this._side(e[0]),this._moveTo(e[0],e[1],this._prevSide),this._prevPt=e,this._firstPt=e}lineTo(e){const t=this._side(e[0]);if(t*this._prevSide==-1){const i=this._intersect(this._prevPt,e);this._lineTo(this._xCut,i,0),this._prevSide=0,this._lineTo(e[0],e[1],t)}else this._lineTo(e[0],e[1],t);this._prevSide=t,this._prevPt=e}close(){const e=this._firstPt,t=this._prevPt;e[0]===t[0]&&e[1]===t[1]||this.lineTo(e),this._checkClosingPt(this._lineIn),this._checkClosingPt(this._lineOut)}_moveTo(e,t,i){this._closed?(this._lineIn.push([i<=0?e:this._xCut,t]),this._lineOut.push([i>=0?e:this._xCut,t])):(i<=0&&this._lineIn.push([e,t]),i>=0&&this._lineOut.push([e,t]))}_lineTo(e,t,i){this._closed?(w(this._lineIn,i<=0?e:this._xCut,t),w(this._lineOut,i>=0?e:this._xCut,t)):i<0?(0===this._prevSide&&this._pushLineOut(),this._lineIn.push([e,t])):i>0?(0===this._prevSide&&this._pushLineIn(),this._lineOut.push([e,t])):this._prevSide<0?(this._lineIn.push([e,t]),this._lineOut.push([e,t])):this._prevSide>0&&(this._lineOut.push([e,t]),this._lineIn.push([e,t]))}_checkClosingPt(e){const t=e.length;t>3&&e[0][0]===this._xCut&&e[t-2][0]===this._xCut&&e[1][0]===this._xCut&&(e[0][1]=e[t-2][1],e.pop())}_side(e){return e<this._xCut?-1:e>this._xCut?1:0}_intersect(e,t){const i=(this._xCut-e[0])/(t[0]-e[0]);return e[1]+i*(t[1]-e[1])}_pushLineIn(){this._lineIn&&this._lineIn.length>=this._minPts&&this._linesIn.push(this._lineIn),this._lineIn=[]}_pushLineOut(){this._lineOut&&this._lineOut.length>=this._minPts&&this._linesOut.push(this._lineOut),this._lineOut=[]}}function w(e,t,i){const n=e.length;n>1&&e[n-1][0]===t&&e[n-2][0]===t?e[n-1][1]=i:e.push([t,i])}},31275:(e,t,i)=>{i.d(t,{_:()=>c});var n=i(82392),s=i(73783),r=i(81482),o=(i(6273),i(80861),i(67498),i(26325)),a=i(65648),l=i(34561),d=i(2532),h=i(13795);let c=class extends s.A{constructor(e){super(e)}get bounds(){const e=this.coords;return null==e?.extent?null:(0,d.VY)(e.extent)}get coords(){const e=this.element.georeference?.coords;return(0,l.projectOrLoad)(e,this.spatialReference).geometry}get normalizedCoords(){return a.A.fromJSON((0,h.jZ)(this.coords))}get normalizedBounds(){const e=null!=this.normalizedCoords?this.normalizedCoords.extent:null;return null!=e?(0,d.VY)(e):null}};(0,n._)([(0,r.MZ)()],c.prototype,"spatialReference",void 0),(0,n._)([(0,r.MZ)()],c.prototype,"element",void 0),(0,n._)([(0,r.MZ)()],c.prototype,"bounds",null),(0,n._)([(0,r.MZ)()],c.prototype,"coords",null),(0,n._)([(0,r.MZ)()],c.prototype,"normalizedCoords",null),(0,n._)([(0,r.MZ)()],c.prototype,"normalizedBounds",null),c=(0,n._)([(0,o.$)("esri.layers.support.MediaElementView")],c)},93766:(e,t,i)=>{i.d(t,{w:()=>h});var n=i(82392),s=i(70214),r=i(37623),o=i(61985),a=i(81482),l=(i(6273),i(80861),i(67498),i(26325)),d=i(4197);const h=e=>{let t=class extends e{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(){super.postscript(),(0,d.jI)(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}async _validateHeightModelInfo(){const e=new AbortController,t=e.signal;this.addHandles((0,s.hA)((()=>e.abort()))),await(0,o.C_)((()=>this.view.defaultsFromMap?.heightModelInfoReady),t),(0,r.Te)(t);const i=(0,d.Hu)(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(i)throw i}};return(0,n._)([(0,a.MZ)()],t.prototype,"view",void 0),(0,n._)([(0,a.MZ)()],t.prototype,"slicePlaneEnabled",void 0),t=(0,n._)([(0,l.$)("esri.views.3d.layers.LayerView3D")],t),t}},3888:(e,t,i)=>{i.r(t),i.d(t,{default:()=>F});var n=i(82392),s=i(62991),r=i(70214),o=(i(6273),i(45970)),a=i(37623),l=i(61985),d=i(81482),h=(i(80861),i(67498),i(26325)),c=i(79441),p=i(2532),u=i(31275),_=i(161),m=i(93766),y=i(73783),v=i(4506),g=i(57725),f=i(5262),x=i(94464),T=i(92374),w=i(53334),E=i(56560),b=i(68660),P=i(82795),O=i(92750),I=i(54500);const A=Symbol(),M=Symbol();let D=class extends y.A{get updating(){return this._updatingHandles.updating}get _preferredInteractionTool(){return this.options?.tool??"transform"}get _toolType(){switch(this._preferredInteractionTool){case"transform":return"transform-3d";case"reshape":return"reshape-3d"}}get _validatedSelectedElement(){const e=this.selectedElement;if(!e)return null;const{layer:{source:t}}=this;return t?"hasElement"in t?t.hasElement(e)?e:null:t===e?e:null:null}constructor(e){super(e),this.enabled=!1,this._updatingHandles=new b.U,this._isOpacityToggled=!1,this._factor=1,this._tool=null,this._object=null,this._createToolAbortController=null,this._onPointerMove=(0,a.sg)((async e=>{const t=await this._updatingHandles.addPromise(this._findElementAtScreenPoint(e));this.destroyed||(this.removeHandles(M),t&&t!==this.selectedElement&&(this.view.cursor="pointer",this.addHandles((0,r.hA)((()=>this.view.cursor=null)),M)))})),this._tmpMat2=(0,T.vt)(),this._tmpVec2=(0,E.vt)()}destroy(){this._createToolAbortController=(0,g.DC)(this._createToolAbortController)}initialize(){this.addHandles([(0,r.DQ)(this._updatingHandles),this._updatingHandles.add((()=>this.enabled),(e=>this._enableDisable(e)),l.Vh),this._updatingHandles.add((()=>this._preferredInteractionTool),(e=>this._preferredInteractionToolChanged(e)))])}_enableDisable(e){if(!e)return void this.removeHandles(A);this._dynamicImports();const{view:t}=this,i=new O.oe;i.add(O.TU.undo,(()=>{this._object?.operations?.undo(),this._object?.emit("modified-externally")})),i.add(O.TU.redo,(()=>{this._object?.operations?.redo(),this._object?.emit("modified-externally")})),i.addToggle(O.TU.preserveAspectRatio,(e=>{"transform-3d"===this._tool?.type&&(this._tool.preserveAspectRatio="key-down"===e.type)})),i.addToggle(O.TU.rotateIncrements,(e=>{"transform-3d"===this._tool?.type&&(this._tool.snapRotation="key-down"===e.type)})),i.add(O.TU.toggleOpacity,(()=>{const e=this._object?.element;e&&(e.opacity*=this._isOpacityToggled?2:.5,this._isOpacityToggled=!this._isOpacityToggled)})),i.add(O.TU.moveUp,(()=>this._move(0,this._factor))),i.add(O.TU.moveDown,(()=>this._move(0,-this._factor))),i.add(O.TU.moveRight,(()=>this._move(this._factor,0))),i.add(O.TU.moveLeft,(()=>this._move(-this._factor,0))),i.addToggle(O.TU.factorModifier,(e=>this._factor="key-down"===e.type?10:1)),this._isOpacityToggled=!1,this.addHandles([i.register(t,P.o.TOOL),(0,r.hA)((()=>{this._isOpacityToggled&&this.selectedElement&&(this.selectedElement.opacity*=2,this._isOpacityToggled=!1)})),t.on("immediate-click",(e=>this._onClick(e)),P.o.TOOL),t.on("pointer-move",(e=>this._onPointerMove(e).catch((()=>{}))),P.o.TOOL),this._updatingHandles.add((()=>this._validatedSelectedElement),((e,t)=>{t&&e!==t&&this._isOpacityToggled&&(t.opacity*=2,this._isOpacityToggled=!1),this._selectedElementChanged(e)}),l.Vh),(0,r.hA)((()=>{t.cursor=null,this._removeTool()}))],A)}async _onClick(e){await this._updatingHandles.addPromise(e.async((async()=>{const t=await this._findElementAtScreenPoint(e);this.destroyed||(t&&e.stopPropagation(),this.selectedElement=t,this.selectedElement&&(this.view.cursor=null))})))}async _selectedElementChanged(e){e?.georeference?this._object?.element!==e&&await this._updatingHandles.addPromise(this._recreateTool()):this._removeTool()}async _recreateTool(){this._createToolAbortController=(0,g.DC)(this._createToolAbortController),this._removeTool();const e=this._validatedSelectedElement;if(!e)return;const t=new AbortController;this._createToolAbortController=t;const{ManipulatedObject3DMediaElement:i,ExtentTransformTool:n,ReshapeTool3D:s}=await this._dynamicImports();if(t.signal.aborted)return;const{view:o,layer:a,_toolType:l}=this;switch(this._object=new i({view:o,layer:a,element:e,tool:this._preferredInteractionTool}),l){case"transform-3d":{this._tool=new n({view:o,object:this._object});const e=o.inputManager;e.isModifierKeyDown(O.TU.rotateIncrements.key)&&(this._tool.snapRotation=!0),e.isModifierKeyDown(O.TU.preserveAspectRatio.key)&&(this._tool.preserveAspectRatio=!0)}break;case"reshape-3d":{const e=(0,I.X)(o);this.addHandles(e,this._tool);const{snappingManager:t}=e;this._tool=new s({view:o,object:this._object,enableMidpoints:!1,enableZShape:!1,snappingManager:t,enableMoveObject:!1,autoHideManipulators:!0,enableDeleteVertices:!1})}}this.addHandles([(0,r.hA)((()=>{this._object=(0,g.pR)(this._object),this._tool&&(o.tools.remove(this._tool),this._tool=null)}))],this._tool),o.addAndActivateTool(this._tool)}_preferredInteractionToolChanged(e){const{_tool:t}=this;if(!t)return;if(this._toolType!==t.type)return void this._updatingHandles.addPromise(this._recreateTool());const{_object:i}=this;i&&(i.tool=e)}async _dynamicImports(){const[{ManipulatedObject3DMediaElement:e},{ExtentTransformTool:t,ReshapeTool3D:n}]=await Promise.all([Promise.all([i.e(3243),i.e(5799),i.e(9583)]).then(i.bind(i,89583)),Promise.all([i.e(3243),i.e(2101),i.e(5351),i.e(3052),i.e(4973),i.e(486),i.e(6022),i.e(2017),i.e(491),i.e(4125)]).then(i.bind(i,24125))]);return{ManipulatedObject3DMediaElement:e,ExtentTransformTool:t,ReshapeTool3D:n}}async _findElementAtScreenPoint(e){const t=(await this.view.hitTest(e,{include:[this.layer]})).results[0];return"media"===t?.type?t.element:null}_removeTool(){this._tool&&this.removeHandles(this._tool)}_move(e,t){const{view:i,_object:n}=this,s=n?.operations;if(!s)return;const r=i.overlayPixelSizeInMapUnits(i.pointsOfInterest.focus.location)*(0,f.GA)(i.spatialReference)/(0,f.GA)(s.data.spatialReference),{_tmpMat2:o,_tmpVec2:a}=this,l=(0,x.$0)(o,(0,v.kU)(360-this.view.camera.heading)),d=(0,w.hZ)(a,r*e,r*t);(0,w.l0)(d,d,l),s.move(d[0],d[1],0),n.emit("modified-externally")}};(0,n._)([(0,d.MZ)({constructOnly:!0})],D.prototype,"view",void 0),(0,n._)([(0,d.MZ)({constructOnly:!0})],D.prototype,"layer",void 0),(0,n._)([(0,d.MZ)()],D.prototype,"selectedElement",void 0),(0,n._)([(0,d.MZ)()],D.prototype,"enabled",void 0),(0,n._)([(0,d.MZ)()],D.prototype,"options",void 0),(0,n._)([(0,d.MZ)()],D.prototype,"updating",null),(0,n._)([(0,d.MZ)()],D.prototype,"_preferredInteractionTool",null),(0,n._)([(0,d.MZ)()],D.prototype,"_validatedSelectedElement",null),D=(0,n._)([(0,h.$)("esri.views.3d.layers.support.MediaLayerInteraction")],D);var C=i(14583),S=i(10941),R=i(53633),H=i(80561),V=i(35537),L=i(32573),Z=i(34402),N=i(33763),j=i(75390),U=i(24775);let z=class extends y.A{constructor(){super(...arguments),this.tool="transform"}};(0,n._)([(0,d.MZ)()],z.prototype,"tool",void 0),z=(0,n._)([(0,h.$)("esri.views.3d.layers.support.MediaLayerInteractionOptions")],z);const k=e=>{let t=class extends e{constructor(...e){super(...e),this.layer=null,this.interactive=!1,this.interactionOptions=new z,this.selectedElement=null}};return(0,n._)([(0,d.MZ)()],t.prototype,"layer",void 0),(0,n._)([(0,d.MZ)()],t.prototype,"interactive",void 0),(0,n._)([(0,d.MZ)()],t.prototype,"interactionOptions",void 0),(0,n._)([(0,d.MZ)()],t.prototype,"selectedElement",void 0),t=(0,n._)([(0,h.$)("esri.views.layers.MediaLayerView")],t),t};var W=i(96383),G=i(68716);let $=class extends((0,m.w)(k(U.A))){get interactive(){return this._interaction.enabled}set interactive(e){this._interaction&&(this._interaction.enabled=e)}get selectedElement(){return this._interaction.selectedElement}set selectedElement(e){this._interaction&&(this._interaction.selectedElement=e)}get visibleAtCurrentScale(){return(0,W.E5)(this.layer.effectiveScaleRange,this.view.terrainScale)}constructor(e){super(e),this.type="media-3d",this.drapeSourceType=_.Om.RasterImage,this.updatePolicy=Z.q.ASYNC,this._uidToElement=new Map,this._renderedElements=new Map,this._lastDrapingExtent=null,this._update=(0,a.sg)((async(e,t,i)=>{const n=await this._collectMediaElements(e,t,i);this._synchronizeRenderElements(n)}),0);const{view:t,layer:i}=e;this._interaction=new D({view:t,layer:i}),this.addHandles((0,l.wB)((()=>this.interactionOptions),(e=>this._interaction.options=e),l.pc))}initialize(){const{view:e,layer:t}=this;this._renderer=e.basemapTerrain.overlayManager.registerGeometryDrapeSource(this);const i=()=>this._updateWithLastDrapingExtent();this.addHandles([(0,r.hA)((()=>e.basemapTerrain.overlayManager.unregisterDrapeSource(this))),(0,l.on)((()=>t.effectiveSource),"change",i),(0,l.on)((()=>t.effectiveSource),"refresh",i)]),this._updatingHandles.add((()=>this.suspended),i)}setDrapingExtent(e,t){this._lastDrapingExtent={overlays:e,spatialReference:t},this._updateWithLastDrapingExtent()}getHit(e){const t=this._uidToElement.get(e);return t?{type:"media",element:t,layer:this.layer}:null}isUpdating(){return super.isUpdating()||this._interaction.updating}_updateWithLastDrapingExtent(){if(null==this._lastDrapingExtent||this.suspended)return void(this._renderer&&this._synchronizeRenderElements(new Set));const{overlays:e,spatialReference:t}=this._lastDrapingExtent;this._updatingHandles.addPromise(this._update(e,t).catch((()=>{})))}async _collectMediaElements(e,t,i){const n=this.layer.effectiveSource;return null==n?new Set:new Set((await Promise.all(e.map((e=>n.queryElements((0,p.w1)(e.extent,t),{signal:i}))))).flat())}_synchronizeRenderElements(e){this._synchronizeRenderElementsRemove(e),this._synchronizeRenderElementsAdd(e)}_synchronizeRenderElementsRemove(e){const t=[];this._renderedElements.forEach(((i,n)=>{e.has(n)||(null!=i.renderData&&t.push(i.renderData.renderGeometry),this._removeElement(n,i),this.emit("element-render-changed",{element:n}))}))}_synchronizeRenderElementsAdd(e){for(const t of e)this._renderedElements.has(t)||this._createRenderElement(t)}_removeElement(e,{renderData:t,handle:i}){this._destroyRenderData(e,t),this._renderedElements.delete(e),this._uidToElement.delete(e.uid),i.remove()}async _createRenderElement(e){const t=new u._({spatialReference:this.view.spatialReference,element:e}),i={renderData:null,handle:(0,r.vE)([this._updatingHandles.add((()=>e.opacity),(e=>{null!=i.renderData&&i.renderData.material.setParameters({opacity:e})})),this._updatingHandles.add((()=>t.coords),(()=>{null!=i.renderData?this._updateGeometry(t,i,i.renderData):this._initializeRenderData(t,i)})),this._updatingHandles.add((()=>e.content),(()=>this._initializeRenderData(t,i))),(0,r.DQ)(t)])};this._renderedElements.set(e,i),this._uidToElement.set(e.uid,e),this._updatingHandles.addPromise(e.load().catch((()=>{}))),this._initializeRenderData(t,i)}_initializeRenderData(e,t){const{coords:i,element:n}=e,{contentWidth:s,contentHeight:r}=n;if(null==i||null==n.content)return void(t.renderData=this._destroyRenderData(n,t.renderData));if(null!=t.renderData)return;const o=this._createTexture(n.content),l=o.load(this.view._stage.renderView.renderingContext);this.view._stage.add(o),(0,a.$X)(l)&&this._updatingHandles.addPromise(l);const d=new j.r({initTextureTransparent:!0,textureId:o.id,opacity:n.opacity,transparent:!0,perspectiveInterpolation:!0}),h=this._getPositionAttributeArray(i),c=this._getPerspectiveDivideAttributeArray(h,s,r),p=[0,1,2,0,2,3],u=new R.V(d,[[N.r.POSITION,new S.n(h,p,3,!0)],[N.r.UV0,new S.n([0,0,1,0,1,1,0,1],p,2,!0)],[N.r.PERSPECTIVEDIVIDE,new S.n(c,p,1,!0)]]),_=new V.$(u,{layerUid:this.layer.uid,graphicUid:n.uid});this._renderer.addGeometries([_],H.q.ADD),t.renderData={renderGeometry:_,texture:o,material:d},this.emit("element-render-changed",{element:n})}_updateGeometry(e,t,i){const{coords:n,element:s}=e;if(null==n||null==s.content)return void(t.renderData=this._destroyRenderData(s,t.renderData));const r=this._getPositionAttributeArray(n);i.renderGeometry.geometry.setAttributeData(N.r.POSITION,r);const o=this._getPerspectiveDivideAttributeArray(r,s.contentWidth,s.contentHeight);i.renderGeometry.geometry.setAttributeData(N.r.PERSPECTIVEDIVIDE,o),i.renderGeometry.geometry.invalidateBoundingInfo(),this._renderer.modifyGeometries([i.renderGeometry],H.k.GEOMETRY),this.emit("element-render-changed",{element:s})}_getPositionAttributeArray(e){const[t,i,n,s]=e.rings[0];return[t[0],t[1],C.bi,s[0],s[1],C.bi,n[0],n[1],C.bi,i[0],i[1],C.bi]}_getPerspectiveDivideAttributeArray(e,t,i){(0,o.O)(B,[0,0,t,0,t,i,0,i],[e[0],e[1],e[3],e[4],e[6],e[7],e[9],e[10]]);const n=B[6]/B[8]*t,s=B[7]/B[8]*i;return[1,1+n,1+n+s,1+s]}_destroyRenderData(e,t){if(null==t)return null;const i=t.texture;return i.unload(),this.view._stage.remove(i),this._renderer.removeGeometries([t.renderGeometry],H.q.REMOVE),this.emit("element-render-changed",{element:e}),null}_createTexture(e){const t=e instanceof HTMLImageElement?e.naturalWidth:e.width,i=e instanceof HTMLImageElement?e.naturalHeight:e.height;if("getFrame"in e)throw new s.A("media-layer-view-3d","animation is not supported");return new L.g(e,{wrap:{s:G.pF.CLAMP_TO_EDGE,t:G.pF.CLAMP_TO_EDGE},preMultiplyAlpha:!0,width:t,height:i,mipmap:!0,updateCallback:()=>this.view.basemapTerrain.overlayManager.setDrawTexturesDirty()})}get test(){}};(0,n._)([(0,d.MZ)({readOnly:!0})],$.prototype,"type",void 0),(0,n._)([(0,d.MZ)()],$.prototype,"layer",void 0),(0,n._)([(0,d.MZ)()],$.prototype,"interactive",null),(0,n._)([(0,d.MZ)()],$.prototype,"selectedElement",null),(0,n._)([(0,d.MZ)({readOnly:!0})],$.prototype,"visibleAtCurrentScale",null),$=(0,n._)([(0,h.$)("esri.views.3d.layers.MediaLayerView3D")],$);const B=(0,c.vt)(),F=$},75390:(e,t,i)=>{i.d(t,{r:()=>C});var n=i(40041),s=i(77788),r=i(10875),o=i(71678),a=i(31272),l=i(8445),d=i(15449),h=i(26421),c=i(33763),p=i(66356),u=i(83938),_=i(59615),m=i(29290),y=i(82392),v=(i(41014),i(21979)),g=i(19362),f=i(51662),x=i(24441),T=i(28116),w=i(7782),E=i(18693),b=i(2296),P=i(68716),O=i(15651);class I extends g.w{initializeProgram(e){return new x.B(e.rctx,I.shader.get().build(this.configuration),D)}_setPipelineState(e,t){const i=this.configuration,n=e===w.y.NONE,r=e===w.y.FrontFace;return(0,O.Ey)({blending:i.output===s.V.Color&&i.transparent?n?A:(0,l.ez)(e):null,culling:(0,O.Xt)(i.cullFace),depthTest:{func:(0,l.K_)(e)},depthWrite:n?i.writeDepth?O.kn:null:(0,l.XO)(e),drawBuffers:(0,l.cl)(e),colorWrite:O.wE,stencilWrite:i.hasOccludees?T.v0:null,stencilTest:i.hasOccludees?t?T.a9:T.qh:null,polygonOffset:n||r?null:(0,l.aB)(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._setPipelineState(this.configuration.transparencyPassType,!0),this._setPipelineState(this.configuration.transparencyPassType,!1)}getPipeline(e){return e?this._occludeePipelineState:super.getPipeline()}}I.shader=new v.$(b.I,(()=>i.e(9832).then(i.bind(i,19832))));const A=(0,O.ox)(P.dn.ONE,P.dn.ONE_MINUS_SRC_ALPHA);class M extends E.E{constructor(){super(...arguments),this.output=s.V.Color,this.cullFace=r.s2.None,this.hasSlicePlane=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.transparencyPassType=w.y.NONE,this.multipassEnabled=!1,this.cullAboveGround=!1,this.perspectiveInterpolation=!0}}(0,y._)([(0,f.W)({count:s.V.COUNT})],M.prototype,"output",void 0),(0,y._)([(0,f.W)({count:r.s2.COUNT})],M.prototype,"cullFace",void 0),(0,y._)([(0,f.W)()],M.prototype,"hasSlicePlane",void 0),(0,y._)([(0,f.W)()],M.prototype,"transparent",void 0),(0,y._)([(0,f.W)()],M.prototype,"enableOffset",void 0),(0,y._)([(0,f.W)()],M.prototype,"writeDepth",void 0),(0,y._)([(0,f.W)()],M.prototype,"hasOccludees",void 0),(0,y._)([(0,f.W)({count:w.y.COUNT})],M.prototype,"transparencyPassType",void 0),(0,y._)([(0,f.W)()],M.prototype,"multipassEnabled",void 0),(0,y._)([(0,f.W)()],M.prototype,"cullAboveGround",void 0),(0,y._)([(0,f.W)()],M.prototype,"perspectiveInterpolation",void 0),(0,y._)([(0,f.W)({constValue:!1})],M.prototype,"occlusionPass",void 0);const D=new Map([[c.r.POSITION,0],[c.r.UV0,2],[c.r.PERSPECTIVEDIVIDE,3]]);class C extends _.W{constructor(e){super(e,new H),this.supportsEdges=!0,this.produces=new Map([[d.N.OPAQUE_MATERIAL,e=>(0,s.u5)(e)||(0,s._o)(e)&&!this.parameters.transparent],[d.N.TRANSPARENT_MATERIAL,e=>(0,s._o)(e)&&this.parameters.transparent&&this.parameters.writeDepth],[d.N.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,e=>(0,s._o)(e)&&this.parameters.transparent&&!this.parameters.writeDepth],[d.N.DRAPED_MATERIAL,e=>(0,s._o)(e)||(0,s.u5)(e)]]),this._vertexAttributeLocations=D,this._configuration=new M}getConfiguration(e,t){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<l.xt,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.perspectiveInterpolation=this.parameters.perspectiveInterpolation,this._configuration}createGLMaterial(e){return new S(e)}createBufferWriter(){const e=u.zK.clone();return this.parameters.perspectiveInterpolation&&e.f32(c.r.PERSPECTIVEDIVIDE),new R(e)}}class S extends o.m{constructor(e){super({...e,...e.material.parameters})}_updateParameters(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(I,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&(this._material.setParameters({hasOccludees:e.hasOccludees}),this._updateParameters(e))}beginSlot(e){return this._output===s.V.Color&&this._updateOccludeeState(e),this._updateParameters(e)}}class R extends p.Z{write(e,t,i,s,r){for(const o of this.vertexBufferLayout.fields.keys()){const a=i.attributes.get(o);if(a)if(o===c.r.PERSPECTIVEDIVIDE){(0,h.vA)(1===a.size);const e=s.getField(o,n.Y$);e&&(0,m.uO)(a,e,r)}else(0,m.zC)(o,a,e,t,s,r)}}}class H extends a.qA{constructor(){super(...arguments),this.transparent=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.cullFace=r.s2.None,this.hasOccludees=!1,this.opacity=1,this.textureId=null,this.initTextureTransparent=!0,this.perspectiveInterpolation=!1}}},54500:(e,t,i)=>{i.d(t,{X:()=>u});var n=i(70214),s=i(71709),r=i(40377),o=i(61985),a=i(90876),l=i(51879),d=i(60586);var h=i(15464),c=i(40105);const p=new Map;function u(e){if(!p.has(e)){const t=function(e,t){const i=new d.A({enabled:!0,selfEnabled:!1,featureEnabled:!0,distance:t?.distance??l.N.distance,touchSensitivityMultiplier:t?.touchSensitivityMultiplier??l.N.touchSensitivityMultiplier});return{...(0,o.wB)((()=>e.map?.allLayers?.toArray()??[]),(e=>{i.featureSources=new r.A(e.map((e=>new a.A({layer:e}))))}),o.Vh),options:i}}(e,{distance:10}),i=function(e,t){return new c.g({view:e,options:t,snappingEnginesFactory:(t,i)=>[new h.f({view:e,spatialReference:e.spatialReference,options:i})]})}(e,t.options);p.set(e,{referenceCount:0,snappingManager:i,remove:()=>{t.remove(),i.destroy()}})}const t=p.get(e);t.referenceCount++;const i=(0,n.hA)((()=>function(e,t){t.referenceCount--,t.referenceCount>0||(0,s.d)((()=>{0===t.referenceCount&&(t.remove(),p.delete(e))}))}(e,t)));return{snappingManager:t.snappingManager,...i}}}}]);