"use strict";(self.webpackChunkarcgis_node=self.webpackChunkarcgis_node||[]).push([[5976],{53357:(e,t,i)=>{function s(){return new Float32Array(4)}function a(e){const t=new Float32Array(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function r(e,t,i,s){const a=new Float32Array(4);return a[0]=e,a[1]=t,a[2]=i,a[3]=s,a}function n(){return s()}function l(){return r(1,1,1,1)}function o(){return r(1,0,0,0)}function h(){return r(0,1,0,0)}function c(){return r(0,0,1,0)}function u(){return r(0,0,0,1)}i.d(t,{fA:()=>r,o8:()=>a});const d=n(),g=l(),p=o(),f=h(),_=c(),y=u();Object.freeze(Object.defineProperty({__proto__:null,ONES:g,UNIT_W:y,UNIT_X:p,UNIT_Y:f,UNIT_Z:_,ZEROS:d,clone:a,create:s,createView:function(e,t){return new Float32Array(e,t,4)},fromValues:r,ones:l,unitW:u,unitX:o,unitY:h,unitZ:c,zeros:n},Symbol.toStringTag,{value:"Module"}))},61866:(e,t,i)=>{i.d(t,{$:()=>s,s:()=>a});const s=15.5,a=1024},88317:(e,t,i)=>{i.d(t,{d:()=>S});var s=i(57725),a=i(37623),r=i(19759),n=i(73462),l=i(65020);class o{constructor(e,t){this._width=0,this._height=0,this._free=[],this._width=e,this._height=t,this._free.push(new l.A(0,0,e,t))}get width(){return this._width}get height(){return this._height}allocate(e,t){if(e>this._width||t>this._height)return new l.A;let i=null,s=-1;for(let a=0;a<this._free.length;++a){const r=this._free[a];e<=r.width&&t<=r.height&&(null===i||r.y<=i.y&&r.x<=i.x)&&(i=r,s=a)}return null===i?new l.A:(this._free.splice(s,1),i.width<i.height?(i.width>e&&this._free.push(new l.A(i.x+e,i.y,i.width-e,t)),i.height>t&&this._free.push(new l.A(i.x,i.y+t,i.width,i.height-t))):(i.width>e&&this._free.push(new l.A(i.x+e,i.y,i.width-e,i.height)),i.height>t&&this._free.push(new l.A(i.x,i.y+t,e,i.height-t))),new l.A(i.x,i.y,e,t))}release(e){for(let t=0;t<this._free.length;++t){const i=this._free[t];if(i.y===e.y&&i.height===e.height&&i.x+i.width===e.x)i.width+=e.width;else if(i.x===e.x&&i.width===e.width&&i.y+i.height===e.y)i.height+=e.height;else if(e.y===i.y&&e.height===i.height&&e.x+e.width===i.x)i.x=e.x,i.width+=e.width;else{if(e.x!==i.x||e.width!==i.width||e.y+e.height!==i.y)continue;i.y=e.y,i.height+=e.height}this._free.splice(t,1),this.release(e)}this._free.push(e)}}var h=i(68716),c=i(89958),u=i(88416);class d{constructor(e,t,i){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphIndex={},this._textures=[],this._rangePromises=new Map,this.width=e,this.height=t,this._glyphSource=i,this._binPack=new o(e-4,t-4),this._glyphData.push(new Uint8Array(e*t)),this._dirties.push(!0),this._textures.push(void 0)}getGlyphItems(e,t){const i=[],s=this._glyphSource,a=new Set,r=1/256;for(const e of t){const t=Math.floor(e*r);a.add(t)}const n=[];return a.forEach((t=>{const i=e+t;if(this._rangePromises.has(i))n.push(this._rangePromises.get(i));else{const a=s.getRange(e,t).then((()=>{this._rangePromises.delete(i)}),(()=>{this._rangePromises.delete(i)}));this._rangePromises.set(i,a),n.push(a)}})),Promise.all(n).then((()=>{let a=this._glyphIndex[e];a||(a={},this._glyphIndex[e]=a);for(const r of t){const t=a[r];if(t){i[r]={sdf:!0,rect:t.rect,metrics:t.metrics,page:t.page,code:r};continue}const n=s.getGlyph(e,r);if(!n?.metrics)continue;const h=n.metrics;let c;if(0===h.width)c=new l.A(0,0,0,0);else{const e=3,t=h.width+2*e,i=h.height+2*e;let s=t%4?4-t%4:4,a=i%4?4-i%4:4;1===s&&(s=5),1===a&&(a=5),c=this._binPack.allocate(t+s,i+a),c.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(void 0),this._binPack=new o(this.width-4,this.height-4),c=this._binPack.allocate(t+s,i+a));const r=this._glyphData[this._currentPage],l=n.bitmap;let u,d;if(l)for(let e=0;e<i;e++){u=t*e,d=this.width*(c.y+e+1)+c.x;for(let e=0;e<t;e++)r[d+e+1]=l.at(u+e)}}a[r]={rect:c,metrics:h,tileIDs:null,page:this._currentPage},i[r]={sdf:!0,rect:c,metrics:h,page:this._currentPage,code:r},this._dirties[this._currentPage]=!0}return i}))}removeGlyphs(e){for(const t in this._glyphIndex){const i=this._glyphIndex[t];if(!i)continue;let s;for(const t in i)if(s=i[t],s.tileIDs.delete(e),0===s.tileIDs.size){const e=this._glyphData[s.page],a=s.rect;let r,n;for(let t=0;t<a.height;t++)for(r=this.width*(a.y+t)+a.x,n=0;n<a.width;n++)e[r+n]=0;delete i[t],this._dirties[s.page]=!0}}}bind(e,t,i,s=0){if(!this._textures[i]){const t=new u.R;t.pixelFormat=h.Ab.ALPHA,t.wrapMode=h.pF.CLAMP_TO_EDGE,t.width=this.width,t.height=this.height,this._textures[i]=new c.g(e,t,new Uint8Array(this.width*this.height))}const a=this._textures[i];a.setSamplingMode(t),this._dirties[i]&&a.setData(this._glyphData[i]),e.bindTexture(a,s),this._dirties[i]=!1}destroy(){this.dispose()}dispose(){this._glyphData.length=0,this._binPack=null;for(const e of this._textures)e&&e.dispose();this._textures.length=0}}var g=i(38116),p=i(16269);class f{constructor(e){if(this._metrics=[],!e)return void(this._allBitmaps=null);const t=new Map;let i=0;for(;e.next();)switch(e.tag()){case 1:{const s=e.getMessage();for(;s.next();)switch(s.tag()){case 3:{const e=s.getMessage();let a,r,n,l,o,h,c;for(;e.next();)switch(e.tag()){case 1:a=e.getUInt32();break;case 2:r=e.getBytes();break;case 3:n=e.getUInt32();break;case 4:l=e.getUInt32();break;case 5:o=e.getSInt32();break;case 6:h=e.getSInt32();break;case 7:c=e.getUInt32();break;default:e.skip()}if(e.release(),a){const e=r?.length??0;this._metrics[a]={width:n,height:l,left:o,top:h,advance:c,startOffset:i,length:e},t.set(a,r),i+=e}break}default:s.skip()}s.release();break}default:e.skip()}const s=new Uint8Array(i),a=this._metrics;for(const[e,i]of t){const{startOffset:t,length:r}=a[e];if(i)for(let e=0;e<r;++e)s[t+e]=i[e]}this._allBitmaps=s}getMetrics(e){return this._metrics[e]}getBitmap(e){if(!this._allBitmaps)return;const t=this._metrics[e];if(void 0===t)return;const{startOffset:i,length:s}=t;return 0!==s?new m(this._allBitmaps,i,s):void 0}}class _{constructor(){this._ranges=[]}get ranges(){return this._ranges}getRange(e){return this._ranges[e]}addRange(e,t){this._ranges[e]=t}}class y{constructor(e){this._glyphInfo={},this._baseURL=e}getRange(e,t){const i=this._getFontStack(e);if(i.getRange(t))return Promise.resolve();const s=256*t,a=s+255;if(this._baseURL){const r=this._baseURL.replace("{fontstack}",e).replace("{range}",s+"-"+a);return(0,g.A)(r,{responseType:"array-buffer"}).then((e=>{i.addRange(t,new f(new p.A(new Uint8Array(e.data),new DataView(e.data))))})).catch((()=>{i.addRange(t,new f)}))}return i.addRange(t,new f),Promise.resolve()}getGlyph(e,t){const i=this._getFontStack(e);if(!i)return;const s=Math.floor(t/256),a=i.getRange(s);return a?{metrics:a.getMetrics(t),bitmap:a.getBitmap(t)}:void 0}_getFontStack(e){let t=this._glyphInfo[e];return t||(t=this._glyphInfo[e]=new _),t}}class m{constructor(e,t,i){this._array=e,this._start=t,this.length=i}at(e){return 0<=e&&e<this.length?this._array[this._start+e]:void 0}}i(6273);var v=i(73356);class w{constructor(e,t,i=0){this._size=[],this._mosaicsData=[],this._textures=[],this._dirties=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects={},this.pixelRatio=1,t<=0&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=e,this._pageHeight=t,i>0&&(this._maxItemSize=i),this._binPack=new o(e-4,t-4)}destroy(){this.dispose()}dispose(){this._binPack=null,this._mosaicsData.length=0,this._mosaicRects={};for(const e of this._textures)e&&e.dispose();this._textures.length=0}getWidth(e){return e>=this._size.length?-1:this._size[e][0]}getHeight(e){return e>=this._size.length?-1:this._size[e][1]}getPageSize(e){return e>=this._size.length?null:this._size[e]}setSpriteSource(e){if(this.dispose(),this.pixelRatio=e.devicePixelRatio,0===this._mosaicsData.length){this._binPack=new o(this._pageWidth-4,this._pageHeight-4);const e=Math.floor(this._pageWidth),t=Math.floor(this._pageHeight),i=new Uint32Array(e*t);this._mosaicsData[0]=i,this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0)}this._sprites=e}getSpriteItem(e,t=!1){let i,s,a=this._mosaicRects[e];if(a)return a;if(!this._sprites||"loaded"!==this._sprites.loadStatus)return null;if(e&&e.startsWith("dasharray-")?([i,s]=this._rasterizeDash(e),t=!0):i=this._sprites.getSpriteInfo(e),!i?.width||!i.height||i.width<0||i.height<0)return null;const r=i.width,n=i.height,[l,o,h]=this._allocateImage(r,n);return l.width<=0?null:(this._copy(l,i,o,h,t,s),a={type:"sprite",rect:l,width:r,height:n,sdf:i.sdf,simplePattern:!1,rasterizationScale:i.pixelRatio,page:o},this._mosaicRects[e]=a,a)}getSpriteItems(e){const t={};for(const i of e)t[i.name]=this.getSpriteItem(i.name,i.repeat);return t}getMosaicItemPosition(e,t){const i=this.getSpriteItem(e,t),s=i?.rect;if(!s)return null;s.width=i.width,s.height=i.height;const a=i.width,r=i.height;return{tl:[s.x+2,s.y+2],br:[s.x+2+a,s.y+2+r],page:i.page}}bind(e,t,i=0,s=0){if(i>=this._size.length||i>=this._mosaicsData.length)return;if(!this._textures[i]){const t=new u.R;t.wrapMode=h.pF.CLAMP_TO_EDGE,t.width=this._size[i][0],t.height=this._size[i][1],this._textures[i]=new c.g(e,t,new Uint8Array(this._mosaicsData[i].buffer))}const a=this._textures[i];a.setSamplingMode(t),this._dirties[i]&&a.setData(new Uint8Array(this._mosaicsData[i].buffer)),e.bindTexture(a,s),this._dirties[i]=!1}static _copyBits(e,t,i,s,a,r,n,l,o,h,c){let u=s*t+i,d=l*r+n;if(c){d-=r;for(let n=-1;n<=h;n++,u=((n+h)%h+s)*t+i,d+=r)for(let t=-1;t<=o;t++)a[d+t]=e[u+(t+o)%o]}else for(let i=0;i<h;i++){for(let t=0;t<o;t++)a[d+t]=e[u+t];u+=t,d+=r}}_copy(e,t,i,s,a,r){if(!this._sprites||"loaded"!==this._sprites.loadStatus||i>=this._mosaicsData.length)return;const n=new Uint32Array(r?r.buffer:this._sprites.image.buffer),l=this._mosaicsData[i],o=r?t.width:this._sprites.width;w._copyBits(n,o,t.x,t.y,l,s[0],e.x+2,e.y+2,t.width,t.height,a),this._dirties[i]=!0}_allocateImage(e,t){e+=2,t+=2;const i=Math.max(e,t);if(this._maxItemSize&&this._maxItemSize<i){const i=new l.A(0,0,e,t);return this._mosaicsData.push(new Uint32Array(e*t)),this._dirties.push(!0),this._size.push([e,t]),this._textures.push(void 0),[i,this._mosaicsData.length-1,[e,t]]}let s=e%4?4-e%4:4,a=t%4?4-t%4:4;1===s&&(s=5),1===a&&(a=5);const r=this._binPack.allocate(e+s,t+a);return r.width<=0?(this._dirties[this._currentPage]||(this._mosaicsData[this._currentPage]=null),this._currentPage=this._mosaicsData.length,this._mosaicsData.push(new Uint32Array(this._pageWidth*this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0),this._binPack=new o(this._pageWidth-4,this._pageHeight-4),this._allocateImage(e,t)):[r,this._currentPage,[this._pageWidth,this._pageHeight]]}_rasterizeDash(e){const t=e.match(/\[(.*?)\]/);if(!t)return null;const i=t[1].split(",").map(Number),s=e.slice(e.lastIndexOf("-")+1),[a,r,n]=(0,v.k)(i,s);return[{x:0,y:0,width:r,height:n,sdf:!0,pixelRatio:1},new Uint8Array(a.buffer)]}}var M=i(39156);class S{constructor(e,t,i,s){this._layer=e,this._styleRepository=t,this.devicePixelRatio=i,this._sourceDataMaxLOD=s,this._spriteMosaic=null,this._glyphMosaic=null,this._connection=null,this._spriteSourceAbortController=null,this._startOptionsInputSignal=null,this._inputSignalEventListener=null}destroy(){this._connection?.close(),this._connection=null,this._styleRepository=null,this._layer=null,this._spriteMosaic?.destroy(),this._spriteMosaic=null,this._glyphMosaic=null,this._spriteSourceAbortController=(0,s.DC)(this._spriteSourceAbortController),this._spriteSourcePromise=null,this._inputSignalEventListener&&this._startOptionsInputSignal?.removeEventListener("abort",this._inputSignalEventListener),this._startOptionsInputSignal=null,this._inputSignalEventListener=null}get spriteMosaic(){return this._spriteSourcePromise.then((()=>this._spriteMosaic))}get glyphMosaic(){return this._glyphMosaic}async start(e){this._requestSprite(e);const t=this._layer.currentStyleInfo.glyphsUrl,i=new y(t?(0,r.a6)(t,{...this._layer.customParameters,token:this._layer.apiKey}):null);this._glyphMosaic=new d(1024,1024,i),this._broadcastPromise=(0,n.ho)("WorkerTileHandler",{client:this,schedule:e.schedule,signal:e.signal}).then((t=>{if(this._layer&&(this._connection?.close(),this._connection=t,this._layer&&!this._connection.closed)){const i=t.broadcast("setStyle",{style:this._layer.currentStyleInfo.style,sourceDataMaxLOD:this._sourceDataMaxLOD},e);Promise.all(i).catch((e=>(0,a.jH)(e)))}}))}_requestSprite(e){this._spriteSourceAbortController?.abort();const t=new AbortController;this._spriteSourceAbortController=t;const i=e?.signal;this._inputSignalEventListener&&this._startOptionsInputSignal?.removeEventListener("abort",this._inputSignalEventListener),this._startOptionsInputSignal=null,i&&(this._inputSignalEventListener=function(e){return()=>e.abort()}(t),i.addEventListener("abort",this._inputSignalEventListener,{once:!0}));const{signal:s}=t,r={...e,signal:s};this._spriteSourcePromise=this._layer.loadSpriteSource(this.devicePixelRatio,r),this._spriteSourcePromise.then((e=>{(0,a.QP)(s),this._spriteMosaic=new w(1024,1024,250),this._spriteMosaic.setSpriteSource(e)}))}async updateStyle(e){return await this._broadcastPromise,this._broadcastPromise=Promise.all(this._connection.broadcast("updateStyle",e)),this._broadcastPromise}setSpriteSource(e){const t=new w(1024,1024,250);return t.setSpriteSource(e),this._spriteMosaic=t,this._spriteSourcePromise=Promise.resolve(e),this._spriteSourceAbortController=null,t}async setStyle(e,t,i){await this._broadcastPromise,this._styleRepository=e,this._sourceDataMaxLOD=i,this._requestSprite();const s=new y(this._layer.currentStyleInfo.glyphsUrl?(0,r.a6)(this._layer.currentStyleInfo.glyphsUrl,{...this._layer.customParameters,token:this._layer.apiKey}):null);return this._glyphMosaic=new d(1024,1024,s),this._broadcastPromise=Promise.all(this._connection.broadcast("setStyle",{style:t,sourceDataMaxLOD:this._sourceDataMaxLOD})),this._broadcastPromise}async fetchTileData(e,t){const i=await this._getRefKeys(e,t);return this._getSourcesData(Object.keys(this._layer.sourceNameToSource),i,t)}async fetchTilePBFs(e){const t=Object.keys(this._layer.sourceNameToSource),i={},s=await this._getRefKeys(e,i),a=[],r=[];for(let e=0;e<s.length;e++)if(null==s[e].value||null==t[e])r.push(null);else{const n=s[e].value,l=this._getTilePayload(n,t[e],i);l.then((e=>{a.push({...e,key:n})})),r.push(l)}return Promise.all(r).then((()=>a))}async parseTileData(e,t){const i=e&&e.data;if(!i)return null;const{sourceName2DataAndRefKey:s,transferList:a}=i;return 0===Object.keys(s).length?null:this._broadcastPromise.then((()=>this._connection.invoke("createTileAndParse",{key:e.key.id,sourceName2DataAndRefKey:s,styleLayerUIDs:e.styleLayerUIDs},{...t,transferList:a})))}async getSprites(e){return await this._spriteSourcePromise,this._spriteMosaic.getSpriteItems(e)}getGlyphs(e){return this._glyphMosaic.getGlyphItems(e.font,e.codePoints)}async _getTilePayload(e,t,i){const s=M.A.pool.acquire(e.id),r=this._layer.sourceNameToSource[t],{level:n,row:l,col:o}=s;M.A.pool.release(s);try{return{protobuff:await r.requestTile(n,l,o,i),sourceName:t}}catch(e){if((0,a.zf)(e))throw e;return{protobuff:null,sourceName:t}}}async _getRefKeys(e,t){const i=this._layer.sourceNameToSource,s=new Array;for(const a in i){const r=i[a].getRefKey(e,t);s.push(r)}return(0,a.Lx)(s)}_getSourcesData(e,t,i){const s=[];for(let a=0;a<t.length;a++)if(null==t[a].value||null==e[a])s.push(null);else{const r=t[a].value,n=this._getTilePayload(r,e[a],i);s.push(n)}return(0,a.Lx)(s).then((e=>{const i={},s=[];for(let a=0;a<e.length;a++){const r=e[a].value;if(r&&r.protobuff&&r.protobuff.byteLength>0){const e=t[a].value.id;i[r.sourceName]={refKey:e,protobuff:r.protobuff},s.push(r.protobuff)}}return{sourceName2DataAndRefKey:i,transferList:s}}))}}},10514:(e,t,i)=>{i.d(t,{p6:()=>l,wV:()=>n});Math.PI;const s=256/360,a=1/Math.LN2;function r(e,t){return(e%=t)>=0?e:e+t}function n(e){return r(e*s,256)}function l(e){return Math.log(e)*a}},71477:(e,t,i)=>{i.d(t,{A:()=>s});class s{constructor(){this.name=this.constructor.name||"UnnamedBrush",this.brushEffect=null}prepareState(e,t){}draw(e,t,i){}drawMany(e,t,i){for(const s of t)s.visible&&this.draw(e,s,i)}}},59583:(e,t,i)=>{i.d(t,{F:()=>u});var s=i(4506),a=i(93446),r=i(53357),n=i(6538),l=i(71477),o=i(89325),h=i(68716),c=i(40866);class u extends l.A{constructor(){super(...arguments),this._color=(0,r.fA)(1,0,0,1),this._patternMatrix=(0,a.vt)(),this._programOptions={id:!1,pattern:!1}}dispose(){this._vao&&(this._vao.dispose(),this._vao=null)}drawMany(e,t){const{context:i,painter:a,requestRender:r,allowDelayedRender:l}=e;this._loadWGLResources(e);const o=e.displayLevel,c=e.styleLayer,u=c.backgroundMaterial,d=a.vectorTilesMaterialManager,g=c.getPaintValue("background-color",o),p=c.getPaintValue("background-opacity",o),f=c.getPaintValue("background-pattern",o),_=void 0!==f,y=1|window.devicePixelRatio,m=e.spriteMosaic;let v,w;const M=y>n.C_?2:1,S=this._programOptions;S.pattern=_;const x=d.getMaterialProgram(i,u,S);if(!l||null==r||x.compiled){if(i.bindVAO(this._vao),i.useProgram(x),_){const e=m.getMosaicItemPosition(f,!0);if(null!=e){const{tl:t,br:s,page:a}=e;v=s[0]-t[0],w=s[1]-t[1];const r=m.getPageSize(a);null!=r&&(m.bind(i,h.Cj.LINEAR,a,n.$U),x.setUniform4f("u_tlbr",t[0],t[1],s[0],s[1]),x.setUniform2fv("u_mosaicSize",r),x.setUniform1i("u_texture",n.$U))}x.setUniform1f("u_opacity",p)}else{const e=g[3]*p;this._color[0]=e*g[0],this._color[1]=e*g[1],this._color[2]=e*g[2],this._color[3]=e,x.setUniform4fv("u_color",this._color)}x.setUniform1f("u_depth",c.z||0);for(const e of t){if(x.setUniform1f("u_coord_range",e.rangeX),x.setUniformMatrix3fv("u_dvsMat3",e.transforms.displayViewScreenMat3),_){const t=Math.max(2**(Math.round(o)-e.key.level),1),i=M*e.width*t,a=i/(0,s.yR)(v),r=i/(0,s.yR)(w);this._patternMatrix[0]=a,this._patternMatrix[4]=r,x.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}i.setStencilFunction(h.MT.EQUAL,0,255),i.drawArrays(h.WR.TRIANGLE_STRIP,0,4)}}else r()}_loadWGLResources(e){if(this._vao)return;const{context:t,styleLayer:i}=e,s=i.backgroundMaterial,a=new Int8Array([0,0,1,0,0,1,1,1]),r=o.g.createVertex(t,h._U.STATIC_DRAW,a),n=new c.Z(t,s.getAttributeLocations(),s.getLayoutInfo(),{geometry:r});this._vao=n}}},34031:(e,t,i)=>{i.d(t,{p:()=>n});var s=i(3947),a=i(71477),r=i(68716);class n extends a.A{constructor(){super(...arguments),this._programOptions={id:!1}}dispose(){}drawMany(e,t){const{context:i,displayLevel:a,requiredLevel:n,state:l,painter:o,spriteMosaic:h,styleLayerUID:c,requestRender:u,allowDelayedRender:d}=e;if(!t.some((e=>e.layerData.get(c)?.circleIndexCount??!1)))return;const g=e.styleLayer,p=g.circleMaterial,f=o.vectorTilesMaterialManager,_=g.getPaintValue("circle-translate",a),y=g.getPaintValue("circle-translate-anchor",a),m=this._programOptions,v=f.getMaterialProgram(i,p,m);if(d&&null!=u&&!v.compiled)return void u();i.useProgram(v),v.setUniformMatrix3fv("u_displayMat3",y===s.Cq.VIEWPORT?l.displayMat3:l.displayViewMat3),v.setUniform2fv("u_circleTranslation",_),v.setUniform1f("u_depth",g.z),v.setUniform1f("u_antialiasingWidth",1.2);let w=-1;for(const e of t){if(!e.layerData.has(c))continue;e.key.level!==w&&(w=e.key.level,p.setDataUniforms(v,a,g,w,h));const t=e.layerData.get(c);if(!t.circleIndexCount)continue;t.prepareForRendering(i);const s=t.vao;null!=s&&(i.bindVAO(s),v.setUniformMatrix3fv("u_dvsMat3",e.transforms.displayViewScreenMat3),n!==e.key.level?i.setStencilFunction(r.MT.EQUAL,e.stencilRef,255):i.setStencilFunction(r.MT.GREATER,255,255),i.drawElements(r.WR.TRIANGLES,t.circleIndexCount,r.pe.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t.circleIndexStart),e.triangleCount+=t.circleIndexCount/3)}}}},94222:(e,t,i)=>{i.d(t,{I:()=>o});var s=i(3947),a=i(6538),r=i(71477),n=i(68716);const l=1/65536;class o extends r.A{constructor(){super(...arguments),this._fillProgramOptions={id:!1,pattern:!1},this._outlineProgramOptions={id:!1}}dispose(){}drawMany(e,t){const{displayLevel:i,renderPass:s,spriteMosaic:a,styleLayerUID:r}=e;let n=!1;for(const e of t)if(e.layerData.has(r)){const t=e.layerData.get(r);if(t.fillIndexCount>0||t.outlineIndexCount>0){n=!0;break}}if(!n)return;const l=e.styleLayer,o=l.getPaintProperty("fill-pattern"),h=void 0!==o,c=h&&o.isDataDriven;let u;if(h&&!c){const e=o.getValue(i);u=a.getMosaicItemPosition(e,!0)}const d=!h&&l.getPaintValue("fill-antialias",i);let g=!0,p=1;if(!h){const e=l.getPaintProperty("fill-color"),t=l.getPaintProperty("fill-opacity");if(!e?.isDataDriven&&!t?.isDataDriven){const e=l.getPaintValue("fill-color",i);p=l.getPaintValue("fill-opacity",i)*e[3],p>=1&&(g=!1)}}if(g&&"opaque"===s)return;const f=l.getPaintValue("fill-translate",i),_=l.getPaintValue("fill-translate-anchor",i);(g||"translucent"!==s)&&this._drawFill(e,r,l,t,f,_,h,u,c);const y=!l.hasDataDrivenOutlineColor&&l.outlineUsesFillColor&&p<1;d&&"opaque"!==s&&!y&&this._drawOutline(e,r,l,t,f,_)}_drawFill(e,t,i,r,o,h,c,u,d){if(c&&!d&&null==u)return;const{context:g,displayLevel:p,state:f,painter:_,pixelRatio:y,spriteMosaic:m,requestRender:v,allowDelayedRender:w}=e,M=i.fillMaterial,S=_.vectorTilesMaterialManager,x=y>a.C_?2:1,P=this._fillProgramOptions;P.pattern=c;const I=S.getMaterialProgram(g,M,P);if(w&&null!=v&&!I.compiled)return void v();if(g.useProgram(I),null!=u){const{page:e}=u,t=m.getPageSize(e);null!=t&&(m.bind(g,n.Cj.LINEAR,e,a.$U),I.setUniform2fv("u_mosaicSize",t),I.setUniform1i("u_texture",a.$U))}I.setUniformMatrix3fv("u_displayMat3",h===s.Cq.VIEWPORT?f.displayMat3:f.displayViewMat3),I.setUniform2fv("u_fillTranslation",o),I.setUniform1f("u_depth",i.z+l);let R=-1;for(const e of r){if(!e.layerData.has(t))continue;e.key.level!==R&&(R=e.key.level,M.setDataUniforms(I,p,i,R,m));const s=e.layerData.get(t);if(!s.fillIndexCount)continue;s.prepareForRendering(g);const r=s.fillVAO;if(null!=r){if(g.bindVAO(r),I.setUniformMatrix3fv("u_dvsMat3",e.transforms.displayViewScreenMat3),g.setStencilFunction(n.MT.EQUAL,e.stencilRef,255),c){const t=Math.max(2**(Math.round(p)-e.key.level),1),i=e.rangeX/(x*e.width*t);I.setUniform1f("u_patternFactor",i)}if(d){const e=s.patternMap;if(!e)continue;for(const[t,i]of e){const e=m.getPageSize(t);null!=e&&(m.bind(g,n.Cj.LINEAR,t,a.$U),I.setUniform2fv("u_mosaicSize",e),I.setUniform1i("u_texture",a.$U),g.drawElements(n.WR.TRIANGLES,i[1],n.pe.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*i[0]))}}else g.drawElements(n.WR.TRIANGLES,s.fillIndexCount,n.pe.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*s.fillIndexStart);e.triangleCount+=s.fillIndexCount/3}}}_drawOutline(e,t,i,a,r,o){const{context:h,displayLevel:c,state:u,painter:d,pixelRatio:g,spriteMosaic:p,requestRender:f,allowDelayedRender:_}=e,y=i.outlineMaterial,m=d.vectorTilesMaterialManager,v=.75/g,w=this._outlineProgramOptions,M=m.getMaterialProgram(h,y,w);if(_&&null!=f&&!M.compiled)return void f();h.useProgram(M),M.setUniformMatrix3fv("u_displayMat3",o===s.Cq.VIEWPORT?u.displayMat3:u.displayViewMat3),M.setUniform2fv("u_fillTranslation",r),M.setUniform1f("u_depth",i.z+l),M.setUniform1f("u_outline_width",v);let S=-1;for(const e of a){if(!e.layerData.has(t))continue;e.key.level!==S&&(S=e.key.level,y.setDataUniforms(M,c,i,S,p));const s=e.layerData.get(t);if(s.prepareForRendering(h),!s.outlineIndexCount)continue;const a=s.outlineVAO;null!=a&&(h.bindVAO(a),M.setUniformMatrix3fv("u_dvsMat3",e.transforms.displayViewScreenMat3),h.setStencilFunction(n.MT.EQUAL,e.stencilRef,255),h.drawElements(n.WR.TRIANGLES,s.outlineIndexCount,n.pe.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*s.outlineIndexStart),e.triangleCount+=s.outlineIndexCount/3)}}}},56433:(e,t,i)=>{i.d(t,{$:()=>l});var s=i(3947),a=i(6538),r=i(71477),n=i(68716);class l extends r.A{constructor(){super(...arguments),this._programOptions={id:!1,pattern:!1,sdf:!1}}dispose(){}drawMany(e,t){const{context:i,displayLevel:r,state:l,painter:o,pixelRatio:h,spriteMosaic:c,styleLayerUID:u,requestRender:d,allowDelayedRender:g}=e;if(!t.some((e=>e.layerData.get(u)?.lineIndexCount??!1)))return;const p=e.styleLayer,f=p.lineMaterial,_=o.vectorTilesMaterialManager,y=p.getPaintValue("line-translate",r),m=p.getPaintValue("line-translate-anchor",r),v=p.getPaintProperty("line-pattern"),w=void 0!==v,M=w&&v.isDataDriven;let S,x;if(w&&!M){const e=v.getValue(r);S=c.getMosaicItemPosition(e)}let P=!1;if(!w){const e=p.getPaintProperty("line-dasharray");if(x=void 0!==e,P=x&&e.isDataDriven,x&&!P){const t=e.getValue(r),i=p.getDashKey(t,p.getLayoutValue("line-cap",r));S=c.getMosaicItemPosition(i)}}const I=1/h,R=this._programOptions;R.pattern=w,R.sdf=x;const b=_.getMaterialProgram(i,f,R);if(g&&null!=d&&!b.compiled)return void d();if(i.useProgram(b),b.setUniformMatrix3fv("u_displayViewMat3",l.displayViewMat3),b.setUniformMatrix3fv("u_displayMat3",m===s.Cq.VIEWPORT?l.displayMat3:l.displayViewMat3),b.setUniform2fv("u_lineTranslation",y),b.setUniform1f("u_depth",p.z),b.setUniform1f("u_antialiasing",I),S&&null!=S){const{page:e}=S,t=c.getPageSize(e);null!=t&&(c.bind(i,n.Cj.LINEAR,e,a.$U),b.setUniform2fv("u_mosaicSize",t),b.setUniform1i("u_texture",a.$U))}let T=-1;for(const e of t){if(!e.layerData.has(u))continue;e.key.level!==T&&(T=e.key.level,f.setDataUniforms(b,r,p,T,c));const t=2**(r-T)/h;b.setUniform1f("u_zoomFactor",t);const s=e.layerData.get(u);if(!s.lineIndexCount)continue;s.prepareForRendering(i);const l=s.vao;if(null!=l){if(i.bindVAO(l),b.setUniformMatrix3fv("u_dvsMat3",e.transforms.displayViewScreenMat3),i.setStencilFunction(n.MT.EQUAL,e.stencilRef,255),M||P){const e=s.patternMap;if(!e)continue;for(const[t,s]of e){const e=c.getPageSize(t);null!=e&&(c.bind(i,n.Cj.LINEAR,t,a.$U),b.setUniform2fv("u_mosaicSize",e),b.setUniform1i("u_texture",a.$U),i.drawElements(n.WR.TRIANGLES,s[1],n.pe.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*s[0]))}}else i.drawElements(n.WR.TRIANGLES,s.lineIndexCount,n.pe.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*s.lineIndexStart);e.triangleCount+=s.lineIndexCount/3}}}}},30527:(e,t,i)=>{i.d(t,{P:()=>u});var s=i(14571),a=i(80522),r=i(3947),n=i(6538),l=i(10514),o=i(71477),h=i(68716);const c=1/65536;class u extends o.A{constructor(){super(...arguments),this._iconProgramOptions={id:!1,sdf:!1},this._sdfProgramOptions={id:!1},this._spritesTextureSize=(0,s.vt)()}dispose(){}drawMany(e,t){const i=e.styleLayer;this._drawIcons(e,i,t),this._drawText(e,i,t)}_drawIcons(e,t,i){const{context:s,displayLevel:o,painter:h,spriteMosaic:c,state:u,styleLayerUID:d,requestRender:g,allowDelayedRender:p}=e,f=t.iconMaterial,_=h.vectorTilesMaterialManager;let y,m=!1;for(const e of i)if(e.layerData.has(d)&&(y=e.layerData.get(d),y.iconPerPageElementsMap.size>0)){m=!0;break}if(!m)return;const v=t.getPaintValue("icon-translate",o),w=t.getPaintValue("icon-translate-anchor",o);let M=t.getLayoutValue("icon-rotation-alignment",o);M===r.I5.AUTO&&(M=t.getLayoutValue("symbol-placement",o)===r.kt.POINT?r.I5.VIEWPORT:r.I5.MAP);const S=M===r.I5.MAP,x=t.getLayoutValue("icon-keep-upright",o)&&S,P=y.isIconSDF,I=this._iconProgramOptions;I.sdf=P;const R=_.getMaterialProgram(s,f,I);if(p&&null!=g&&!R.compiled)return void g();s.useProgram(R),R.setUniformMatrix3fv("u_displayViewMat3",M===r.I5.MAP?u.displayViewMat3:u.displayMat3),R.setUniformMatrix3fv("u_displayMat3",w===r.Cq.VIEWPORT?u.displayMat3:u.displayViewMat3),R.setUniform2fv("u_iconTranslation",v),R.setUniform1f("u_depth",t.z),R.setUniform1f("u_mapRotation",(0,l.wV)(u.rotation)),R.setUniform1f("u_keepUpright",x?1:0),R.setUniform1f("u_level",10*o),R.setUniform1i("u_texture",n.$U),R.setUniform1f("u_fadeDuration",a.zk/1e3);let b=-1;for(const a of i){if(!a.layerData.has(d))continue;if(a.key.level!==b&&(b=a.key.level,f.setDataUniforms(R,o,t,b,c)),y=a.layerData.get(d),0===y.iconPerPageElementsMap.size)continue;y.prepareForRendering(s),y.updateOpacityInfo();const i=y.iconVAO;if(null!=i){s.bindVAO(i),R.setUniformMatrix3fv("u_dvsMat3",a.transforms.displayViewScreenMat3),R.setUniform1f("u_time",(performance.now()-y.lastOpacityUpdate)/1e3);for(const[t,i]of y.iconPerPageElementsMap)this._renderIconRange(e,R,i,t,a)}}}_renderIconRange(e,t,i,s,a){const{context:r,spriteMosaic:l}=e;this._spritesTextureSize[0]=l.getWidth(s)/4,this._spritesTextureSize[1]=l.getHeight(s)/4,t.setUniform2fv("u_mosaicSize",this._spritesTextureSize),l.bind(r,h.Cj.LINEAR,s,n.$U),this._setStencilState(e,a),r.drawElements(h.WR.TRIANGLES,i[1],h.pe.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*i[0]),a.triangleCount+=i[1]/3}_drawText(e,t,i){const{context:o,displayLevel:h,glyphMosaic:u,painter:d,pixelRatio:g,spriteMosaic:p,state:f,styleLayerUID:_,requestRender:y,allowDelayedRender:m}=e,v=t.textMaterial,w=d.vectorTilesMaterialManager;let M,S=!1;for(const e of i)if(e.layerData.has(_)&&(M=e.layerData.get(_),M.glyphPerPageElementsMap.size>0)){S=!0;break}if(!S)return;const x=t.getPaintProperty("text-opacity");if(x&&!x.isDataDriven&&0===x.getValue(h))return;const P=t.getPaintProperty("text-color"),I=!P||P.isDataDriven||P.getValue(h)[3]>0,R=t.getPaintProperty("text-halo-width"),b=t.getPaintProperty("text-halo-color"),T=(!R||R.isDataDriven||R.getValue(h)>0)&&(!b||b.isDataDriven||b.getValue(h)[3]>0);if(!I&&!T)return;let L=t.getLayoutValue("text-rotation-alignment",h);L===r.I5.AUTO&&(L=t.getLayoutValue("symbol-placement",h)===r.kt.POINT?r.I5.VIEWPORT:r.I5.MAP);const E=L===r.I5.MAP,D=t.getLayoutValue("text-keep-upright",h)&&E,U=.8*3/g;this._glyphTextureSize||(this._glyphTextureSize=(0,s.fA)(u.width/4,u.height/4));const A=t.getPaintValue("text-translate",h),C=t.getPaintValue("text-translate-anchor",h),O=this._sdfProgramOptions,V=w.getMaterialProgram(o,v,O);if(m&&null!=y&&!V.compiled)return void y();o.useProgram(V),V.setUniformMatrix3fv("u_displayViewMat3",L===r.I5.MAP?f.displayViewMat3:f.displayMat3),V.setUniformMatrix3fv("u_displayMat3",C===r.Cq.VIEWPORT?f.displayMat3:f.displayViewMat3),V.setUniform2fv("u_textTranslation",A),V.setUniform1f("u_depth",t.z+c),V.setUniform2fv("u_mosaicSize",this._glyphTextureSize),V.setUniform1f("u_mapRotation",(0,l.wV)(f.rotation)),V.setUniform1f("u_keepUpright",D?1:0),V.setUniform1f("u_level",10*h),V.setUniform1i("u_texture",n.mg),V.setUniform1f("u_antialiasingWidth",U),V.setUniform1f("u_fadeDuration",a.zk/1e3);let k=-1;for(const s of i){if(!s.layerData.has(_))continue;if(s.key.level!==k&&(k=s.key.level,v.setDataUniforms(V,h,t,k,p)),M=s.layerData.get(_),0===M.glyphPerPageElementsMap.size)continue;M.prepareForRendering(o),M.updateOpacityInfo();const i=M.textVAO;if(null==i)continue;o.bindVAO(i),V.setUniformMatrix3fv("u_dvsMat3",s.transforms.displayViewScreenMat3),this._setStencilState(e,s);const a=(performance.now()-M.lastOpacityUpdate)/1e3;V.setUniform1f("u_time",a),M.glyphPerPageElementsMap.forEach(((e,t)=>{this._renderGlyphRange(o,e,t,u,V,T,I,s)}))}}_renderGlyphRange(e,t,i,s,a,r,l,o){s.bind(e,h.Cj.LINEAR,i,n.mg),r&&(a.setUniform1f("u_halo",1),e.drawElements(h.WR.TRIANGLES,t[1],h.pe.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),o.triangleCount+=t[1]/3),l&&(a.setUniform1f("u_halo",0),e.drawElements(h.WR.TRIANGLES,t[1],h.pe.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),o.triangleCount+=t[1]/3)}_setStencilState(e,t){const{context:i,is3D:s,stencilSymbols:a}=e;if(i.setStencilTestEnabled(!0),a)return i.setStencilWriteMask(255),void i.setStencilFunction(h.MT.ALWAYS,t.stencilRef,255);i.setStencilWriteMask(0),s?i.setStencilFunction(h.MT.EQUAL,t.stencilRef,255):i.setStencilFunction(h.MT.GREATER,255,255)}}},65523:(e,t,i)=>{i.d(t,{A:()=>n});var s=i(26574),a=i(62516),r=i(39156);class n extends a.A{constructor(){super(...arguments),this._fullCacheLodInfos=null,this._levelByScale={}}getTileParentId(e){const t=r.A.pool.acquire(e),i=0===t.level?null:r.A.getId(t.level-1,t.row>>1,t.col>>1,t.world);return r.A.pool.release(t),i}getTileCoverage(e,t,i=!0,s){const a=super.getTileCoverage(e,t,i,s);if(!a)return a;const r=1<<a.lodInfo.level;return a.spans=a.spans.filter((e=>e.row>=0&&e.row<r)),a}scaleToLevel(e){if(this._fullCacheLodInfos||this._initializeFullCacheLODs(this._lodInfos),this._levelByScale[e])return this._levelByScale[e];{const t=this._fullCacheLodInfos;if(e>t[0].scale)return t[0].level;let i,s;for(let a=0;a<t.length-1;a++)if(s=t[a+1],e>s.scale)return i=t[a],i.level+(i.scale-e)/(i.scale-s.scale);return t[t.length-1].level}}_initializeFullCacheLODs(e){let t;if(0===e[0].level)t=e.map((e=>({level:e.level,resolution:e.resolution,scale:e.scale})));else{const e=this.tileInfo.size[0],i=this.tileInfo.spatialReference;t=s.A.create({size:e,spatialReference:i}).lods.map((e=>({level:e.level,resolution:e.resolution,scale:e.scale})))}for(let e=0;e<t.length;e++)this._levelByScale[t[e].scale]=t[e].level;this._fullCacheLodInfos=t}}},93766:(e,t,i)=>{i.d(t,{w:()=>c});var s=i(82392),a=i(70214),r=i(37623),n=i(61985),l=i(81482),o=(i(6273),i(80861),i(67498),i(26325)),h=i(4197);const c=e=>{let t=class extends e{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(){super.postscript(),(0,h.jI)(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}async _validateHeightModelInfo(){const e=new AbortController,t=e.signal;this.addHandles((0,a.hA)((()=>e.abort()))),await(0,n.C_)((()=>this.view.defaultsFromMap?.heightModelInfoReady),t),(0,r.Te)(t);const i=(0,h.Hu)(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(i)throw i}};return(0,s._)([(0,l.MZ)()],t.prototype,"view",void 0),(0,s._)([(0,l.MZ)()],t.prototype,"slicePlaneEnabled",void 0),t=(0,s._)([(0,o.$)("esri.views.3d.layers.LayerView3D")],t),t}},78498:(e,t,i)=>{i.d(t,{E:()=>d});var s=i(82392),a=i(62991),r=i(61985),n=i(81482),l=(i(6273),i(80861),i(67498),i(26325)),o=i(81271),h=i(65956),c=i(60716),u=i(96383);const d=e=>{let t=class extends e{constructor(){super(...arguments),this.hasMixedImageFormats=!0}get imageFormatIsOpaque(){return!1}get fullExtent(){return this.layer.fullExtent}get isOpaque(){return this.fullOpacity>=1&&this.imageFormatIsOpaque}get visibleAtCurrentScale(){if(!(0,u.WK)(this.layer.minScale,this.layer.maxScale)||!this.view.terrainScale)return!0;const e=Math.round(this.view.basemapTerrain.tilingScheme.levelAtScale(this.view.terrainScale));return e>=this.displayLevelRange.minLevel&&e<=this.displayLevelRange.maxLevel}get dataScaleRange(){const e=this.tileInfo.lods;let t=e[0].scale,i=e[e.length-1].scale;if("tilemapCache"in this.layer&&this.layer.tilemapCache){const{effectiveMinLOD:e,effectiveMaxLOD:s}=this.layer.tilemapCache;t=this.tileInfo.lodAt(e).scale,i=this.tileInfo.lodAt(s).scale}return{minScale:t,maxScale:i}}canResume(){const e=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return this.visible&&this.layer?.loaded&&!this.parent?.suspended&&this.view?.ready&&(0,u.g7)(e)&&this.visibleAtCurrentTimeExtent||!1}get dataLevelRange(){const{minScale:e,maxScale:t}=this.dataScaleRange;return this.levelRangeFromScaleRange(e,t)}get displayLevelRange(){const e=this.layer.minScale||this.dataScaleRange.minScale,t=this.layer.maxScale||this.dataScaleRange.maxScale,i=this.levelRangeFromScaleRange(e,t);return this.layer.maxScale&&i.maxLevel++,i}get performanceInfo(){return new o.P(this.view.basemapTerrain.getUsedMemoryForLayerView(this))}getTileUrl(e){return this.layer.getTileUrl(e[0],e[1],e[2])}_addTilingSchemeMatchPromise(){if(null==this.fullExtent)return this.addResolvingPromise(Promise.reject(new a.A("tilingscheme:extent-not-defined","This layer doesn't define a fullExtent.")));const e=this._getTileInfoSupportError(this.tileInfo,this.fullExtent);if(e)return this.addResolvingPromise(Promise.reject(e));this.addResolvingPromise((0,r.C_)((()=>this.view?.basemapTerrain?.tilingSchemeLocked)).then((()=>{const e=this.view.basemapTerrain.tilingScheme,t="tilemapCache"in this.layer?this.layer.tilemapCache?.effectiveMaxLOD:void 0,i=this._getTileInfoCompatibilityError(this.tileInfo,e,t);if(i)throw i})))}_getTileInfoSupportError(e,t){const i=(0,c._y)(e,t,this.view.spatialReference,this.view.state.viewingMode,"tilemapCache"in this.layer?this.layer.tilemapCache?.effectiveMaxLOD:void 0);if(!i)return;const s={layer:this.layer,error:i};switch(i.name){case"tilingscheme:spatial-reference-mismatch":case"tilingscheme:global-unsupported-spatial-reference":case"tilingscheme:local-unsupported-spatial-reference":return new a.A("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",s);default:return new a.A("layerview:tiling-scheme-unsupported","The tiling scheme of this layer is not supported by SceneView",s)}}_getTileInfoCompatibilityError(e,t,i){return null!=e&&t.compatibleWith(e,i)?null:new a.A("layerview:tiling-scheme-incompatible","The tiling scheme of this layer is incompatible with the tiling scheme of the surface")}levelRangeFromScaleRange(e,t){const i={minLevel:0,maxLevel:1/0},s=this.view&&this.view.basemapTerrain&&this.view.basemapTerrain.tilingScheme;if(!s)return i;const a=s.levels[0],r=e=>{const t=Math.log(a.scale/e)/Math.LN2;return.5-Math.abs(.5-t%1)<1e-9?Math.round(t):Math.ceil(t)};return null!=e&&e>0&&(i.minLevel=Math.max(0,r(e))),null!=t&&t>0&&(i.maxLevel=Math.max(0,r(t))),i}isUpdating(){return!!(this.view&&this.view.basemapTerrain&&this.view.basemapTerrain.updating)}};return(0,s._)([(0,n.MZ)({readOnly:!0})],t.prototype,"imageFormatIsOpaque",null),(0,s._)([(0,n.MZ)({readOnly:!0})],t.prototype,"updating",void 0),(0,s._)([(0,n.MZ)(h.S)],t.prototype,"updatingProgress",void 0),(0,s._)([(0,n.MZ)(h.b)],t.prototype,"updatingProgressValue",void 0),(0,s._)([(0,n.MZ)()],t.prototype,"hasMixedImageFormats",void 0),(0,s._)([(0,n.MZ)()],t.prototype,"fullExtent",null),(0,s._)([(0,n.MZ)({readOnly:!0})],t.prototype,"isOpaque",null),(0,s._)([(0,n.MZ)({readOnly:!0})],t.prototype,"visibleAtCurrentScale",null),(0,s._)([(0,n.MZ)()],t.prototype,"dataScaleRange",null),(0,s._)([(0,n.MZ)({readOnly:!0})],t.prototype,"dataLevelRange",null),(0,s._)([(0,n.MZ)({readOnly:!0})],t.prototype,"displayLevelRange",null),(0,s._)([(0,n.MZ)()],t.prototype,"layer",void 0),t=(0,s._)([(0,l.$)("esri.views.3d.layers.TiledLayerView3D")],t),t}},62600:(e,t,i)=>{i.r(t),i.d(t,{default:()=>k});var s=i(82392),a=i(62991),r=i(6273),n=i(57725),l=i(37623),o=i(61985),h=i(81482),c=(i(80861),i(67498),i(26325));class u{constructor(e,t,i){this._scale=e,this._shift=t,this._levelShift=i}getLevelRowColumn(e){const t=this.getLevelShift(e[0]),i=this._shift+t;return i?[e[0]-t,e[1]>>i,e[2]>>i]:e}getLevelShift(e){return Math.min(e,this._levelShift)}getOffset(e,t){let i=0,s=0;const a=this._shift+this.getLevelShift(e[0]);if(a){const r=(1<<a)-1,n=t/(this._scale*(1<<a-1));i=(e[2]&r)*n,s=(e[1]&r)*n}return[i,s]}getScale(e){return this._scale*(1<<this._shift+this.getLevelShift(e))}}var d=i(48156),g=i(93446),p=i(2532),f=i(88317),_=i(29618),y=i(65523),m=i(39156);class v extends f.d{constructor(e,t,i,s){super(e,t,i,e.tileInfo.lods.length-1),this._memCache=s,this._ongoingTileRequests=new Map,this._ongoingRequestToController=new Map,this._tileInfoView=new y.A(e.tileInfo,e.fullExtent)}destroy(){super.destroy(),this._ongoingRequestToController.forEach((e=>e.abort())),this._ongoingRequestToController.clear(),this._ongoingTileRequests.clear()}async getVectorTile(e,t){const i=new m.A(e[0],e[1],e[2],0);let s=this._memCache.get(i.id);if(null!=s)return s.retain(),s;const a=await this._getVectorTileData(i);if((0,l.Te)(t),!this._layer)return null;if(s=this._memCache.get(i.id),null!=s)return s.retain(),s;const r=this._layer.tileInfo.getTileBounds((0,p.vt)(),i),n=this._tileInfoView.getTileResolution(e[0]);return s=new _.c(i,n,r[0],r[3],512,512,this._styleRepository,this._memCache),s.setData(a),a&&(s.retain(),this._memCache.put(i.id,s,s.usedMemory,d.Ti)),s.neededForCoverage=!0,s.transforms.tileUnitsToPixels=(0,g.fA)(1/8,0,0,0,1/8,0,0,0,1),s}_getVectorTileData(e){const t=e.id;if(this._ongoingTileRequests.has(t))return this._ongoingTileRequests.get(t);const i=new AbortController,s={signal:i.signal},a=this._getParsedVectorTileData(e,s).then((e=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),e))).catch((()=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),null)));return this._ongoingTileRequests.set(t,a),this._ongoingRequestToController.set(t,i),a}_getParsedVectorTileData(e,t){return this.fetchTileData(e,t).then((i=>this.parseTileData({key:e,data:i},t)))}}var w=i(59583),M=i(34031),S=i(94222),x=i(56433),P=i(30527);const I={vtlBackground:w.F,vtlFill:S.I,vtlLine:x.$,vtlCircle:M.p,vtlSymbol:P.P};var R=i(90553),b=i(3947),T=i(68716);const L=1e-6;class E{constructor(e,t){this.spriteMosaic=e,this.glyphMosaic=t,this._brushCache=new Map,this._vtlMaterialManager=new R.A}dispose(){this._brushCache&&(this._brushCache.forEach((e=>e.dispose())),this._brushCache=null),this._vtlMaterialManager=(0,n.WD)(this._vtlMaterialManager),this.spriteMosaic.dispose(),this.glyphMosaic.dispose()}get vectorTilesMaterialManager(){return this._vtlMaterialManager}drawSymbols(e,t,i){const s=i.layers;e.renderPass="translucent";for(let i=0;i<s.length;i++){const a=s[i];if(a.type!==b.Dc.SYMBOL)continue;const r=a.getLayoutProperty("visibility");if(r&&r.getValue()===b.bv.NONE)continue;const n=e.displayLevel;void 0!==a.minzoom&&a.minzoom>n+L||void 0!==a.maxzoom&&a.maxzoom<=n-L||(e.styleLayerUID=a.uid,e.styleLayer=a,this._drawWithBrush(e,t,"vtlSymbol"))}}drawBackground(e,t,i){if(0===i.backgroundBucketIds.length)return;const{context:s,displayLevel:a,requiredLevel:r}=e;t.key.level=r,s.setBlendingEnabled(!0),s.setDepthTestEnabled(!1),s.setStencilTestEnabled(!1),e.renderPass="background",i.backgroundBucketIds.forEach((s=>{const r=i.getLayerById(s);if(r.type!==b.Dc.BACKGROUND)return;const n=r.getLayoutProperty("visibility");n&&n.getValue()===b.bv.NONE||void 0!==r.minzoom&&r.minzoom>a+L||void 0!==r.maxzoom&&r.maxzoom<=a-L||(e.styleLayerUID=r.uid,e.styleLayer=r,this._drawWithBrush(e,t,"vtlBackground"))}))}drawTile(e,t,i,s){const{context:a}=e,r=i.layers;a.setBlendingEnabled(!1),a.setDepthTestEnabled(!0),a.setDepthWriteEnabled(!0),a.setDepthFunction(T.MT.LEQUAL),e.renderPass="opaque";for(let i=r.length-1;i>=0;i--){const a=r[i];null!=s&&s!==a.type||this._renderStyleLayer(a,e,t,!1)}a.setDepthWriteEnabled(!1),a.setBlendingEnabled(!0),a.setBlendFunctionSeparate(T.dn.ONE,T.dn.ONE_MINUS_SRC_ALPHA,T.dn.ONE,T.dn.ONE_MINUS_SRC_ALPHA),e.renderPass="translucent";for(let i=0;i<r.length;i++){const a=r[i];null!=s&&s!==a.type||this._renderStyleLayer(a,e,t,!1)}a.setDepthTestEnabled(!1),a.bindVAO()}_renderStyleLayer(e,t,i,s){if(!(s||e&&i.layerData.has(e.uid)))return;const a=e.getLayoutProperty("visibility");if(a&&a.getValue()===b.bv.NONE)return;const{renderPass:r}=t;let n;switch(e.type){case b.Dc.BACKGROUND:if("background"!==r)return;n="vtlBackground";break;case b.Dc.FILL:if("opaque"!==r&&"translucent"!==t.renderPass)return;n="vtlFill";break;case b.Dc.LINE:if("translucent"!==r)return;n="vtlLine";break;case b.Dc.CIRCLE:if("translucent"!==r)return;n="vtlCircle";break;case b.Dc.SYMBOL:if("translucent"!==r)return;n="vtlSymbol"}const l=t.displayLevel;if(void 0!==e.minzoom&&e.minzoom>l+L||void 0!==e.maxzoom&&e.maxzoom<=l-L)return;const{context:o}=t;o.setStencilTestEnabled(!1),o.setStencilWriteMask(0),t.styleLayerUID=e.uid,t.styleLayer=e,this._drawWithBrush(t,i,n)}_drawWithBrush(e,t,i){if(!this._brushCache.has(i)){const e=I[i];this._brushCache.set(i,new e)}this._brushCache.get(i).drawMany(e,[t])}}var D=i(20114),U=i(93766),A=i(78498),C=i(60716),O=i(24775);let V=class extends((0,A.E)((0,U.w)(O.A))){constructor(){super(...arguments),this._tileHandlerController=null,this.type="vector-tile-3d",this.levelShift=(0,r.A)("disable-feature:vtl-level-shift")?0:1}initialize(){if(null==this.layer.fullExtent)return void this.addResolvingPromise(Promise.reject(new a.A("vectortilelayerview:full-extent-undefined","This layer view's layer does not define a fullExtent.")));const{basemapTerrain:e,spatialReference:t,state:i,viewingMode:s}=this.view,r="local"===s&&!(0,C.bA)(t)||C.t6.force512VTL?this.layer.tileInfo:this.layer.tileInfo.getCompatibleForVTL(256),n=this._getTileInfoSupportError(r,this.layer.fullExtent);if(null!=n)return this.addResolvingPromise(Promise.reject(n));const h=(0,o.C_)((()=>this.view?.basemapTerrain?.tilingSchemeLocked)).then((()=>{const t=e.tilingScheme,i=t.pixelSize,s=256===i?1:2,a=e.spatialReference?.isGeographic&&256===i?1:0,r=e.spatialReference?.isGeographic||256!==i?0:1;let n;this.schemaHelper=new u(s,a,this.levelShift+r),n=256===i||512===i?this.layer.tileInfo.getCompatibleForVTL(i):this.layer.tileInfo;const l=this._getTileInfoCompatibilityError(n,t);if(l)throw l;this.tileInfo=n}));this._tileHandlerController=new AbortController;const c=this.view.resourceController;this._memCache=c.memoryController.newCache(`vtl-${this.layer.uid}`,(e=>{e.release()})),this.addHandles((0,o.wB)((()=>this.view.qualitySettings.memoryLimit),(e=>this._memCache.maxSize=Math.ceil(e/10*1048576)),o.pc));const d=new D.A(this.layer.currentStyleInfo.style);this._tileHandler=new v(this.layer,d,i.contentPixelRatio,this._memCache);const g=this._tileHandlerController.signal,p=function(e){return t=>e.immediate.schedule(t)}(c),f=this._tileHandler.start({signal:g,schedule:p}),_=this._tileHandler.spriteMosaic;_.then((e=>{!(0,l.G4)(g)&&this._tileHandler&&(this.painter=new E(e,this._tileHandler.glyphMosaic))})),f.then((()=>this._tileHandlerController=null));const y=()=>{this._tileHandlerController&&this._tileHandlerController.abort(),this._tileHandlerController=new AbortController,this._memCache.clear();const e=this.layer.currentStyleInfo.style,t=this.view.state?.contentPixelRatio??1,i=new D.A(e),s=new v(this.layer,i,t,this._memCache),a=s.start({signal:this._tileHandlerController.signal,schedule:p}),r=s.spriteMosaic;a.then((()=>this._tileHandlerController=null)),this._updatingHandles.addPromise(Promise.all([a,r]).then((([,e])=>{const t=this._tileHandler,i=this.painter;this.painter=new E(e,s.glyphMosaic),this._tileHandler=s,this.emit("data-changed"),t.destroy(),i&&i.dispose()})))};this._updatingHandles.add((()=>({style:this.layer.currentStyleInfo.style,pixelRatio:this.view.state?.contentPixelRatio})),y),this.addHandles([this.layer.on("paint-change",(()=>this.emit("data-changed"))),this.layer.on("style-layer-change",y),this.layer.on("delete-style-layer",y),this.layer.on("spriteSource-change",(()=>this.emit("data-changed"))),this.layer.on("layout-change",(()=>this.emit("data-changed"))),this.layer.on("style-layer-visibility-change",(()=>this.emit("data-changed")))]);const m=Promise.all([h,f,_]);this.addResolvingPromise(m)}destroy(){this.painter=(0,n.WD)(this.painter),this._tileHandlerController=(0,n.DC)(this._tileHandlerController),this._tileHandler=(0,n.pR)(this._tileHandler),this._memCache=(0,n.pR)(this._memCache)}get contentZoom(){return(0,r.A)("disable-feature:vtl-level-shift")?1:this.view.qualitySettings.tiledSurface.vtlContentZoom}get displayLevelRange(){const e=this.tileInfo.lods,t=this.layer.minScale||e[0].scale,i=this.layer.maxScale||e[e.length-1].scale,s=this.levelRangeFromScaleRange(t,i);return this.layer.maxScale?s.maxLevel++:s.maxLevel+=this.levelShift,s}get dataScaleRange(){const e=this.tileInfo.lods;return{minScale:e[0].scale,maxScale:e[e.length-1].scale}}get dataLevelRange(){const{minScale:e,maxScale:t}=this.dataScaleRange,i=this.levelRangeFromScaleRange(e,t);return 1===i.minLevel&&256===this.tileInfo.size[0]&&(i.minLevel=0),i.maxLevel+=this.levelShift,i}async fetchTile(e,t){const i=this.schemaHelper.getLevelRowColumn(e);return this._tileHandler.getVectorTile(i,t)}};(0,s._)([(0,h.MZ)()],V.prototype,"layer",void 0),(0,s._)([(0,h.MZ)()],V.prototype,"levelShift",void 0),(0,s._)([(0,h.MZ)()],V.prototype,"contentZoom",null),(0,s._)([(0,h.MZ)()],V.prototype,"displayLevelRange",null),(0,s._)([(0,h.MZ)()],V.prototype,"tileInfo",void 0),(0,s._)([(0,h.MZ)()],V.prototype,"dataScaleRange",null),(0,s._)([(0,h.MZ)()],V.prototype,"dataLevelRange",null),(0,s._)([(0,h.MZ)()],V.prototype,"updatingProgressValue",void 0),V=(0,s._)([(0,c.$)("esri.views.3d.layers.VectorTileLayerView3D")],V);const k=V},27824:(e,t,i)=>{i.d(t,{Z:()=>s});class s{constructor(e){this._readFile=e}resolveIncludes(e){return this._resolve(e)}_resolve(e,t=new Map){if(t.has(e))return t.get(e);const i=this._read(e);if(!i)throw new Error(`cannot find shader file ${e}`);const s=/^[^\S\n]*#include\s+<(\S+)>[^\S\n]?/gm;let a=s.exec(i);const r=[];for(;null!=a;)r.push({path:a[1],start:a.index,length:a[0].length}),a=s.exec(i);let n=0,l="";return r.forEach((e=>{l+=i.slice(n,e.start),l+=t.has(e.path)?"":this._resolve(e.path,t),n=e.start+e.length})),l+=i.slice(n),t.set(e,l),l}_read(e){return this._readFile(e)}}}}]);