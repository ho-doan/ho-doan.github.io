"use strict";(self.webpackChunkarcgis_node=self.webpackChunkarcgis_node||[]).push([[3320],{3320:(e,t,a)=>{a.d(t,{save:()=>R,saveAs:()=>W});var o=a(62991),n=a(67214),r=a(61985),i=a(19759),s=a(2527),l=a(44153),c=a(67488),p=a(64672),u=a(63457),d=a(65452),f=a(83382),m=a(95225),w=a(10069),y=a(86074),h=a(35497),_=a(15697),g=a(6183),b=a(20267),O=a(83681),v=a(49972);const A=["NatGeo_World_Map","Ocean_Basemap","USA_Topo_Maps","World_Imagery","World_Street_Map","World_Terrain_Base","World_Topo_Map","World_Hillshade","Canvas/World_Light_Gray_Base","Canvas/World_Light_Gray_Reference","Canvas/World_Dark_Gray_Base","Canvas/World_Dark_Gray_Reference","Ocean/World_Ocean_Base","Ocean/World_Ocean_Reference","Reference/World_Boundaries_and_Places","Reference/World_Reference_Overlay","Reference/World_Transportation"].map((e=>e.toLowerCase()));async function R(e,t,a){a??={},function(e,t){if(!t.portalItem)throw new o.A(`${e.name}:portal-item-not-set`,"Portal item to save to has not been set on the WebMap");(0,O.X)(t.portalItem),I(e,t.portalItem)}(e,t),await(0,r.C_)((()=>!t.updatingFromView)),await t.load(),await P(t),await(0,v.d)(t),await C(e,t);const n=t.portalItem,{json:i,jsonContext:s}=await M(t,n);return(0,v.c)(s,{errorName:`${e.name}:save`},a),await T(t,n),await async function(e,t,a,o,n){await a.update({data:o}),H(e,t,a,o,n)}(e,t,n,i,s),await Promise.all([t.updateItemThumbnail(),(0,b.r)(t.resourceReferences,s)]),n}async function M(e,t){const a=(0,w.m)(t,"web-map",!0),o=e.write({},a);return await Promise.all(a.resources.pendingOperations),{json:o,jsonContext:a}}async function W(e,t,a,n){n??={};const s=function(e,t){let a=m.default.from(t);return a.id&&(a=a.clone(),a.id=null),a.type||(a.type=e.itemType),a.portal||(a.portal=f.A.getDefault()),(0,O.X)(a),I(e,a),a}(e,a);await(0,r.C_)((()=>!t.updatingFromView)),await t.load(),await P(t),await(0,v.d)(t),await C(e,t);const{json:l,jsonContext:c}=await M(t,s);(0,v.c)(c,{errorName:`${e.name}:save`},n),await async function(e,t){(0,y.OM)(t,L),(0,y.OM)(t,B),(0,y.OM)(t,y.mm.METADATA),(0,y.OM)(t,D),(0,y.OM)(t,x),(0,y.OM)(t,j),(0,y.OM)(t,E),(0,y.OM)(t,$),await T(e,t)}(t,s);const p=t.getThumbnailState();return await async function(e,t,a,n,r,s){const l=t.portalItem,c={item:l,authenticated:!(!l?.id||!l.portal.user)},p=a.portal;await p.signIn();const{copyAllowed:u,itemReloaded:d}=await async function(e,t){const{item:a,authenticated:o}=e;return a?.id&&a.typeKeywords?.includes("useOnly")?a.portal.portalHostname!==t.portalHostname?{copyAllowed:!1,itemReloaded:!1}:(o||await a.reload(),{copyAllowed:"admin"===a.itemControl||"update"===a.itemControl,itemReloaded:!0}):{copyAllowed:!0,itemReloaded:!1}}(c,p);if(c.authenticated||=d,!u)throw new o.A(`${e.name}:save-as-copy-not-allowed`,"Owner of this map does not allow others to save a copy");const f=await async function(e,t,a,o){const n=e.portal,{item:r}=t,{folder:s,copyAllResources:l}=o;let c=!1;if(l&&r?.id&&(0,i.b8)(r.portal.url,n.url)&&parseInt(r.portal.currentVersion,10)>=2023){const{total:e}=await r.fetchResources();c=!!e}if(c){const t=await r.copy({copyResources:"all",folder:s});e.id=t.id,e.portal=t.portal;const o=e.toJSON();await e.load(),e.read(o),await e.update({data:a})}else await(n.user?.addItem({item:e,folder:s,data:a}));return c}(a,c,n,s);return t.portalItem=a,H(e,t,a,n,r),f}(e,t,s,l,c,n)&&(t.resourceReferences.portalItem=s),t.restoreThumbnailFromState(p),await Promise.all([t.updateItemThumbnail(),(0,b.r)(t.resourceReferences,c)]),s}function I(e,t){if(t.type!==e.itemType)throw new o.A(`${e.name}:portal-item-wrong-type`,`Portal item needs to have type "${e.itemType}"`)}async function C(e,t){if(!t.basemap?.baseLayers.length)throw new o.A(`${e.name}:save`,"Map does not have a valid basemap with a base layer.");let a=null;if(await(0,r.C_)((()=>{const e=(0,g.n8)(t.initialViewProperties,t.basemap);return a=e.spatialReference,!e.updating})),!(0,c.aI)(a,t.initialViewProperties.spatialReference))throw new o.A(`${e.name}:save`,"The spatial reference of the basemap is not compatible with the one from the map.",{expected:t.initialViewProperties.spatialReference,actual:a})}function P(e){const t=[];return e.basemap&&t.push(e.basemap.load()),e.ground&&t.push(e.ground.load()),Promise.allSettled(t).then((()=>{}))}async function T(e,t){t.extent=await async function(e,t){const o=t.clone().normalize();let n;if(o.length>1)for(const e of o)n?e.width>n.width&&(n=e):n=e;else n=o[0];return async function(e,t){const o=t.spatialReference;if(o.isWGS84)return t.clone();if(o.isWebMercator)return(0,p.ci)(t);const{getGeometryServiceURL:n}=await Promise.resolve().then(a.bind(a,57942)),r=await n(e),i=new _.A({geometries:[t],outSpatialReference:l.A.WGS84});return(await(0,h.C)(r,i))[0]}(e,n)}(e.portalItem,e.initialViewProperties.viewpoint.targetGeometry),await async function(e,t){(0,y.LG)(t,G),await function(e){const t=Y(e).map((e=>e.load())).toArray();return Promise.allSettled(t).then((()=>{}))}(e),function(e,t){(0,y.Y)(t,L)||(0,y.Y)(t,E)||(0,y.Y)(t,$)||(0,y.Y)(t,j)||!F(e)?(0,y.OM)(t,S):(0,y.LG)(t,S)}(e,t),function(e,t){F(e)?(0,y.LG)(t,k):(0,y.OM)(t,k)}(e,t),function(e,t){!(0,y.Y)(t,D)&&function(e){return Y(e).filter((e=>"group"!==e.type)).every((t=>t.loaded&&function(e,t){return(0,d.W_)(t)&&t.capabilities.operations.supportsSync||function(e){return(0,d.Ov)(e)||"map-notes"===e.type||"route"===e.type}(t)&&!t.portalItem||("tile"===t.type||"vector-tile"===t.type)&&(t.capabilities.operations.supportsExportTiles||function(e){return"tile"===e.type&&(0,u.tK)(e.url)&&A.some((t=>e.url?.toLowerCase().includes("/"+t+"/")))}(t)||(0,g.JT)(t))&&t.spatialReference.equals(e.initialViewProperties.spatialReference)}(e,t)))}(e)?(0,y.LG)(t,V):(0,y.OM)(t,V)}(e,t),function(e,t){(0,g.Rc)(e.basemap)?(0,y.LG)(t,N):(0,y.OM)(t,N)}(e,t),function(e,t){e.utilityNetworks?.length?(0,y.LG)(t,K):(0,y.OM)(t,K)}(e,t),function(e,t){e.ipsInfo?(0,y.LG)(t,U):(0,y.OM)(t,U)}(e,t),t.typeKeywords&&(t.typeKeywords=t.typeKeywords.filter(((e,t,a)=>a.indexOf(e)===t)))}(e,t)}const G=y.mm.JSAPI,L="CollectorDisabled",S="Collector",k="Data Editing",D="OfflineDisabled",V="Offline",E="Workforce Project",$="Workforce Worker",j="Workforce Dispatcher",x="Offline Map Areas",B="FieldMapsDisabled",N=y.mm.DEVELOPER_BASEMAP,K="UtilityNetwork",U="IPS";function Y(e){return e.allLayers.concat(e.allTables)}function F(e){return Y(e).some((e=>e.loaded&&(0,d.W_)(e)&&e.capabilities.operations.supportsEditing&&e.editingEnabled&&("subtype-group"!==e.type||e.sublayers.some((e=>e.editingEnabled)))))}function H(e,t,a,o,r){n.L.prototype.read.call(t,{version:o.version,authoringApp:o.authoringApp,authoringAppVersion:o.authoringAppVersion},{origin:e.origin,ignoreDefaults:!0,url:a.itemUrl?(0,i.An)(a.itemUrl):void 0}),(0,s.v)(r),t.resourceInfo=o}}}]);