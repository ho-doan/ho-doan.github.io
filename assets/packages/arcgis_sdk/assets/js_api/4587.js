"use strict";(self.webpackChunkarcgis_node=self.webpackChunkarcgis_node||[]).push([[4587],{14494:(e,t,i)=>{i.d(t,{f:()=>a});var r=i(80347),s=i(99269),n=i(99263),o=i(67488);function a(e,t,i,a){if(null==t||null==a)return!1;const l=(0,s.Qk)(t,s.Wv),c=(0,s.Qk)(a,s.zp);if(l===c&&l!==s.rz.UNKNOWN||(0,o.aI)(t,a))return i[0]=1,i[1]=1,i[2]=1,!0;if(l===s.rz.SPHERICAL_ECEF){const t=(0,r.l)(e),o=t/Math.sqrt(e[0]*e[0]+e[1]*e[1]),a=t/n.$O.radius;if(c===s.rz.WEB_MERCATOR)return i[0]=o*a,i[1]=o*a,i[2]=1,!0;if(c===s.rz.WGS84||c===s.rz.CGCS2000){const e=s.iE;return i[0]=e*o*a,i[1]=e*a,i[2]=1,!0}}else if(l===s.rz.PLATE_CARREE){if(c===s.rz.WGS84||c===s.rz.CGCS2000)return i[0]=s.iE,i[1]=s.iE,i[2]=1,!0;if(c===s.rz.WEB_MERCATOR){const t=e[1]/n.$O.radius;return i[0]=1,i[1]=1/Math.cos(t),i[2]=1,!0}}return!1}},29918:(e,t,i)=>{i.d(t,{z:()=>a});var r=i(4506),s=i(19913),n=i(99269),o=i(99263);function a(e,t,i,r){if(null==t||null==r)return!1;const s=(0,n.t_)(t,r,d);if(s.projector===n.pO)return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],!0;if(null==s.projector)return!1;const{source:a,dest:u}=s;if(u.spatialReferenceId===n.rz.WEB_MERCATOR){const t=n.w5[a.spatialReferenceId][n.rz.WGS84];return null!=t&&(t(e,0,c,0),(0,n.s7)(c,0,i,0),i[3]=l(c[1],e[2],e[3],o.$O.radius),!0)}if(a.spatialReferenceId!==n.rz.WGS84&&a.spatialReferenceId!==n.rz.CGCS2000||u.spatialReferenceId!==n.rz.PLATE_CARREE){s.projector(e,0,i,0);const t=a.metersPerUnit??1,r=u.metersPerUnit??1;i[3]=e[3]*t/r}else{const t=n.w5[a.spatialReferenceId][n.rz.SPHERICAL_ECEF],r=n.w5[n.rz.SPHERICAL_ECEF][n.rz.PLATE_CARREE];let c=e[3];null!=t&&null!=r&&(c=l(e[1],e[2],e[3],o.$O.radius)),s.projector(e,0,i,0),i[3]=c}return!0}function l(e,t,i,r){const s=r+t;if(s<r/2||i>s)return Number.MAX_VALUE;const n=Math.abs(u*e)+Math.asin(i/s);return n>=Math.PI/2?Number.MAX_VALUE:i/Math.cos(n)}const c=(0,s.vt)(),d=(0,n.Ur)(),u=(0,r.kU)(1)},11703:(e,t,i)=>{var r,s,n,o,a,l,c,d,u,h,p,m,f,g,b;i.d(t,{CP:()=>n,EF:()=>g,El:()=>c,LU:()=>r,Nt:()=>d,Pl:()=>y,Qg:()=>b,TJ:()=>f,_N:()=>a,eN:()=>o,h7:()=>s,vE:()=>_}),function(e){e.U8="U8",e.I8="I8",e.U16="U16",e.I16="I16",e.U32="U32",e.I32="I32",e.F32="F32",e.F64="F64",e.Utf8String="Utf8String",e.NotSet="NotSet"}(r||(r={})),function(e){e.Png="Png",e.Jpeg="Jpeg",e.Dds="Dds",e.Raw="Raw",e.Dxt1="Dxt1",e.Dxt5="Dxt5",e.Etc2="Etc2",e.Astc="Astc",e.Pvrtc="Pvrtc",e.NotSet="NotSet"}(s||(s={})),function(e){e.Rgb8="Rgb8",e.Rgba8="Rgba8",e.R8="R8",e.Bgr8="Bgr8",e.Bgra8="Bgra8",e.Rg8="Rg8",e.NotSet="NotSet"}(n||(n={})),function(e){e.Position="Position",e.Normal="Normal",e.TexCoord="TexCoord",e.Color="Color",e.Tangent="Tangent",e.FeatureIndex="FeatureIndex",e.UvRegion="UvRegion",e.NotSet="NotSet"}(o||(o={})),function(e){e.Opaque="Opaque",e.Mask="Mask",e.Blend="Blend"}(a||(a={})),function(e){e.None="None",e.Mask="Mask",e.Alpha="Alpha",e.PreMultAlpha="PreMultAlpha",e.NotSet="NotSet"}(l||(l={})),function(e){e.Points="Points",e.Lines="Lines",e.LineStrip="LineStrip",e.Triangles="Triangles",e.TriangleStrip="TriangleStrip",e.NotSet="NotSet"}(c||(c={})),function(e){e.None="None",e.WrapXBit="WrapXBit",e.WrapYBit="WrapYBit",e.WrapXy="WrapXy",e.NotSet="NotSet"}(d||(d={})),function(e){e.Linear="Linear",e.Nearest="Nearest",e.NotSet="NotSet"}(u||(u={})),function(e){e.Linear="Linear",e.Nearest="Nearest",e.NearestMipmapNearest="NearestMipmapNearest",e.LinearMipmapNearest="LinearMipmapNearest",e.NearestMipmapLinear="NearestMipmapLinear",e.LinearMipmapLinear="LinearMipmapLinear",e.NotSet="NotSet"}(h||(h={})),function(e){e.FeatureId="FeatureId",e.GlobalUid="GlobalUid",e.UnspecifiedDateTime="UnspecifiedDateTime",e.EcmaIso8601DateTime="EcmaIso8601DateTime",e.EcmaIso8601DateOnly="EcmaIso8601DateOnly",e.TimeOnly="TimeOnly",e.TimeStamp="TimeStamp",e.ColorRgb="ColorRgb",e.ColorRgba="ColorRgba",e.Unrecognized="Unrecognized",e.NotSet="NotSet"}(p||(p={})),function(e){e.Texture="Texture",e.VertexAtrb="VertexAtrb",e.Implicit="Implicit",e.NotSet="NotSet"}(m||(m={})),function(e){e.Front="Front",e.Back="Back",e.None="None",e.NotSet="NotSet"}(f||(f={})),function(e){e.Pbr="Pbr",e.Unlit="Unlit"}(g||(g={})),function(e){e[e.Succeeded=0]="Succeeded",e[e.Failed=1]="Failed",e[e.MissingInputs=2]="MissingInputs"}(b||(b={}));const y=-1,_=-2},84587:(e,t,i)=>{i.r(t),i.d(t,{default:()=>me});var r=i(82392),s=i(62991),n=i(6273),o=i(80861),a=i(57725),l=i(61985),c=i(9987),d=i(81482),u=(i(67498),i(26325)),h=i(82541),p=i(79441),m=i(25336),f=i(26110),g=i(19165),b=i(80347),y=i(19913),_=i(76982),v=i(34670),w=i(63540),E=i(14494),x=i(42722),C=i(40041),M=i(11703),T=i(19541),P=i(84456),R=i(81271);class U extends R.P{constructor(e,t,i,r,s,n,o){super(e,0,0,0,t),this.nodesCached=i,this.vboMB=r,this.textureMB=s,this.vboMBCached=n,this.textureMBCached=o}}var S=i(161),N=i(93766),A=i(87049),L=i(94282),O=i(10875),I=i(68716);const F={[M.El.Points]:null,[M.El.Lines]:null,[M.El.LineStrip]:null,[M.El.Triangles]:I.WR.TRIANGLES,[M.El.TriangleStrip]:I.WR.TRIANGLE_STRIP,[M.El.NotSet]:null},H={[M._N.Opaque]:O.sf.Opaque,[M._N.Mask]:O.sf.Mask,[M._N.Blend]:O.sf.Blend},B={[M.TJ.Back]:O.s2.Back,[M.TJ.Front]:O.s2.Front,[M.TJ.None]:O.s2.None,[M.TJ.NotSet]:O.s2.Back},V={[M.Nt.WrapYBit]:{s:I.pF.CLAMP_TO_EDGE,t:I.pF.REPEAT},[M.Nt.WrapXBit]:{s:I.pF.REPEAT,t:I.pF.CLAMP_TO_EDGE},[M.Nt.WrapXy]:{s:I.pF.REPEAT,t:I.pF.REPEAT},[M.Nt.None]:{s:I.pF.CLAMP_TO_EDGE,t:I.pF.CLAMP_TO_EDGE},[M.Nt.NotSet]:{s:I.pF.CLAMP_TO_EDGE,t:I.pF.CLAMP_TO_EDGE}},z={[M.LU.U8]:1,[M.LU.I8]:1,[M.LU.U16]:2,[M.LU.I16]:2,[M.LU.U32]:4,[M.LU.I32]:4,[M.LU.F32]:4,[M.LU.F64]:8,[M.LU.Utf8String]:1,[M.LU.NotSet]:1};var D=i(20857),j=i(36195),k=i(57809),G=i(30165),W=i(17555);class ${constructor(e){this.layerUid=[],this.type=G.dz.TILES3D,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerView=e,this.layerUid.push(e.layer.uid)}intersect(e,t,i,r,s,n){const o=e.results,a=e.options.store===G.oH.ALL;if(e.options.filteredLayerUids.includes(this.layerView.layer.uid))return;const l=this.layerView.view._stage.renderView.componentObjectCollection,c=new W.JG(n??!1,e.options.normalRequired);this.layerView.objects.forEach((s=>{s.visible&&s.intersectionGeometry&&l.intersect(s,i,r,e.tolerance,null,c,((s,n,l,c)=>{if(n>=0){if(null!=t&&!t(i,r,n))return;const s=e=>{const t=new j.kV(this.layerView.layer.uid,(()=>this._createTiles3DGraphic(this.layerView.layer,{})));e.set(this.type,t,n,l)};if(this.isGround&&(null==o.ground.dist||n<o.ground.dist)&&s(o.ground),e.options.isFiltered)return;if((null==o.min.dist||n<o.min.dist)&&s(o.min),(null==o.max.dist||n>o.max.dist)&&s(o.max),a){const t=(0,k.G7)(e.ray);s(t),e.results.all.push(t)}}}))}))}_createTiles3DGraphic(e,t){return new D.A({layer:e,sourceLayer:e,attributes:t})}}var q,J,X=i(21016),Z=i(45506),Y=i(78988),K=i(41034),Q=i(22315),ee=i(24565),te=i(16776),ie=i(51229),re=i(28349),se=i(10941),ne=i(70789),oe=i(32573),ae=i(33763),le=i(29290),ce=i(24775),de=i(96383);(J=q||(q={}))[J.API=1]="API",J[J.VerboseAPI=2]="VerboseAPI",J[J.Error=3]="Error";class ue{constructor(){this.handle=0,this.isVisible=!1,this.components=[],this.texMemoryUsage=0,this.vboMemoryUsage=0,this.cpuMemoryUsage=0,this.textures=[]}totalMemory(){return this.texMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}}function he(e){return Math.round(e/1048.576)/1e3}let pe=class extends((0,N.w)(ce.A)){constructor(){super(...arguments),this.type="integrated-mesh-3dtiles",this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this.drapeTargetType=S.sv.WithoutRasterImage,this._lyrHandleToObjects=new Map,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set}initialize(){if(this._dbgFlags.add(q.Error),this._dbg(q.VerboseAPI,"Tiles3DLayerView3D initialize() called"),!this._canProjectWithoutEngine())throw new s.A("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});const e=(0,A.Bk)(this).then((e=>{this._intersectionHandler=new $(this),this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add((()=>this.slicePlaneEnabled),(e=>this._slicePlaneEnabledChange(e))),this._elevationProvider=new L.e({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this.view.elevationProvider.register("im",this._elevationProvider),this.view.basemapTerrain.overlayManager.registerDrapeTarget(this),this._wasmLayerId=e;const t=this.view.resourceController.memoryController.newCache(`t3d-${this.uid}`,(e=>this._onRemoveFromCache(e)));this._memCache=t,this.addHandles([(0,l.wB)((()=>this.layer.elevationInfo),(e=>this._elevationInfoChanged(e)))]),this._suspendedHandle=(0,l.wB)((()=>this.suspended),(e=>{const t=(0,A.pw)(this.view);t&&t.setEnabled(this,!e)}),l.Vh)})).catch((e=>{if((0,A.r8)(this),this._wasmLayerId=-1,e===M.Pl)throw new s.A("tiles3d:addLayer-failure","The 3d tiles layer description was invalid.",{});if(e===M.vE)throw new s.A("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{})}));this.addResolvingPromise(e)}destroy(){this._dbg(q.VerboseAPI,"Tiles3DLayerView3D destroy() called"),(0,A.r8)(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach((e=>this.freeObject(e))),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._memCache=(0,a.pR)(this._memCache),this._updatingHandles=(0,a.pR)(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_visibleGeometryChanged(){null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=(0,c._)((()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null})))}_slicePlaneEnabledChange(e){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=e),this.objects.forEach((t=>{const i=this._collection.getMaterial(t);i.commonMaterialParameters.hasSlicePlane=e,i.commonMaterialParameters.cullFace=e?O.s2.None:this._initialCullFace.get(t)}))}_elevationInfoChanged(e){const t=(0,A.pw)(this.view);t&&t.setLayerOffset(this,(0,T.M7)(e))}get _obbs(){return this.objects.map((e=>this._collection.getComponentObb(e)))}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let e=0;return this._lyrHandleToObjects.forEach((t=>{t.isVisible&&(e+=t.totalMemory())})),e}get unloadedMemory(){let e=0;return this._lyrHandleToObjects.forEach((t=>{t.isVisible||(e+=t.totalMemory())})),e}get visibleAtCurrentScale(){return(0,de.E5)(this.layer.effectiveScaleRange,this.view.terrainScale)}get performanceInfo(){let e=0,t=0,i=0,r=0,s=0,n=0;return this._lyrHandleToObjects.forEach((o=>{o.isVisible?(e+=o.texMemoryUsage,t+=o.vboMemoryUsage,s++):(i+=o.texMemoryUsage,r+=o.vboMemoryUsage,n++)})),new U(this.usedMemory,s,n,he(t),he(e),he(r),he(i))}_canProjectWithoutEngine(){if(this.view.state.viewingMode===P.RT.Local){const e=this.view.renderSpatialReference?.isWebMercator?3857:this.view.renderSpatialReference?.wkid??-1;if(3857!==e&&32662!==e)return!1}return!0}get _stage(){return this.view._stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){return(0,T.M7)(this.layer.elevationInfo)}get elevationRange(){const e=this.fullExtent;return e?.zmin&&e?.zmax?new X.H(e.zmin,e.zmax):null}getElevationRange(e){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce(((e,t)=>e.concat(t.components)),new Array)}isUpdating(){const e=(0,A.pw)(this.view);return!(this._wasmLayerId<0||null==e)&&e.isUpdating(this._wasmLayerId)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(e){const t=e.meshData;if(null==t.data)throw new Error("meshData.data undefined");if(t.desc=JSON.parse(t.desc),null==t.desc)throw new Error("meshData.desc undefined");const i=(0,y.ci)(t.desc.origin),r=new Array,s=new Map,o=new ue;o.handle=e.handle,this._lyrHandleToObjects.set(e.handle,o);const a=this.view.basemapTerrain.spatialReference;let l,c;if("global"===this.view.viewingMode){const e=(0,f.vt)();(0,w.l)(v.fv,i,e,a),l=(0,h.z0)((0,p.vt)(),e),c=(0,h.B8)((0,p.vt)(),l)}else l=p.zK,c=p.zK;const d=(0,f.vt)();(0,m.Tl)(d,d,i);const u=(0,m.sC)((0,y.vt)(),d);let C=null;const T=(0,y.vt)();if(t.desc.obb){const e=t.desc.obb.quaternion;C=new Z.ab(t.desc.obb.center,t.desc.obb.halfSize,(0,g.fA)(e[0],e[1],e[2],e[3]))}for(let e=0;e<t.desc.prims.length;e++){const d=t.desc.prims[e];if(this._dbg(q.VerboseAPI,JSON.stringify(d)),d.ptype===M.El.Lines)continue;if(null==F[d.ptype]||null==t.data){this._dbg(q.VerboseAPI,"[Unsupported Feature] Unsupported primitive mode ("+d.ptype+"). Skipping primitive.");continue}const h=t.desc?.materials&&null!=d.materialId?t.desc.materials[d.materialId]:null,m=null!=h?h.lightingModel:M.EF.Unlit,f=!(0,n.A)("disable-feature:im-shading"),{positionView:g,positionAttr:v,normalsView:w,normalsAttr:P,colorAttr:R,texCoord0Attr:U,indicesView:S}=this.getBufferViews(d,t.data.buffer,l,f);if(null==v||null==g||null==S)continue;const N={colors:null!=R,textureCoordinates:null!=U?ie.q.Default:ie.q.None,hasNormals:null!=w,needsNormals:f},A=v.data.length/v.size,L=(e,t)=>!e||e.data.length/e.size===A||(this._dbg(q.Error,`${t} !== numPos. Skipping primitive.`),!1);if(!L(U,"numTexcoord")||!L(R,"numColors")||!L(P,"normals"))continue;const I=(0,K.h)(N);if(null!=C?C=C.clone():(C=(0,Z.OX)(v),(0,b.g)(T,C.center,i),C.center=T),l!==p.zK)for(let e=0;e<g.count;e++)g.getVec(e,T),(0,b.t)(T,T,l),g.setVec(e,T);const V=I.createBuffer(v.data.length),z=new Map([[ae.r.POSITION,v]]);null!=U&&z.set(ae.r.UV0,U),null!=R&&z.set(ae.r.COLOR,R),null!=P&&z.set(ae.r.NORMALCOMPRESSED,P),z.forEach(((e,t)=>{null!=e&&(0,le.zC)(t,e,null,null,V,0)}));const D=new Uint32Array([0,S.typedBuffer.length]),j={vertices:{data:V.buffer,count:V.byteLength/I.stride,layoutParameters:N},positionData:{positions:g.typedBuffer,indices:S.typedBuffer},indices:S.typedBuffer,componentOffsets:D};o.cpuMemoryUsage+=g.count,o.cpuMemoryUsage+=S.count;const k=this.view.renderSpatialReference,G=(0,y.vt)(),W=[1,1,1];(0,E.f)(u,k,W,a)||this._dbg(q.Error,"Unsupported coordinate system for IM overlay"),(0,x.F)(u,k,G,a);const $=this._collection.createObject(new Y.i((0,_.fA)(G[0],G[1],W[0],W[1]),new Q.d(u,c),C,j));h&&this._collection.updateMaterial($,(e=>{e.baseColor=h.baseColorFactor,e.usePBR=m===M.EF.Pbr,e.hasParametersFromSource=!1,e.baseColorTexture=this._getTexture(h.baseColorTex,t,s),e.usePBR&&(e.mrrFactors=[h.metallicFactor,h.roughnessFactor,0],e.emissiveFactor=h.emissiveFactor??[0,0,0],e.metallicRoughnessTexture=this._getTexture(h.metalTex,t,s),e.emissionTexture=this._getTexture(h.emissiveTex,t,s),e.occlusionTexture=this._getTexture(h.occlusionTex,t,s),e.normalTexture=this._getTexture(h.normalTex,t,s)),e.objectOpacity=0,e.alphaDiscardMode=O.sf.Mask;const i=[];e.baseColorTexture&&i.push(e.baseColorTexture.loadPromise),e.usePBR&&e.metallicRoughnessTexture&&i.push(e.metallicRoughnessTexture.loadPromise),e.usePBR&&e.emissionTexture&&i.push(e.emissionTexture.loadPromise),e.usePBR&&e.occlusionTexture&&i.push(e.occlusionTexture.loadPromise),e.usePBR&&e.normalTexture&&i.push(e.normalTexture.loadPromise);const n=Promise.all(i);r.push(n),n.then((()=>{e.alphaDiscardMode=H[h.alphaMode],e.objectOpacity=1,o.texMemoryUsage+=e.baseColorTexture?.glTexture?.usedMemory||0,e.usePBR&&(o.texMemoryUsage+=e.metallicRoughnessTexture?.glTexture?.usedMemory||0,o.texMemoryUsage+=e.emissionTexture?.glTexture?.usedMemory||0,o.texMemoryUsage+=e.occlusionTexture?.glTexture?.usedMemory||0,o.texMemoryUsage+=e.normalTexture?.glTexture?.usedMemory||0)})),e.commonMaterialParameters.doubleSided=h.isDoubleSided,e.commonMaterialParameters.cullFace=h.faceCulling?B[h.faceCulling]:O.s2.Back,this._initialCullFace.set($,e.commonMaterialParameters.cullFace),e.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,e.componentParameters.castShadows=ee.d0.All,e.textureAlphaCutoff=h.alphaCutoff??.1,e.alphaDiscardMode=H[h.alphaMode],e.isIntegratedMesh=!0,e.polygonOffsetEnabled=!1,e.hasOccludees=!1,e.ellipsoidMode=(0,re.V)(this.view.spatialReference)})),o.components.push($),o.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage($)}if(await Promise.all(r),s.forEach((e=>{o.textures.push(e)})),!this._memCache)throw new Error("no memCache");return this._memCache.put(`${o.handle}`,o,o.totalMemory()),{memUsageBytes:o.totalMemory()}}freeRenderable(e){const t=this._lyrHandleToObjects.get(e);t&&(this.freeObject(t),this._lyrHandleToObjects.delete(e))}freeObject(e){this._memCache&&this._memCache.pop(`${e.handle}`),e.components.forEach((t=>{e.textures.forEach((e=>{this._stage.remove(e)})),this._collection.destroyObject(t),this._initialCullFace.delete(t)}))}setRenderableVisibility(e,t,i){if(this._memCache){for(let r=0;r<i;++r){const i=e[r],s=t[r];if(!s)continue;const n=this._lyrHandleToObjects.get(i);n&&(this._visibleGeometryChanged(),n.isVisible=s,n.components.forEach((e=>{this._collection.setObjectVisibility(e,s),this._elevationProvider.objectChanged(this._collection.getComponentObb(e))})),this._memCache.pop(`${i}`))}for(let r=0;r<i;++r){const i=e[r],s=t[r];if(s)continue;const n=this._lyrHandleToObjects.get(i);n&&(this._visibleGeometryChanged(),n.isVisible=s,n.components.forEach((e=>{this._collection.setObjectVisibility(e,s),this._elevationProvider.objectChanged(this._collection.getComponentObb(e))})),this._memCache.put(`${i}`,n,n.totalMemory()))}}}_getTexture(e,t,i){let r=null;if(e&&t.desc?.images&&t.data?.buffer){const s=t.desc.images[e?.imageId];if(r=i.get(s),!r&&s){const n=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,o=n>1,a=V[e.wrapMode??M.Nt.None];let l=s.alpha?4:3;const c=new Uint8Array(t.data.buffer,s.data.byteOffset,s.data.byteCount);let d=null,u=null,h=null;switch(s.format){case M.h7.Raw:s.pixelFormat===M.CP.R8?(d=c.buffer,l=1,u=""):s.pixelFormat===M.CP.Rgb8?(d=c.buffer,l=3,u=""):s.pixelFormat===M.CP.Rgba8&&(d=c.buffer,l=4,u="");break;case M.h7.Dxt1:d=c.buffer,l=3,u=O.JS.DDS_ENCODING;break;case M.h7.Dxt5:d=c.buffer,l=4,u=O.JS.DDS_ENCODING;break;case M.h7.Png:u="image/png",h=document.createElement("img");break;case M.h7.Jpeg:u="image/jpeg",h=document.createElement("img");break;case M.h7.Etc2:u="image/ktx",h=document.createElement("img");break;case M.h7.Astc:this._dbg(q.Error,"Astc texture not supported");break;case M.h7.Pvrtc:this._dbg(q.Error,"Pvrtc texture not supported")}if(h&&u){const e=new Blob([c],{type:u});h.src=URL.createObjectURL(e),d=h}d&&null!=u&&(r=new oe.g(d,{mipmap:o,maxAnisotropy:n,encoding:u,wrap:a,components:l,noUnpackFlip:!0,width:s.mip0Width,height:s.mip0Height}),this._stage.add(r),i.set(s,r))}}return r?new te.Y(this.view._stage.renderView.textures,r.id):null}getBufferViews(e,t,i,r){let s,n,o,a,l,c,d,u=null;for(let d=0;d<e.atrbs.length;d++){const h=e.atrbs[d],p=h.view,m=void 0,f=p.byteOffset+p.byteCount,g=p.byteCount/z[p.type],b=[...Array(g).keys()].map((e=>e));try{switch(h.sem){case M.eN.Position:3!==p.ncomp||p.type!==M.LU.F32?this._dbg(q.Error,"[Unsupported Feature] Unsupported view for Position ("+p+")"):(s=new C.xs(t,p.byteOffset,m,f),n=new se.n(s.typedBuffer,b,3));break;case M.eN.Normal:if(3!==p.ncomp||p.type!==M.LU.F32)this._dbg(q.Error,"[Unsupported Feature] Unsupported view for Normal ("+p+")");else if(r){const e=new C.xs(t,p.byteOffset,m,f),r=(0,ne._l)(e.typedBuffer,i);l=new C.Qt(r),c=new se.n(l.typedBuffer,b,2)}break;case M.eN.TexCoord:2!==p.ncomp||p.type!==M.LU.F32?this._dbg(q.Error,"[Unsupported Feature] Unsupported view for Texcoord ("+p+")"):void 0===a&&(a=new se.n(new C.gH(t,p.byteOffset,m,f).typedBuffer,b,2));break;case M.eN.Color:4===p.ncomp?(p.type===M.LU.F32&&(u=new C.Eq(t,p.byteOffset,m,f)),p.type===M.LU.U8&&(u=new C.XP(t,p.byteOffset,m,f)),p.type===M.LU.U16&&(u=new C.Uz(t,p.byteOffset,m,f))):3===p.ncomp&&(p.type===M.LU.F32&&(u=new C.xs(t,p.byteOffset,m,f)),p.type===M.LU.U8&&(u=new C.eI(t,p.byteOffset,m,f)),p.type===M.LU.U16&&(u=new C.nS(t,p.byteOffset,m,f))),null==u?this._dbg(q.VerboseAPI,"[Unsupported Feature] Unsupported view for Color ("+p+")"):o=new se.n(u.typedBuffer,b,p.ncomp);break;case M.eN.FeatureIndex:break;default:this._dbg(q.VerboseAPI,"[Unsupported Feature] Unsupported semantic ("+h.sem+"). Skipping vertex attribute.")}}catch(e){this._dbg(q.VerboseAPI,"Error Creating buffer ("+e+"). Skipping vertex attribute.")}}if(e.index){const i=e.index.view,r=void 0,s=i.byteOffset+i.byteCount;switch(e.index.view.type){case M.LU.U16:d=new C.h(t,i.byteOffset,r,s);break;case M.LU.U32:d=new C.P(t,i.byteOffset,r,s);break;case M.LU.U8:default:this._dbg(q.Error,"[Unsupported Feature] index type not supported ("+i.type+").")}}if(null==d&&null!=s){const e=s.count;if(e<65535){const t=new Uint16Array(e);d=new C.h(t)}else{const t=new Uint32Array(e);d=new C.P(t)}for(let t=0;t<e;t++)d.set(t,t)}return{positionView:s,positionAttr:n,colorAttr:o,texCoord0Attr:a,indicesView:d,normalsView:l,normalsAttr:c}}_onRemoveFromCache(e){const t=(0,A.pw)(this.view);t&&t.onRenderableEvicted(this,e.handle,e.totalMemory()),this.freeRenderable(e.handle)}_dbg(e,t){this._dbgFlags.has(e)&&(e===q.Error?o.A.getLogger(this).error(t):o.A.getLogger(this).warn(t))}};(0,r._)([(0,d.MZ)()],pe.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),(0,r._)([(0,d.MZ)()],pe.prototype,"layer",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],pe.prototype,"visibleAtCurrentScale",null),(0,r._)([(0,d.MZ)()],pe.prototype,"elevationOffset",null),pe=(0,r._)([(0,u.$)("esri.views.3d.layers.IntegratedMesh3DTilesLayerView3D")],pe);const me=pe},93766:(e,t,i)=>{i.d(t,{w:()=>d});var r=i(82392),s=i(70214),n=i(37623),o=i(61985),a=i(81482),l=(i(6273),i(80861),i(67498),i(26325)),c=i(4197);const d=e=>{let t=class extends e{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(){super.postscript(),(0,c.jI)(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}async _validateHeightModelInfo(){const e=new AbortController,t=e.signal;this.addHandles((0,s.hA)((()=>e.abort()))),await(0,o.C_)((()=>this.view.defaultsFromMap?.heightModelInfoReady),t),(0,n.Te)(t);const i=(0,c.Hu)(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(i)throw i}};return(0,r._)([(0,a.MZ)()],t.prototype,"view",void 0),(0,r._)([(0,a.MZ)()],t.prototype,"slicePlaneEnabled",void 0),t=(0,r._)([(0,l.$)("esri.views.3d.layers.LayerView3D")],t),t}},94282:(e,t,i)=>{i.d(t,{e:()=>v});var r=i(82392),s=i(73783),n=i(57888),o=i(80861),a=i(81482),l=(i(6273),i(67498),i(26325)),c=i(25336),d=i(26110),u=i(80347),h=i(19913),p=i(29918),m=i(2532),f=i(69891),g=i(21016),b=i(81678),y=i(57809),_=i(30165);let v=class extends(n.A.EventedMixin(s.A)){constructor(e){super(e),this._tmpEvent=new b.L,this._renderCoordsHelper=e.view.renderCoordsHelper,this._renderSR=this._renderCoordsHelper.spatialReference,this._layerElevationSource=e.layerElevationSource}initialize(){this._intersector=(0,y.hz)(this.view.state.viewingMode),this._intersector.options.store=_.oH.MIN,this._intersector.options.normalRequired=!1,this._tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"}get spatialReference(){return this.view?.elevationProvider?.spatialReference}getElevation(e,t,i,r){const s=this._renderCoordsHelper,n=(0,u.s)(x,e,t,i);if(!s.toRenderCoords(n,r,n))return o.A.getLogger(this).error("could not project point to compute elevation"),null;const{layerElevationSource:a,_intersector:l,intersectionHandler:c}=this,d=a.fullExtent,h=null!=d&&Number.isFinite(d.xmin)&&Number.isFinite(d.xmax)&&Number.isFinite(d.ymin)&&Number.isFinite(d.ymax)&&Number.isFinite(d.zmin)&&Number.isFinite(d.zmax)?new g.H(d.zmin,d.zmax):a.elevationRange;if(null==h)return null;const p=a.elevationOffset,m=h.elevationRangeMin+p,f=h.elevationRangeMax+p,b=s.setAltitude(C,f,n),y=s.setAltitude(M,m,n);return l.reset(b,y,null),c.intersect(l,null,b,y,null,!0),l.results.min.getIntersectionPoint(n)?s.getAltitude(n):null}getSphereElevationBounds(e,t){return(0,p.z)(e,t,E,this._renderSR),this._layerElevationSource.getElevationRange(E)}getRootElevationBounds(){const e=this.layerElevationSource.fullExtent;return e?.hasZ?new g.H(e.zmin,e.zmax):null}objectsChanged(e){this.spatialReference&&(this._computeLayerExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}objectChanged(e){this.spatialReference&&(this._computeObjectExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}_computeObjectExtent(e,t){(0,m.Ie)(t),this._expandExtent(e,t)}_computeLayerExtent(e,t){(0,m.Ie)(t);for(const i of e)this._expandExtent(i,t)}_expandExtent(e,t){const i=this.spatialReference;if(null==i)return;if(null==e)return;(0,c.I0)(w,e.quaternion),w[12]=e.center[0],w[13]=e.center[1],w[14]=e.center[2];const r=e.halfSize;for(let e=0;e<8;++e)x[0]=1&e?r[0]:-r[0],x[1]=2&e?r[1]:-r[1],x[2]=4&e?r[2]:-r[2],(0,u.h)(x,x,w),this._renderCoordsHelper.fromRenderCoords(x,x,i),(0,m.fT)(t,x,t)}};(0,r._)([(0,a.MZ)({constructOnly:!0})],v.prototype,"layerElevationSource",void 0),(0,r._)([(0,a.MZ)({constructOnly:!0})],v.prototype,"intersectionHandler",void 0),(0,r._)([(0,a.MZ)({constructOnly:!0})],v.prototype,"view",void 0),(0,r._)([(0,a.MZ)()],v.prototype,"spatialReference",null),v=(0,r._)([(0,l.$)("esri.views.3d.layers.i3s.LayerElevationProvider")],v);const w=(0,d.vt)(),E=(0,f.f)(0,0,0,0),x=(0,h.vt)(),C=(0,h.vt)(),M=(0,h.vt)()},78988:(e,t,i)=>{i.d(t,{i:()=>r});class r{constructor(e,t,i,r){this.toMapSpace=e,this.transform=t,this.obb=i,this.geometry=r}}},22315:(e,t,i)=>{i.d(t,{d:()=>r});class r{constructor(e,t){this.position=e,this.rotationScale=t,this.origin=void 0}}},16776:(e,t,i)=>{i.d(t,{Y:()=>n});var r=i(57725),s=i(37623);class n{constructor(e,t){this._textures=e,this.loadPromise=null,this._disposed=!1;const i=this._textures.acquire(t);(0,s.$X)(i)?(i.then((e=>{this._disposed?(0,r.Gz)(e):this._textureRef=e})),this.loadPromise=i):this._textureRef=i}dispose(){this._textureRef=(0,r.Gz)(this._textureRef),this._disposed=!0}get glTexture(){return null!=this._textureRef?this._textureRef.glTexture:null}}}}]);